<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>REX A350 ‚Äì Check A (tout-en-un)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#60a5fa;
  --ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--line:#27324a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);background:var(--bg);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto,Ubuntu;
}
h1{font-size:22px;margin:0 0 10px}
h2{font-size:18px;margin:0 0 8px}
.wrap{display:grid;grid-template-columns:240px 1fr;gap:18px;min-height:100vh}
aside{background:var(--panel);padding:18px 12px;border-right:1px solid var(--line)}
.main{padding:18px}
.menu h3{font-size:13px;letter-spacing:.08em;color:#93a3b8;margin:0 0 10px;text-transform:uppercase}
.menu button{
  display:flex;align-items:center;gap:8px;width:100%;padding:10px 12px;border:1px solid var(--line);
  border-radius:10px;background:var(--muted);color:var(--text);cursor:pointer;margin-bottom:8px
}
.menu button.active{outline:2px solid var(--accent);background:#0b1220}
.topbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:12px}
.btn{padding:8px 12px;border:1px solid var(--line);background:var(--muted);color:var(--text);border-radius:10px;cursor:pointer}
.btn.primary{background:#0b1220;border-color:#1e2a44}
.btn.ok{background:#0d2517;border-color:#154a2c;color:#bbf7d0}
.btn.bad{background:#2a0e12;border-color:#5b111c;color:#fecaca}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:repeat(3,1fr)}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
label{display:block;font-size:12px;opacity:.9;margin-bottom:6px}
input,select,textarea{
  width:100%;background:var(--muted);border:1px solid var(--line);color:var(--text);
  border-radius:10px;padding:10px;outline:none
}
input[type="number"]{text-align:right}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--line);text-align:right}
th:first-child,td:first-child{text-align:left}
thead th{background:#0b1220}
.tag{font-size:12px;opacity:.8}
.kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.kpi .pill{padding:8px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--line)}
.small{font-size:12px;opacity:.8}
.muted{opacity:.7}
.right{margin-left:auto}
hr{border:none;border-top:1px solid var(--line);margin:10px 0}
.hidden{display:none}
</style>
</head>
<body>
<div class="wrap">

  <!-- MENU -->
  <aside>
    <div class="menu">
      <h3>REX A350</h3>
      <button class="active" data-tab="visit">üõ†Ô∏è Visite</button>
      <button data-tab="problems">üìö Probl√®mes</button>
      <button data-tab="perf">üìä Performance</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">

    <div class="topbar">
      <button id="exportJson" class="btn">Exporter JSON</button>
      <input id="importJsonFile" type="file" accept="application/json" class="hidden">
      <button id="importJsonBtn" class="btn">Importer JSON</button>
    </div>

    <!-- VISIT -->
    <section id="tab-visit">
      <h1>Visite (Check A)</h1>
      <div class="grid cols-2">
        <div class="card">
          <h2>Infos visite</h2>
          <div class="grid cols-2">
            <div>
              <label>Immatriculation</label>
              <input list="immatList" id="v-immatric" placeholder="ex. F-HUVK">
              <datalist id="immatList"></datalist>
            </div>
            <div class="row">
              <div style="flex:1">
                <label>Ajouter une immat</label>
                <input id="v-immat-add" placeholder="ex. F-HUVP">
              </div>
              <button id="btnAddImmat" class="btn">+ Ajouter</button>
            </div>
            <div>
              <label>Type de check</label>
              <select id="v-checkType">
                <option value="A1">A1</option><option value="A2">A2</option>
                <option value="A3">A3</option><option value="A4">A4</option>
                <option value="A5">A5</option><option value="A6">A6</option>
                <option value="A7">A7</option><option value="A8">A8</option>
                <option value="A9">A9</option><option value="A10">A10</option>
                <option value="A11">A11</option><option value="A12">A12</option>
              </select>
            </div>
            <div class="row">
              <div style="flex:1">
                <label>Importer XML (d√©mo)</label>
                <input id="xmlFile" type="file" accept=".xml">
              </div>
              <button id="btnImportXml" class="btn">Importer XML</button>
            </div>
          </div>
          <hr>
          <div class="grid cols-2">
            <div>
              <label>Arriv√©e pr√©vue</label>
              <input id="v-arr-prev" type="datetime-local">
            </div>
            <div>
              <label>Arriv√©e r√©elle</label>
              <input id="v-arr-real" type="datetime-local">
            </div>
            <div>
              <label>D√©part pr√©vu</label>
              <input id="v-dep-prev" type="datetime-local">
            </div>
            <div>
              <label>D√©part r√©el</label>
              <input id="v-dep-real" type="datetime-local">
            </div>
          </div>
          <hr>
          <div class="grid cols-2">
            <div>
              <label>Nb lignes d√©sassign√©es</label>
              <input id="v-unassigned" type="number" min="0" value="0">
            </div>
            <div>
              <label>Raison(s) d√©sassignation</label>
              <input id="v-unassigned-reason" placeholder="ex. pi√®ce manquante, outillage‚Ä¶">
            </div>
            <div>
              <label>Nb lignes fin de chantier</label>
              <input id="v-endlines" type="number" min="0" value="0">
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Effectifs par vacation</h2>
          <div class="row">
            <button id="btnAddVac" class="btn">+ Ajouter une vacation</button>
          </div>
          <div style="overflow:auto;margin-top:8px">
            <table id="vacTable">
              <thead>
                <tr>
                  <th>Vacation</th>
                  <th>CME dem.</th>
                  <th>EIR dem.</th>
                  <th>Leader dem.</th>
                  <th>Eff. demand√© total</th>
                  <th>CME r√©el</th>
                  <th>EIR r√©el</th>
                  <th>Leader r√©el</th>
                  <th>Eff. r√©el total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="vacTbody"></tbody>
              <tfoot>
                <tr>
                  <th>Total g√©n√©ral</th>
                  <th id="totCmeDem">0</th>
                  <th id="totEirDem">0</th>
                  <th id="totLeadDem">0</th>
                  <th id="totDem">0</th>
                  <th id="totCmeReal">0</th>
                  <th id="totEirReal">0</th>
                  <th id="totLeadReal">0</th>
                  <th id="totReal">0</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="kpi">
            <div class="pill">Œî Effectif total : <b id="deltaEff">0</b></div>
            <div class="pill">Œî HMO : <b id="deltaHmo">0h</b> <span class="small muted">(base 8h/vac)</span></div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btnSaveVisit" class="btn ok">üíæ Enregistrer</button>
            <button id="btnClearVisit" class="btn bad">üßπ Effacer le formulaire</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PROBLEMS -->
    <section id="tab-problems" class="hidden">
      <h1>Probl√®mes (REX)</h1>

      <div class="card">
        <h2>Ajouter un probl√®me</h2>
        <div class="grid cols-3">
          <div>
            <label>Titre</label>
            <input id="p-title" required>
          </div>
          <div>
            <label>Cat√©gorie</label>
            <select id="p-cat">
              <option>Cabine</option><option>Sous-traitance</option>
              <option>Query/Pr√©paq</option><option>Pi√®ces/Log</option>
              <option>Effets/Planif</option><option>Documentation</option>
              <option>Autre</option>
            </select>
          </div>
          <div>
            <label>Impact (heures)</label>
            <input id="p-impact" type="number" step="0.5" min="0" value="0">
          </div>
          <div>
            <label>Acteur/Responsable</label>
            <input id="p-actor" placeholder="ex. Cabine, STI, Query, Planif‚Ä¶">
          </div>
          <div>
            <label>R√©current</label>
            <input id="p-recurring" type="checkbox">
          </div>
          <div class="cols-3" style="grid-column:1/-1">
            <label>Description</label>
            <textarea id="p-desc" rows="3" placeholder="Contexte, sympt√¥mes, documents concern√©s‚Ä¶"></textarea>
          </div>
        </div>
        <div class="row">
          <button id="btnAddProblem" class="btn ok">+ Enregistrer le probl√®me</button>
        </div>
      </div>

      <div class="card">
        <h2>Probl√®mes enregistr√©s</h2>
        <div class="row">
          <div>
            <label>P√©riode - d√©but</label>
            <input id="fStart" type="date">
          </div>
          <div>
            <label>P√©riode - fin</label>
            <input id="fEnd" type="date">
          </div>
          <div>
            <label>Immat</label>
            <input id="fImmat" placeholder="ex. F-HUVK">
          </div>
          <div>
            <label>Type de check</label>
            <select id="fCheck">
              <option value="">Tous</option>
              <option>A1</option><option>A2</option><option>A3</option><option>A4</option>
              <option>A5</option><option>A6</option><option>A7</option><option>A8</option>
              <option>A9</option><option>A10</option><option>A11</option><option>A12</option>
            </select>
          </div>
          <div>
            <label>Cat√©gorie</label>
            <select id="fCat">
              <option value="">Toutes</option>
              <option>Cabine</option><option>Sous-traitance</option>
              <option>Query/Pr√©paq</option><option>Pi√®ces/Log</option>
              <option>Effets/Planif</option><option>Documentation</option><option>Autre</option>
            </select>
          </div>
          <button id="btnFilterProblems" class="btn">Filtrer</button>
          <div class="right small muted">Les probl√®mes sont associ√©s √† la derni√®re visite enregistr√©e √† ce moment-l√†.</div>
        </div>

        <div style="overflow:auto;margin-top:8px">
          <table id="problemsTable">
            <thead>
              <tr>
                <th>#</th><th>Probl√®me</th><th>Cat.</th><th>Fr√©quence</th><th>Impact(h)</th><th>Derni√®re utilisation</th>
              </tr>
            </thead>
            <tbody id="problemsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PERFORMANCE -->
    <section id="tab-perf" class="hidden">
      <h1>Performance REX</h1>

      <div class="card">
        <div class="row">
          <div>
            <label>P√©riode - d√©but</label>
            <input id="pfStart" type="date">
          </div>
          <div>
            <label>P√©riode - fin</label>
            <input id="pfEnd" type="date">
          </div>
          <div>
            <label>Immat</label>
            <input id="pfImmat" placeholder="ex. F-HUVK">
          </div>
          <div>
            <label>Type de check</label>
            <select id="pfCheck">
              <option value="">Tous</option>
              <option>A1</option><option>A2</option><option>A3</option><option>A4</option>
              <option>A5</option><option>A6</option><option>A7</option><option>A8</option>
              <option>A9</option><option>A10</option><option>A11</option><option>A12</option>
            </select>
          </div>
          <button id="btnPerfRefresh" class="btn">Actualiser</button>
        </div>

        <div class="kpi">
          <div class="pill">Respect planning : <b id="kpiRespect">0%</b></div>
          <div class="pill">Œî HMO moyen : <b id="kpiHmo">0h (0%)</b></div>
          <div class="pill">Œî Effectif moyen : <b id="kpiEff">0%</b></div>
        </div>
      </div>

      <div class="grid cols-2">
        <div class="card">
          <h2>Pareto par cat√©gorie</h2>
          <table id="paretoTable">
            <thead>
              <tr><th>Cat√©gorie</th><th>Comptes</th><th>%</th><th>Cumul %</th></tr>
            </thead>
            <tbody id="paretoTbody"></tbody>
          </table>
        </div>
        <div class="card">
          <h2>R√©partition (camembert)</h2>
          <canvas id="pieCanvas" height="180"></canvas>
        </div>
      </div>
    </section>

  </div>
</div>

<script>
/* ---------------------------- stockage & helpers --------------------------- */
const LS_KEY = "rexA350_checkA_v1";
const state = load() || { immat:[], visits:[], problems:[] };

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function load(){ try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch(e){ return null; } }

function el(q,root=document){ return root.querySelector(q); }
function els(q,root=document){ return [...root.querySelectorAll(q)]; }
function fmt(n){ return Number(n||0); }
function sum(arr){ return arr.reduce((a,b)=>a+fmt(b),0); }
function toISO(d){ return d? new Date(d).toISOString(): null; }
function inPeriod(d, start, end){
  if(!d) return false; const t = new Date(d).getTime();
  if(start && t < new Date(start).getTime()) return false;
  if(end   && t > new Date(end).getTime()+86400000-1) return false;
  return true;
}

/* ------------------------------- menu onglets ------------------------------ */
const tabs = { visit:'tab-visit', problems:'tab-problems', perf:'tab-perf' };
els('aside .menu button').forEach(b=>{
  b.addEventListener('click', ()=>{
    els('aside .menu button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const tab = b.dataset.tab;
    Object.values(tabs).forEach(id=> el('#'+id).classList.add('hidden'));
    el('#'+tabs[tab]).classList.remove('hidden');
    if(tab==='perf') renderPerformance();
    if(tab==='problems') renderProblems();
  });
});

/* ------------------------ liste immats (ajout/m√©mo) ------------------------ */
function refreshImmatList(){
  const dl = el('#immatList'); dl.innerHTML='';
  state.immat.forEach(i=>{
    const o=document.createElement('option'); o.value=i; dl.appendChild(o);
  });
}
refreshImmatList();

el('#btnAddImmat').addEventListener('click', ()=>{
  const v=el('#v-immat-add').value.trim().toUpperCase();
  if(!v) return;
  if(!state.immat.includes(v)) state.immat.push(v);
  el('#v-immat-add').value='';
  refreshImmatList(); save();
});

/* ----------------------- vacations table (add/remove) ---------------------- */
const vacTbody = el('#vacTbody');
const DEFAULT_VACS = ['Matin','Soir','Nuit'];

function buildVacRow(name=''){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="vacName" value="${name}" placeholder="Nom"></td>
    <td><input class="cmeDem" type="number" min="0" value="0"></td>
    <td><input class="eirDem" type="number" min="0" value="0"></td>
    <td><input class="leadDem" type="number" min="0" value="0"></td>
    <td class="demTot">0</td>
    <td><input class="cmeReal" type="number" min="0" value="0"></td>
    <td><input class="eirReal" type="number" min="0" value="0"></td>
    <td><input class="leadReal" type="number" min="0" value="0"></td>
    <td class="realTot">0</td>
    <td><button class="btn bad btnDel">Retirer</button></td>`;
  vacTbody.appendChild(tr);
  els('input',tr).forEach(i=>i.addEventListener('input', recalcTotals));
  el('.btnDel',tr).addEventListener('click',()=>{ tr.remove(); recalcTotals(); });
}

function ensureDefaultVacs(){
  if(vacTbody.children.length) return;
  DEFAULT_VACS.forEach(v=>buildVacRow(v));
}
ensureDefaultVacs();

el('#btnAddVac').addEventListener('click', ()=> buildVacRow(''));

function recalcTotals(){
  let tCmeD=0,tEirD=0,tLeadD=0,tDem=0,tCmeR=0,tEirR=0,tLeadR=0,tReal=0;
  els('#vacTbody tr').forEach(tr=>{
    const cmeD=fmt(el('.cmeDem',tr).value),
          eirD=fmt(el('.eirDem',tr).value),
          leaD=fmt(el('.leadDem',tr).value),
          cmeR=fmt(el('.cmeReal',tr).value),
          eirR=fmt(el('.eirReal',tr).value),
          leaR=fmt(el('.leadReal',tr).value);
    const demTot=cmeD+eirD+leaD;
    const realTot=cmeR+eirR+leaR;
    el('.demTot',tr).textContent=demTot;
    el('.realTot',tr).textContent=realTot;
    tCmeD+=cmeD;tEirD+=eirD;tLeadD+=leaD;tDem+=demTot;
    tCmeR+=cmeR;tEirR+=eirR;tLeadR+=leaR;tReal+=realTot;
  });
  el('#totCmeDem').textContent=tCmeD;
  el('#totEirDem').textContent=tEirD;
  el('#totLeadDem').textContent=tLeadD;
  el('#totDem').textContent=tDem;
  el('#totCmeReal').textContent=tCmeR;
  el('#totEirReal').textContent=tEirR;
  el('#totLeadReal').textContent=tLeadR;
  el('#totReal').textContent=tReal;

  const deltaEff=tReal - tDem;
  el('#deltaEff').textContent=deltaEff;

  const HMO_PER_VAC=8; // <= adapter si besoin
  const hmoDem = tDem * HMO_PER_VAC;
  const hmoReal = tReal * HMO_PER_VAC;
  const delta = hmoReal - hmoDem;
  el('#deltaHmo').textContent = `${delta}h`;
}
recalcTotals();

/* --------------------------- enregistrer la visite ------------------------- */
el('#btnSaveVisit').addEventListener('click', ()=>{
  const v={
    immat: el('#v-immatric').value.trim().toUpperCase(),
    check: el('#v-checkType').value,
    arrPrev: toISO(el('#v-arr-prev').value),
    arrReal: toISO(el('#v-arr-real').value),
    depPrev: toISO(el('#v-dep-prev').value),
    depReal: toISO(el('#v-dep-real').value),
    unassigned: fmt(el('#v-unassigned').value),
    unassignedReason: el('#v-unassigned-reason').value.trim(),
    endLines: fmt(el('#v-endlines').value),
    vacs: els('#vacTbody tr').map(tr=>({
      name: el('.vacName',tr).value,
      cmeDem: fmt(el('.cmeDem',tr).value),
      eirDem: fmt(el('.eirDem',tr).value),
      leadDem: fmt(el('.leadDem',tr).value),
      cmeReal: fmt(el('.cmeReal',tr).value),
      eirReal: fmt(el('.eirReal',tr).value),
      leadReal: fmt(el('.leadReal',tr).value),
    })),
    createdAt: new Date().toISOString()
  };
  if(v.immat && !state.immat.includes(v.immat)){ state.immat.push(v.immat); refreshImmatList(); }
  state.visits.push(v); save();
  alert('Visite enregistr√©e ‚úÖ');
});

/* ----------------------------- effacer formulaire -------------------------- */
el('#btnClearVisit').addEventListener('click', ()=>{
  ['#v-immatric','#v-immat-add','#v-arr-prev','#v-arr-real','#v-dep-prev','#v-dep-real','#v-unassigned-reason']
    .forEach(id=> el(id).value='');
  el('#v-checkType').value='A1';
  el('#v-unassigned').value=0;
  el('#v-endlines').value=0;
  vacTbody.innerHTML=''; ensureDefaultVacs(); recalcTotals();
});

/* ------------------------------ import/export ------------------------------ */
el('#exportJson').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rex-a350.json'; a.click();
});
el('#importJsonBtn').addEventListener('click', ()=> el('#importJsonFile').click() );
el('#importJsonFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=()=>{
    try{
      const data=JSON.parse(rd.result);
      if(data && data.visits && data.problems){ Object.assign(state,data); save(); alert('Import OK'); }
      else alert('JSON invalide');
    }catch(err){ alert('Erreur JSON'); }
  }; rd.readAsText(f);
});

/* -------------------------------- import XML ------------------------------- */
/* D√©monstration : r√©cup√®re arriv√©e/d√©part si tags <Arrival> / <Departure> ISO */
el('#btnImportXml').addEventListener('click', ()=>{
  const file=el('#xmlFile').files[0]; if(!file) return;
  const rd=new FileReader();
  rd.onload=()=>{
    try{
      const xml=new DOMParser().parseFromString(rd.result,'text/xml');
      const arr=xml.querySelector('Arrival, arrival, ARRIVAL'); 
      const dep=xml.querySelector('Departure, departure, DEPARTURE');
      if(arr){ const d=new Date(arr.textContent.trim()); if(!isNaN(d)) el('#v-arr-real').value = new Date(d - d.getTimezoneOffset()*60000).toISOString().slice(0,16); }
      if(dep){ const d=new Date(dep.textContent.trim()); if(!isNaN(d)) el('#v-dep-real').value = new Date(d - d.getTimezoneOffset()*60000).toISOString().slice(0,16); }
      alert('XML import√© (d√©mo) ‚úÖ');
    }catch(e){ alert('XML invalide'); }
  };
  rd.readAsText(file);
});

/* ----------------------------- probl√®mes (REX) ----------------------------- */
function renderProblems(){
  const tb=el('#problemsTbody'); tb.innerHTML='';
  let rows=state.problems.map((p,i)=>({i,...p}));
  // filtres
  const s=el('#fStart').value, e=el('#fEnd').value, imm=el('#fImmat').value.trim().toUpperCase(), chk=el('#fCheck').value, cat=el('#fCat').value;
  rows=rows.filter(r=>{
    const okP=inPeriod(r.ts, s||null, e||null);
    const okI= imm? (r.immat===imm): true;
    const okC= chk? (r.check===chk): true;
    const okCat=cat? (r.cat===cat): true;
    return okP && okI && okC && okCat;
  });
  rows.forEach((r,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${r.title}</td>
      <td>${r.cat}</td>
      <td>${r.recurring?'R√©c.':''}</td>
      <td>${r.impact||0}</td>
      <td>${new Date(r.ts).toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
}
el('#btnFilterProblems').addEventListener('click', renderProblems);

el('#btnAddProblem').addEventListener('click', ()=>{
  const title=el('#p-title').value.trim(); if(!title) return alert('Titre manquant');
  const p={
    title, cat:el('#p-cat').value, impact:fmt(el('#p-impact').value), actor:el('#p-actor').value.trim(),
    recurring:el('#p-recurring').checked, desc:el('#p-desc').value.trim(),
    // rattachement √† la derni√®re visite (pour filtres immat/check)
    immat: state.visits.slice(-1)[0]?.immat || '', check: state.visits.slice(-1)[0]?.check || '',
    ts: new Date().toISOString()
  };
  state.problems.push(p); save();
  el('#p-title').value=''; el('#p-impact').value=0; el('#p-actor').value=''; el('#p-recurring').checked=false; el('#p-desc').value='';
  renderProblems();
});

/* ------------------------------ performance ------------------------------- */
let pieChart=null;
function renderPerformance(){
  // filtrage visites
  const s=el('#pfStart').value, e=el('#pfEnd').value, imm=el('#pfImmat').value.trim().toUpperCase(), chk=el('#pfCheck').value;
  const visits=state.visits.filter(v=>{
    const d=v.createdAt || v.arrPrev || v.arrReal || v.depPrev || v.depReal; // proxy date
    return inPeriod(d, s||null, e||null) && (imm? v.immat===imm:true) && (chk? v.check===chk:true);
  });

  // KPI planning (depart r√©el ‚â§ pr√©vu)
  let ok=0, total=0;
  let effD=0,effR=0,hmoD=0,hmoR=0;
  visits.forEach(v=>{
    total++;
    if(v.depPrev && v.depReal && new Date(v.depReal) <= new Date(v.depPrev)) ok++;
    const tD = v.vacs.reduce((a,x)=>a + x.cmeDem + x.eirDem + x.leadDem,0);
    const tR = v.vacs.reduce((a,x)=>a + x.cmeReal + x.eirReal + x.leadReal,0);
    effD += tD; effR += tR;
    hmoD += tD*8; hmoR += tR*8;
  });
  const kRespect = total? Math.round(ok*100/total):0;
  const dH = hmoR-hmoD, dHpc = hmoD? Math.round(dH*100/hmoD):0;
  const dEpc = effD? Math.round((effR-effD)*100/effD):0;
  el('#kpiRespect').textContent = kRespect+'%';
  el('#kpiHmo').textContent = `${dH}h (${dHpc}%)`;
  el('#kpiEff').textContent = `${dEpc}%`;

  // Pareto & camembert depuis probl√®mes filtr√©s
  let probs=state.problems.slice();
  probs=probs.filter(p=>{
    return inPeriod(p.ts, s||null, e||null) && (imm? p.immat===imm:true) && (chk? p.check===chk:true);
  });
  const byCat={}; probs.forEach(p=> byCat[p.cat]=(byCat[p.cat]||0)+1 );
  const entries=Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  const totalP=sum(entries.map(x=>x[1]))||1;

  const tb=el('#paretoTbody'); tb.innerHTML='';
  let cumul=0;
  entries.forEach(([cat,c])=>{
    const pc=Math.round(c*100/totalP); cumul+=pc;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${cat}</td><td>${c}</td><td>${pc}%</td><td>${Math.min(cumul,100)}%</td>`;
    tb.appendChild(tr);
  });

  const ctx=el('#pieCanvas').getContext('2d');
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(ctx,{
    type:'doughnut',
    data:{ labels:entries.map(e=>e[0]),
      datasets:[{ data:entries.map(e=>e[1]) }] },
    options:{ plugins:{legend:{position:'bottom'}}, maintainAspectRatio:false }
  });
}
el('#btnPerfRefresh').addEventListener('click', renderPerformance);

/* -------------------------- init sur onglet visite ------------------------- */
renderProblems(); // pr√©remplir tableau (vide)
</script>
</body>
</html>
