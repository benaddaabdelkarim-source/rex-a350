<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>REX Planning A350 ‚Äì Check A</title>
<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--sub:#cbd5e1;
  --accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--line:#1e293b
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Ubuntu}
header{display:flex;gap:12px;align-items:center;padding:14px 18px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(15,23,42,.9);backdrop-filter:saturate(140%) blur(8px);z-index:2}
h1{font-size:16px;margin:0;font-weight:700}
.small{font-size:12px;color:var(--sub)}
.tag{padding:2px 8px;border-radius:999px;background:var(--muted);color:#dbeafe;font-size:12px}
.right{margin-left:auto}
.wrap{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 56px)}
nav{border-right:1px solid var(--line);background:#0b1222;padding:10px}
nav .btn{display:block;width:100%;text-align:left;margin:6px 0;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f1a30;color:#dbeafe;cursor:pointer}
nav .btn.active{outline:2px solid var(--accent)}
main{padding:14px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,textarea{width:100%;background:#0b1222;border:1px solid #223050;color:var(--text);border-radius:10px;padding:10px}
textarea{min-height:76px}
label{font-size:12px;color:#93b3d9}
.btn2{border:1px solid #223050;background:#0b1222;border-radius:10px;padding:8px 10px;color:var(--text);cursor:pointer}
.btn2.primary{background:#11345a;border-color:#1d4ed8}
.btn2.good{background:#0d2d1b;border-color:#16a34a}
.btn2.bad{background:#3a0a0a;border-color:#ef4444}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
.muted{color:#93b3d9}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0c1528;border:1px solid #273146;border-radius:6px;padding:1px 6px}
.help{opacity:.8}
</style>
</head>
<body>
<header>
  <h1>REX Planning A350 ‚Äì Check A</h1>
  <span class="tag">Standalone localStorage</span>
  <span class="right"></span>
  <button class="btn2" id="exportBtn">Exporter JSON</button>
  <label for="importFile" class="btn2">Importer JSON</label>
  <input id="importFile" type="file" accept="application/json" style="display:none"/>
</header>

<div class="wrap">
  <nav>
    <button class="btn active" data-tab="problems">üìö Biblioth√®que Probl√®mes</button>
    <button class="btn" data-tab="visit">‚úÖ Checklist Visite</button>
    <button class="btn" data-tab="analytics">üìä REX / Analyse</button>
    <button class="btn" data-tab="settings">‚öôÔ∏è Param√®tres flotte</button>
    <div class="panel" style="margin-top:10px">
      <div class="small">Raccourcis : <span class="kbd">/</span> chercher ‚Ä¢ <span class="kbd">N</span> nouveau probl√®me ‚Ä¢ <span class="kbd">V</span> nouvelle visite</div>
    </div>
  </nav>

  <main>
    <!-- PROBLEMS -->
    <section id="tab-problems" class="tab">
      <div class="panel">
        <div class="grid cols-3">
          <div>
            <label>Recherche</label>
            <input id="qProblem" placeholder="Titre, cat√©gorie, acteur, description‚Ä¶"/>
          </div>
          <div>
            <label>Cat√©gorie</label>
            <select id="filterCat">
              <option value="">(toutes)</option>
              <option>Cabine</option><option>Sous-traitance</option><option>Query/Pr√©pa</option>
              <option>Pi√®ces/Log</option><option>Effectifs/Planif</option><option>Documentation</option><option>Autre</option>
            </select>
          </div>
          <div>
            <label>Impact min (heures)</label>
            <input type="number" id="filterImpact" min="0" step="0.5" placeholder="0"/>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <label class="small row" style="gap:6px"><input type="checkbox" id="filterRecurring"/> R√©current seulement</label>
          <span class="right"></span>
          <button class="btn2" id="clearSearch">Effacer</button>
          <button class="btn2 primary" id="addProblemBtn">+ Nouveau probl√®me</button>
        </div>
      </div>
      <div class="panel">
        <div id="problemsList"></div>
      </div>

      <dialog id="problemDlg">
        <form method="dialog" style="min-width:640px">
          <div class="panel">
            <h3 style="margin:0 0 8px 0">Probl√®me</h3>
            <div class="grid cols-2">
              <div><label>Titre</label><input id="p_title" required/></div>
              <div><label>Cat√©gorie</label>
                <select id="p_cat"><option>Cabine</option><option>Sous-traitance</option><option>Query/Pr√©pa</option><option>Pi√®ces/Log</option><option>Effectifs/Planif</option><option>Documentation</option><option>Autre</option></select>
              </div>
              <div><label>Impact estim√© (h)</label><input id="p_impact" type="number" min="0" step="0.5"/></div>
              <div><label>Acteur / Responsable</label><input id="p_actor" placeholder="Cabine, STT, Query, Planif‚Ä¶"/></div>
            </div>
            <div style="margin-top:8px"><label>Description</label><textarea id="p_desc" placeholder="Contexte, sympt√¥mes, doc‚Ä¶"></textarea></div>
            <div class="row" style="margin-top:8px">
              <label class="row small" style="gap:6px"><input type="checkbox" id="p_recurring"/> R√©current</label>
              <label class="row small" style="gap:6px"><input type="checkbox" id="p_checkable" checked/> Utilisable en checklist</label>
              <span class="right"></span><button class="btn2" value="cancel">Annuler</button><button class="btn2 primary" id="saveProblem" value="default">Enregistrer</button>
            </div>
          </div>
        </form>
      </dialog>
    </section>

    <!-- VISIT -->
    <section id="tab-visit" class="tab" hidden>
      <div class="panel">
        <div class="row">
          <button class="btn2 primary" id="newVisitBtn">+ Nouvelle visite</button>
          <select id="visitSelect"></select>
          <button class="btn2 bad" id="deleteVisitBtn">Supprimer visite</button>
          <span class="right small help">Cr√©er une checklist depuis les probl√®mes r√©currents (ou une s√©lection)</span>
        </div>
      </div>

      <div class="panel">
        <div class="grid cols-4">
          <div><label>Immatriculation (AF A350)</label><select id="v_reg"></select></div>
          <div><label>Type de Check</label>
            <select id="v_check"><option>A1</option><option>A2</option><option>A3</option><option>A4</option><option>A5</option><option>A6</option><option>A7</option><option>A8</option><option>A9</option><option>A10</option><option>A11</option><option>A12</option></select>
          </div>
          <div><label>Arriv√©e pr√©vue</label><input id="v_arrival" type="datetime-local"/></div>
          <div><label>D√©part pr√©vu</label><input id="v_departure" type="datetime-local"/></div>
        </div>

        <div class="grid cols-4" style="margin-top:10px">
          <div><label>HMO pr√©vue (h)</label><input id="v_hmo_plan" type="number" min="0" step="0.5"/></div>
          <div><label>HMO r√©elle (h)</label><input id="v_hmo_real" type="number" min="0" step="0.5"/></div>
          <div><label>Effectif demand√© (total)</label><input id="v_staff_plan" type="number" min="0" step="1"/></div>
          <div><label>Effectif r√©el (total)</label><input id="v_staff_real" type="number" min="0" step="1"/></div>
        </div>

        <div class="grid cols-4" style="margin-top:10px">
          <div><label>Poids CME (total)</label><input id="v_cme" type="number" min="0" step="1"/></div>
          <div><label>Poids EIR (total)</label><input id="v_eir" type="number" min="0" step="1"/></div>
          <div><label>Nb lignes fin de chantier</label><input id="v_eol_lines" type="number" min="0" step="1"/></div>
          <div><label>Extractions (nombre)</label><input id="v_extractions" type="number" min="0" step="1"/></div>
        </div>

        <div class="grid cols-1" style="margin-top:10px">
          <div><label>Raison(s) extraction</label><input id="v_extraction_reason" placeholder="pi√®ce, doc, STT, cabine‚Ä¶"/></div>
        </div>
      </div>

      <!-- VAC: Leader / EIR / CME -->
      <div class="panel">
        <div class="row"><strong>Comp√©tences par vac ‚Äî Leader / EIR / CME</strong></div>
        <div class="grid cols-3" style="margin-top:8px">
          <div>
            <label>Matin ‚Äî Leader</label><input id="v_m_lead" type="number" min="0" step="1" placeholder="0"/>
            <label style="margin-top:6px">Matin ‚Äî EIR</label><input id="v_m_eir" type="number" min="0" step="1" placeholder="0"/>
            <label style="margin-top:6px">Matin ‚Äî CME</label><input id="v_m_cme" type="number" min="0" step="1" placeholder="0"/>
          </div>
          <div>
            <label>Soir ‚Äî Leader</label><input id="v_s_lead" type="number" min="0" step="1" placeholder="0"/>
            <label style="margin-top:6px">Soir ‚Äî EIR</label><input id="v_s_eir" type="number" min="0" step="1" placeholder="0"/>
            <label style="margin-top:6px">Soir ‚Äî CME</label><input id="v_s_cme" type="number" min="0" step="1" placeholder="0"/>
          </div>
          <div>
            <label>Nuit ‚Äî Leader</label><input id="v_n_lead" type="number" min="0" step="1" placeholder="0"/>
            <label style="margin-top:6px">Nuit ‚Äî EIR</label><input id="v_n_eir" type="number" min="0" step="1" placeholder="0"/>
            <label style="margin-top:6px">Nuit ‚Äî CME</label><input id="v_n_cme" type="number" min="0" step="1" placeholder="0"/>
          </div>
        </div>
        <div class="grid cols-3" style="margin-top:10px">
          <div><label>Total Leader</label><input id="v_tot_lead" type="number" disabled/></div>
          <div><label>Total EIR</label><input id="v_tot_eir" type="number" disabled/></div>
          <div><label>Total CME</label><input id="v_tot_cme" type="number" disabled/></div>
        </div>
        <div class="small muted" style="margin-top:6px">Les totaux EIR/CME sont recopi√©s automatiquement dans l‚Äôent√™te (Poids EIR / Poids CME).</div>
      </div>

      <div class="panel">
        <div class="row">
          <button class="btn2" id="autoChecklistBtn">G√©n√©rer checklist (r√©currents + top)</button>
          <button class="btn2" id="addItemBtn">+ Ajouter un item</button>
          <span class="right"></span>
          <button class="btn2 good" id="markAllDoneBtn">Tout marquer fait</button>
        </div>
        <table class="table" id="visitTable">
          <thead><tr><th>‚úî</th><th>Probl√®me</th><th>Cat.</th><th>Impact(h)</th><th>Acteur</th><th>Notes</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="tab-analytics" class="tab" hidden>
      <div class="panel">
        <div class="grid cols-3">
          <div>
            <label>Mois (sur la base de l‚Äôarriv√©e pr√©vue)</label>
            <input id="flt_month" type="month"/>
          </div>
          <div>
            <label>Filtre √©cart HMO (r√©el ‚Äì pr√©vu) min (h)</label>
            <input id="flt_hmo" type="number" min="0" step="0.5" placeholder="0"/>
          </div>
          <div>
            <label>Filtre √©cart effectif (r√©el ‚Äì demand√©) min</label>
            <input id="flt_staff" type="number" min="0" step="1" placeholder="0"/>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn2" id="recountBtn">Actualiser graphiques</button>
          <span class="small muted right">Pareto = top probl√®mes utilis√©s en checklist ‚Ä¢ Camembert = cat√©gories</span>
        </div>
      </div>

      <div class="panel">
        <div class="grid cols-2">
          <div><canvas id="paretoChart" height="220"></canvas></div>
          <div><canvas id="pieChart" height="220"></canvas></div>
        </div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px 0">Tableau d‚Äôindicateurs</h3>
        <table class="table" id="freqTable">
          <thead><tr><th>#</th><th>Probl√®me</th><th>Cat.</th><th>Fr√©q</th><th>Impact m√©dian (h)</th><th>Derni√®re utilisation</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="tab" hidden>
      <div class="panel">
        <h3 style="margin:0 0 8px 0">Flotte A350 Air France ‚Äì Immatriculations</h3>
        <p class="small">Collez une immatriculation par ligne (ex: F-HTYA). Le s√©lecteur de visite utilise cette liste.</p>
        <textarea id="fleetTextarea" placeholder="F-HTYA
F-HTYB
F-HTYC"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn2 primary" id="saveFleetBtn">Enregistrer la flotte</button>
          <button class="btn2" id="loadDemoFleetBtn">Charger exemple</button>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
/* ---------- stockage local ---------- */
const store={get(){try{return JSON.parse(localStorage.getItem('rex-data')||'{}')}catch(e){return{}}},set(d){localStorage.setItem('rex-data',JSON.stringify(d))}};
const data=store.get();
if(!data.problems)data.problems=seedProblems();
if(!data.visits)data.visits=[];
if(!Array.isArray(data.fleet))data.fleet=[];

/* ---------- helpers ---------- */
const $=id=>document.getElementById(id);
const rid=()=>Math.random().toString(36).slice(2,9);
const num=v=>{const n=parseFloat(v);return isNaN(n)?0:n};
function save(){store.set(data)}
function escapeHtml(s){return (s||'').replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}

/* ---------- onglets ---------- */
const tabs={problems:$('tab-problems'),visit:$('tab-visit'),analytics:$('tab-analytics'),settings:$('tab-settings')};
document.querySelectorAll('nav .btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('nav .btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const t=b.dataset.tab; for(const k in tabs){tabs[k].hidden=(k!==t)}
    if(t==='visit'){refreshVisitSelect();renderVisit()}
    if(t==='analytics'){renderFreq();renderCharts()}
    if(t==='settings'){renderFleetSettings()}
  });
});

/* ---------- PROBLEMS ---------- */
const qProblem=$('qProblem'),filterCat=$('filterCat'),filterRecurring=$('filterRecurring'),filterImpact=$('filterImpact'),clearSearch=$('clearSearch'),addProblemBtn=$('addProblemBtn'),problemsList=$('problemsList');
function matches(p){
  const q=(qProblem.value||'').toLowerCase();
  const okQ=!q||[p.title,p.category,p.actor,p.desc].join(' ').toLowerCase().includes(q);
  const okC=!filterCat.value||p.category===filterCat.value;
  const okR=!filterRecurring.checked||!!p.recurring;
  const minI=num(filterImpact.value||0); const okI=!minI||(num(p.impact||0)>=minI);
  return okQ&&okC&&okR&&okI;
}
function renderProblems(){
  problemsList.innerHTML='';
  data.problems.filter(matches).sort((a,b)=>{
    const rb=(b.recurring?1:0)-(a.recurring?1:0); if(rb) return rb;
    const fb=(b.freq||0)-(a.freq||0); if(fb) return fb;
    return a.title.localeCompare(b.title);
  }).forEach(p=>{
    const el=document.createElement('div'); el.className='panel';
    el.innerHTML=`
      <div class="row"><strong>${escapeHtml(p.title)}</strong> ${p.recurring?'<span class="tag">r√©current</span>':''}<span class="right small">Fr√©q: ${p.freq||0}</span></div>
      <div class="row small" style="gap:6px;margin-top:6px">
        <span class="tag">${escapeHtml(p.category)}</span>
        <span class="tag">Impact: ${p.impact||0}h</span>
        <span class="tag">Acteur: ${escapeHtml(p.actor||'‚Äì')}</span>
      </div>
      <div class="muted" style="margin-top:6px">${escapeHtml(p.desc||'')}</div>
      <div class="row" style="margin-top:8px">
        <button class="btn2" data-act="use">Ajouter √† une visite</button>
        <button class="btn2" data-act="dup">Dupliquer</button>
        <button class="btn2" data-act="edit">Modifier</button>
        <button class="btn2 bad" data-act="del">Supprimer</button>
      </div>`;
    el.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>onProblemAction(btn.dataset.act,p)));
    problemsList.appendChild(el);
  });
}
function onProblemAction(act,p){
  if(act==='edit')openProblemDlg(p);
  if(act==='dup'){const c={...p,id:rid(),title:p.title+' (copie)'};data.problems.push(c);save();renderProblems()}
  if(act==='del'){if(confirm('Supprimer ce probl√®me ?')){data.problems=data.problems.filter(x=>x.id!==p.id);save();renderProblems()}}
  if(act==='use'){document.querySelector('[data-tab="visit"]').click();ensureVisit();addProblemToCurrentVisit(p)}
}
const dlg=$('problemDlg'),p_title=$('p_title'),p_cat=$('p_cat'),p_impact=$('p_impact'),p_actor=$('p_actor'),p_desc=$('p_desc'),p_recurring=$('p_recurring'),p_checkable=$('p_checkable');
let editing=null;
function openProblemDlg(p){editing=p||null;p_title.value=p?.title||'';p_cat.value=p?.category||'Cabine';p_impact.value=p?.impact||'';p_actor.value=p?.actor||'';p_desc.value=p?.desc||'';p_recurring.checked=!!p?.recurring;p_checkable.checked=p?.checkable!==false;dlg.showModal()}
$('saveProblem').addEventListener('click',e=>{
  e.preventDefault();
  const obj={id:editing?.id||rid(),title:p_title.value.trim(),category:p_cat.value,impact:num(p_impact.value||0),actor:p_actor.value.trim(),desc:p_desc.value.trim(),recurring:p_recurring.checked,checkable:p_checkable.checked,freq:editing?.freq||0,last:editing?.last||null};
  if(!obj.title){alert('Titre requis');return}
  if(editing){const i=data.problems.findIndex(x=>x.id===editing.id);data.problems[i]=obj}else{data.problems.push(obj)}
  save();dlg.close();renderProblems();
});
addProblemBtn.addEventListener('click',()=>openProblemDlg());
[qProblem,filterCat,filterImpact].forEach(x=>x.addEventListener('input',renderProblems));
filterRecurring.addEventListener('change',renderProblems);
clearSearch.addEventListener('click',()=>{qProblem.value='';filterCat.value='';filterRecurring.checked=false;filterImpact.value='';renderProblems()})

/* ---------- VISITS ---------- */
const visitSelect=$('visitSelect'),newVisitBtn=$('newVisitBtn'),deleteVisitBtn=$('deleteVisitBtn'),visitTable=$('visitTable').querySelector('tbody');
const v_reg=$('v_reg'),v_check=$('v_check'),v_arrival=$('v_arrival'),v_departure=$('v_departure'),v_hmo_plan=$('v_hmo_plan'),v_hmo_real=$('v_hmo_real'),v_staff_plan=$('v_staff_plan'),v_staff_real=$('v_staff_real'),v_eol_lines=$('v_eol_lines'),v_extractions=$('v_extractions'),v_extraction_reason=$('v_extraction_reason'),v_cme=$('v_cme'),v_eir=$('v_eir');

let currentVisitId=data.visits[0]?.id||null;
function ensureVisit(){if(!currentVisitId)createVisit()}
function createVisit(){
  const v={id:rid(),reg:'',check:'A1',arrival:'',departure:'',hmo_plan:null,hmo_real:null,staff_plan:null,staff_real:null,eol_lines:null,extractions:null,extraction_reason:'',cme:null,eir:null,
    vac:{m:{lead:0,eir:0,cme:0},s:{lead:0,eir:0,cme:0},n:{lead:0,eir:0,cme:0},total:{lead:0,eir:0,cme:0}},items:[],created:Date.now()};
  data.visits.unshift(v); currentVisitId=v.id; save(); refreshVisitSelect(); renderVisit();
}
function refreshVisitSelect(){
  visitSelect.innerHTML='';
  data.visits.forEach(v=>{
    const opt=document.createElement('option');
    const d=v.arrival?(' ‚Äì '+new Date(v.arrival).toLocaleDateString()):'';
    opt.value=v.id; opt.textContent=`${v.reg||'Immat ?'} ‚Äì ${v.check}${d}`;
    visitSelect.appendChild(opt);
  });
  if(currentVisitId && data.visits.find(x=>x.id===currentVisitId)) visitSelect.value=currentVisitId;
}
function getV(){ return data.visits.find(x=>x.id===currentVisitId) }
newVisitBtn.addEventListener('click',createVisit);
visitSelect.addEventListener('change',()=>{currentVisitId=visitSelect.value;renderVisit()});
deleteVisitBtn.addEventListener('click',()=>{if(!currentVisitId)return;if(!confirm('Supprimer cette visite ?'))return;data.visits=data.visits.filter(v=>v.id!==currentVisitId);currentVisitId=data.visits[0]?.id||null;save();refreshVisitSelect();renderVisit()});

function fillRegSelect(){v_reg.innerHTML='';const ph=document.createElement('option');ph.value='';ph.textContent='‚Äî choisir ‚Äî';v_reg.appendChild(ph);data.fleet.forEach(r=>{const o=document.createElement('option');o.value=o.textContent=r;v_reg.appendChild(o)})}

/* VAC ‚Äî recalcul + binding */
function recalcVacTotals(){
  const v=getV(); if(!v) return;
  v.vac.m.lead = num($('v_m_lead').value); v.vac.m.eir = num($('v_m_eir').value); v.vac.m.cme = num($('v_m_cme').value);
  v.vac.s.lead = num($('v_s_lead').value); v.vac.s.eir = num($('v_s_eir').value); v.vac.s.cme = num($('v_s_cme').value);
  v.vac.n.lead = num($('v_n_lead').value); v.vac.n.eir = num($('v_n_eir').value); v.vac.n.cme = num($('v_n_cme').value);
  v.vac.total.lead = v.vac.m.lead+v.vac.s.lead+v.vac.n.lead;
  v.vac.total.eir  = v.vac.m.eir +v.vac.s.eir +v.vac.n.eir ;
  v.vac.total.cme  = v.vac.m.cme +v.vac.s.cme +v.vac.n.cme ;
  $('v_tot_lead').value=v.vac.total.lead; $('v_tot_eir').value=v.vac.total.eir; $('v_tot_cme').value=v.vac.total.cme;
  // recopie ent√™te Poids
  v.eir=v.vac.total.eir; v.cme=v.vac.total.cme;
  v_eir.value=v.eir; v_cme.value=v.cme;
  save();
}
function bindVacInputs(){
  ['v_m_lead','v_m_eir','v_m_cme','v_s_lead','v_s_eir','v_s_cme','v_n_lead','v_n_eir','v_n_cme']
  .forEach(id=>{const x=$(id);if(x){x.removeEventListener('input',recalcVacTotals);x.addEventListener('input',recalcVacTotals)}});
}

function renderVisit(){
  const v=getV(); if(!v){visitTable.innerHTML='';return}
  fillRegSelect();
  v_reg.value=v.reg||''; v_check.value=v.check||'A1'; v_arrival.value=v.arrival||''; v_departure.value=v.departure||'';
  v_hmo_plan.value=v.hmo_plan??''; v_hmo_real.value=v.hmo_real??''; v_staff_plan.value=v.staff_plan??''; v_staff_real.value=v.staff_real??'';
  v_cme.value=v.cme??''; v_eir.value=v.eir??''; v_eol_lines.value=v.eol_lines??''; v_extractions.value=v.extractions??''; v_extraction_reason.value=v.extraction_reason||'';

  // VAC
  $('v_m_lead').value=v.vac?.m?.lead??0; $('v_m_eir').value=v.vac?.m?.eir??0; $('v_m_cme').value=v.vac?.m?.cme??0;
  $('v_s_lead').value=v.vac?.s?.lead??0; $('v_s_eir').value=v.vac?.s?.eir??0; $('v_s_cme').value=v.vac?.s?.cme??0;
  $('v_n_lead').value=v.vac?.n?.lead??0; $('v_n_eir').value=v.vac?.n?.eir??0; $('v_n_cme').value=v.vac?.n?.cme??0;
  bindVacInputs(); recalcVacTotals();

  // items
  visitTable.innerHTML='';
  v.items.forEach((it,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="checkbox" ${it.done?'checked':''} data-idx="${idx}" data-k="done"></td>
      <td class="small">${escapeHtml(it.title||'')}</td>
      <td class="small">${escapeHtml(it.category||'')}</td>
      <td>${it.impact||0}</td>
      <td class="small">${escapeHtml(it.actor||'')}</td>
      <td><input value="${escapeHtml(it.note||'')}" data-idx="${idx}" data-k="note"/></td>
      <td><button class="btn2 bad" data-idx="${idx}" data-act="rm">Retirer</button></td>`;
    tr.querySelectorAll('input,button').forEach(x=>x.addEventListener('input',onVisitEdit));
    tr.querySelectorAll('button').forEach(x=>x.addEventListener('click',onVisitEdit));
    visitTable.appendChild(tr);
  });
}
function onVisitEdit(e){
  const v=getV(); if(!v) return;
  const idx=+e.target.dataset.idx; const k=e.target.dataset.k;
  if(e.target.type==='checkbox'){v.items[idx][k]=e.target.checked}
  else if(e.target.tagName==='INPUT' && k){v.items[idx][k]=e.target.value}
  if(e.target.dataset.act==='rm'){v.items.splice(idx,1)}
  save(); renderVisit();
}
[v_reg,v_check,v_arrival,v_departure,v_hmo_plan,v_hmo_real,v_staff_plan,v_staff_real,v_cme,v_eir,v_eol_lines,v_extractions,v_extraction_reason]
.forEach(x=>x.addEventListener('input',()=>{const v=getV(); if(!v) return; v.reg=v_reg.value; v.check=v_check.value; v.arrival=v_arrival.value; v.departure=v_departure.value; v.hmo_plan=num(v_hmo_plan.value); v.hmo_real=num(v_hmo_real.value); v.staff_plan=num(v_staff_plan.value); v.staff_real=num(v_staff_real.value); v.cme=num(v_cme.value); v.eir=num(v_eir.value); v.eol_lines=num(v_eol_lines.value); v.extractions=num(v_extractions.value); v.extraction_reason=v_extraction_reason.value; save();}));

function addProblemToCurrentVisit(p){
  const v=getV(); if(!v) return;
  v.items.push({pid:p.id,title:p.title,category:p.category,impact:p.impact,actor:p.actor,done:false,note:''});
  const ref=data.problems.find(x=>x.id===p.id); if(ref){ref.freq=(ref.freq||0)+1;ref.last=Date.now();}
  save(); renderVisit();
}
$('addItemBtn').addEventListener('click',()=>{
  const pick=prompt('Ajouter un probl√®me existant (mot-cl√© dans le titre):'); if(!pick) return;
  const p=data.problems.find(p=>p.title.toLowerCase().includes(pick.toLowerCase())); if(p) addProblemToCurrentVisit(p); else alert('Aucun probl√®me correspondant');
});
$('markAllDoneBtn').addEventListener('click',()=>{const v=getV(); if(!v) return; v.items.forEach(it=>it.done=true); save(); renderVisit();});
$('autoChecklistBtn').addEventListener('click',()=>{
  const v=getV(); if(!v) return;
  [...data.problems].filter(p=>p.checkable!==false).sort((a,b)=>(b.recurring?1:0)-(a.recurring?1:0)||(b.freq||0)-(a.freq||0)).slice(0,25).forEach(p=>addProblemToCurrentVisit(p));
});

/* ---------- ANALYTICS (Pareto + Pie) ---------- */
let paretoChart=null,pieChart=null;
function renderFreq(){
  const arr=[...data.problems].filter(p=>(p.freq||0)>0).sort((a,b)=>(b.freq||0)-(a.freq||0));
  const tb=$('freqTable').querySelector('tbody'); tb.innerHTML='';
  arr.forEach((p,i)=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td class="small">${escapeHtml(p.title)}</td><td class="small">${escapeHtml(p.category||'')}</td><td>${p.freq||0}</td><td>${p.impact||0}</td><td>${p.last?new Date(p.last).toLocaleDateString():'‚Äì'}</td>`; tb.appendChild(tr)});
}
function monthKey(d){const dt=new Date(d); if(!d||isNaN(dt)) return null; return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')}
function filteredVisits(){
  const m=$('flt_month').value||null;
  const h=num($('flt_hmo').value||0), s=num($('flt_staff').value||0);
  return data.visits.filter(v=>{
    const okM = !m || monthKey(v.arrival)===m;
    const okH = !h || (num(v.hmo_real)-num(v.hmo_plan))>=h;
    const okS = !s || (num(v.staff_real)-num(v.staff_plan))>=s;
    return okM&&okH&&okS;
  });
}
function renderCharts(){
  // Pareto: probl√®mes utilis√©s dans les visites filtr√©es
  const useCount={}; filteredVisits().forEach(v=>v.items.forEach(it=>{useCount[it.title]=(useCount[it.title]||0)+1}));
  const pareto=Object.entries(useCount).sort((a,b)=>b[1]-a[1]).slice(0,12);
  const labelsP=pareto.map(x=>x[0]), dataP=pareto.map(x=>x[1]);

  if(paretoChart){paretoChart.destroy()}
  paretoChart=new Chart($('paretoChart'),{type:'bar',data:{labels:labelsP,datasets:[{label:'Utilisations',data:dataP}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

  // Pie: cat√©gories des items s√©lectionn√©s
  const byCat={}; filteredVisits().forEach(v=>v.items.forEach(it=>{byCat[it.category]=(byCat[it.category]||0)+1}));
  const labelsC=Object.keys(byCat), dataC=Object.values(byCat);
  if(pieChart){pieChart.destroy()}
  pieChart=new Chart($('pieChart'),{type:'pie',data:{labels:labelsC,datasets:[{data:dataC}]}});
}
$('recountBtn').addEventListener('click',()=>{renderFreq();renderCharts()});

/* ---------- SETTINGS (fleet) ---------- */
const fleetTextarea=$('fleetTextarea');
function renderFleetSettings(){fleetTextarea.value=(data.fleet||[]).join('\n')}
$('saveFleetBtn').addEventListener('click',()=>{const lines=fleetTextarea.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);data.fleet=Array.from(new Set(lines));save();alert('Flotte mise √† jour ('+data.fleet.length+')')});
$('loadDemoFleetBtn').addEventListener('click',()=>{data.fleet=['F-HTYA','F-HTYB','F-HTYC','F-HTYD','F-HTYE','F-HUVA','F-HUVB','F-HUVC','F-HUVD'];save();renderFleetSettings();alert('Exemple charg√©')});

/* ---------- import / export ---------- */
$('exportBtn').addEventListener('click',()=>{const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='rex-a350.json';a.click();URL.revokeObjectURL(a.href)});
$('importFile').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const obj=JSON.parse(r.result);if(obj.problems&&obj.visits){data.problems=obj.problems;data.visits=obj.visits;if(Array.isArray(obj.fleet))data.fleet=obj.fleet;save();renderProblems();refreshVisitSelect();renderVisit();alert('Import OK')}else alert('Fichier invalide')}catch(err){alert('Erreur JSON')}};r.readAsText(f)});

/* ---------- seed ---------- */
function seedProblems(){return[
  {id:rid(),title:'Cabine ‚Äì confirmation sous-traitant manquante √† S-1',category:'Cabine',impact:2,actor:'Cabine/STT',desc:'Absence de confirmation lot housses/rideaux.',recurring:true,checkable:true,freq:0},
  {id:rid(),title:'Query ‚Äì t√¢che critique mal s√©quenc√©e',category:'Query/Pr√©pa',impact:3,actor:'Pr√©pa',desc:'Chevauchement d‚Äôune FH critique.',recurring:true,checkable:true,freq:0},
  {id:rid(),title:'Pi√®ces ‚Äì r√©f√©rence manquante (BTC)',category:'Pi√®ces/Log',impact:4,actor:'Log',desc:'R√©f√©rence √† commander non visible.',recurring:true,checkable:true,freq:0},
  {id:rid(),title:'Effectif ‚Äì indisponibilit√© √©quipe nuit J-1',category:'Effectifs/Planif',impact:2,actor:'Planif',desc:'Sous-capacit√© sur cr√©neau critique.',recurring:true,checkable:true,freq:0},
  {id:rid(),title:'Documentation ‚Äì RUM incomplet',category:'Documentation',impact:1,actor:'DOC',desc:'Proc√©dure manquante pour t√¢che cabine.',recurring:false,checkable:true,freq:0}
]}

/* ---------- clavier ---------- */
window.addEventListener('keydown',e=>{
  if(e.key==='/' && !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)){e.preventDefault();$('qProblem').focus()}
  if((e.key==='n'||e.key==='N') && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) openProblemDlg();
  if((e.key==='v'||e.key==='V') && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) {document.querySelector('[data-tab="visit"]').click();ensureVisit();}
});

/* init */
renderProblems(); refreshVisitSelect(); renderVisit();
</script>
</body>
</html>
