<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>REX Planning A350 ‚Äì Check A</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--sub:#94a3b8;
  --accent:#60a5fa;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--line:#1e293b;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui}
header{display:flex;gap:10px;align-items:center;padding:12px 16px;position:sticky;top:0;background:#0f172ab3;backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
h1{font-size:16px;margin:0}
.tag{background:#0b1222;color:#cbd5e1;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px}
.right{margin-left:auto}
.btn{background:#0f1a30;border:1px solid #20324f;color:#dbeafe;border-radius:10px;padding:9px 11px;cursor:pointer}
.btn.primary{background:#102c53;border-color:#1d4ed8}
.btn.good{background:#0d2d1b;border-color:#16a34a}
.btn.warn{background:#3a2a0a;border-color:#f59e0b}
.btn.bad{background:#3a0a0a;border-color:#ef4444}
.wrap{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 54px)}
nav{border-right:1px solid var(--line);background:#0b1222;padding:10px}
nav .tabbtn{display:block;width:100%;text-align:left;margin:6px 0;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f1a30}
nav .tabbtn.active{outline:2px solid var(--accent)}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}
input,select,textarea{width:100%;background:#0b1222;border:1px solid #223050;color:#e5e7eb;border-radius:10px;padding:9px}
input[type="datetime-local"]{padding:7px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--line);padding:8px;vertical-align:top}
.small{font-size:12px;color:var(--sub)}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1222;border:1px solid #223050;border-radius:6px;padding:1px 6px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.pill{border:1px solid #223050;background:#0b1222;border-radius:999px;padding:4px 8px;font-size:12px;color:#cbd5e1}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.hint{color:#93c5fd}
.badge{padding:2px 8px;border-radius:999px;font-size:12px}
.badge.neg{background:#3a0a0a;border:1px solid #ef4444}
.badge.pos{background:#0d2d1b;border:1px solid #16a34a}
.hidden{display:none}
canvas{max-height:360px}
</style>
</head>
<body>
<header>
  <h1>REX Planning A350 ‚Äì Check A</h1>
  <span class="tag">Standalone (localStorage)</span>
  <span class="right"></span>
  <button class="btn" id="exportBtn">Exporter JSON</button>
  <label class="btn" for="importFile">Importer JSON</label>
  <input id="importFile" type="file" accept="application/json" class="hidden">
</header>

<div class="wrap">
  <nav>
    <button class="tabbtn active" data-tab="problems">üìö Biblioth√®que Probl√®mes</button>
    <button class="tabbtn" data-tab="visit">üßæ Checklist Visite</button>
    <button class="tabbtn" data-tab="analytics">üìà Fr√©quences & REX</button>
    <button class="tabbtn" data-tab="settings">‚öôÔ∏è Param√®tres flotte</button>
    <div class="panel small">Astuce : tape <span class="kbd">/</span> pour chercher, <span class="kbd">N</span> pour ajouter un probl√®me, <span class="kbd">V</span> pour une nouvelle visite.</div>
  </nav>

  <main>
    <!-- PROBLEMS -->
    <section id="problems" class="tab">
      <div class="panel">
        <div class="row">
          <input id="qProblem" placeholder="üîé Rechercher (titre, cat√©gorie, acteur, description)‚Ä¶">
          <button class="btn" id="clearSearch">Effacer</button>
          <span class="right"></span>
          <button class="btn primary" id="addProblemBtn">+ Nouveau probl√®me</button>
        </div>
      </div>

      <div class="panel">
        <div class="grid cols-3">
          <div>
            <label>Cat√©gorie (filtre)</label>
            <select id="filterCat">
              <option value="">(toutes)</option>
              <option>Cabine</option><option>Sous-traitance</option><option>Query/Pr√©pa</option>
              <option>Pi√®ces/Log</option><option>Effectifs/Planif</option><option>Documentation</option>
              <option>Autre</option>
            </select>
          </div>
          <div>
            <label>Impact min (h)</label>
            <input type="number" id="filterImpact" min="0" step="0.5" placeholder="0">
          </div>
          <div class="row" style="margin-top:22px">
            <input type="checkbox" id="filterRecurring"><label for="filterRecurring">R√©current seulement</label>
          </div>
        </div>
      </div>

      <div class="panel" id="problemsList"></div>

      <!-- Dialog add/edit -->
      <dialog id="problemDlg">
        <form method="dialog" class="panel" style="min-width:640px">
          <h3 style="margin:0 0 8px">Probl√®me</h3>
          <div class="grid cols-2">
            <div><label>Titre</label><input id="p_title" required></div>
            <div>
              <label>Cat√©gorie</label>
              <input id="p_cat" list="catList" placeholder="ex. Cabine">
              <datalist id="catList">
                <option value="Cabine"><option value="Sous-traitance"><option value="Query/Pr√©pa">
                <option value="Pi√®ces/Log"><option value="Effectifs/Planif"><option value="Documentation"><option value="Autre">
              </datalist>
            </div>
            <div><label>Impact estim√© (h)</label><input type="number" id="p_impact" step="0.5" min="0"></div>
            <div><label>Acteur/Responsable</label><input id="p_actor" placeholder="Cabine, STT, Query‚Ä¶"></div>
          </div>
          <label>Description</label><textarea id="p_desc" placeholder="Contexte, sympt√¥mes, docs concern√©s‚Ä¶"></textarea>
          <div class="row">
            <label><input type="checkbox" id="p_recurring"> R√©current</label>
            <label><input type="checkbox" id="p_checkable" checked> Utilisable en checklist</label>
            <span class="right"></span>
            <button class="btn" value="cancel">Annuler</button>
            <button class="btn primary" id="saveProblem" value="default">Enregistrer</button>
          </div>
        </form>
      </dialog>
    </section>

    <!-- VISIT -->
    <section id="visit" class="tab hidden">
      <div class="panel">
        <div class="row">
          <button class="btn primary" id="newVisitBtn">+ Nouvelle visite</button>
          <select id="visitSelect"></select>
          <button class="btn" id="deleteVisitBtn">Supprimer</button>
          <span class="small right">La HMO & l‚Äôeffectif affichent l‚Äô<b>√©cart</b> et le <b>%</b>.</span>
        </div>
      </div>

      <div class="panel">
        <div class="grid cols-4">
          <div><label>Immatriculation</label><select id="v_reg"></select></div>
          <div><label>Type de Check</label><select id="v_check"><option>A1</option><option>A2</option><option>A3</option><option>A4</option><option>A5</option><option>A6</option><option>A7</option><option>A8</option><option>A9</option><option>A10</option><option>A11</option><option>A12</option></select></div>
          <div><label>Arriv√©e pr√©vue</label><input id="v_arrival_plan" type="datetime-local"></div>
          <div><label>Arriv√©e r√©elle</label><input id="v_arrival_real" type="datetime-local"></div>
        </div>

        <div class="grid cols-4" style="margin-top:10px">
          <div><label>Sortie pr√©vue</label><input id="v_depart_plan" type="datetime-local"></div>
          <div><label>Sortie r√©elle</label><input id="v_depart_real" type="datetime-local"></div>
          <div><label>HMO pr√©vue (h)</label><input id="v_hmo_plan" type="number" step="0.5" min="0"></div>
          <div><label>HMO r√©elle (h)</label><input id="v_hmo_real" type="number" step="0.5" min="0"></div>
        </div>

        <div class="panel" style="margin:12px 0">
          <div class="row"><b>Effectifs demand√©s / r√©els par vacation</b> <span class="small">(somme automatique)</span><span class="right"></span><button class="btn" id="addShiftBtn">+ Ajouter une vac</button></div>
          <table id="shiftTable">
            <thead><tr><th>Vacation</th><th>Demand√©</th><th>R√©el</th><th>Leader CME</th><th>Leader EIR</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="row small">
            <span id="staffDeltaBadge" class="badge">Œî effectif : 0</span>
            <span id="hmoDeltaBadge" class="badge">Œî HMO : 0 h</span>
          </div>
        </div>

        <div class="grid cols-4">
          <div><label>Poids CME (auto)</label><input id="v_cme" type="number" step="0.1" min="0"></div>
          <div><label>Poids EIR (auto)</label><input id="v_eir" type="number" step="0.1" min="0"></div>
          <div><label>Nb lignes fin de chantier</label><input id="v_eol_lines" type="number" step="1" min="0"></div>
          <div><label>Extractions (nb)</label><input id="v_extractions" type="number" step="1" min="0"></div>
        </div>
        <label>Raison(s) des extractions</label><input id="v_extraction_reason" placeholder="pi√®ce manquante, doc, STT, cabine‚Ä¶">
      </div>

      <div class="panel">
        <div class="row">
          <button class="btn" id="autoChecklistBtn">G√©n√©rer checklist (r√©currents + top)</button>
          <button class="btn" id="addItemBtn">+ Ajouter un item</button>
          <span class="right"></span>
          <button class="btn good" id="markAllDoneBtn">Tout marquer fait</button>
        </div>
        <table class="table" id="visitTable">
          <thead><tr><th>‚úî</th><th>Probl√®me</th><th>Cat.</th><th>Impact(h)</th><th>Acteur</th><th>Notes</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="analytics" class="tab hidden">
      <div class="panel">
        <div class="row">
          <div>
            <label>Mois</label>
            <input type="month" id="monthFilter">
          </div>
          <span class="right"></span>
          <button class="btn" id="recountBtn">Actualiser</button>
        </div>
      </div>

      <div class="grid cols-2 panel" style="margin:12px">
        <div>
          <b>Pareto probl√®mes (Fr√©quence)</b>
          <canvas id="paretoChart"></canvas>
        </div>
        <div>
          <b>R√©partition par cat√©gorie</b>
          <canvas id="pieChart"></canvas>
        </div>
      </div>

      <div class="panel">
        <b>Indicateurs mensuels</b>
        <table id="aggTable"><thead>
          <tr><th>Visite</th><th>Immat</th><th>HMO (plan ‚Üí r√©el / Œî)</th><th>Effectif (plan ‚Üí r√©el / Œî)</th><th>Sortie plan ‚Üí r√©el</th></tr>
        </thead><tbody></tbody></table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="tab hidden">
      <div class="panel">
        <h3 style="margin:0 0 8px">Flotte A350 AF ‚Äì Immatriculations</h3>
        <p class="small">Collez une immat par ligne. Exemple : F-HTYA</p>
        <textarea id="fleetTextarea" rows="8" placeholder="F-HTYA
F-HTYB
F-HTYC"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="saveFleetBtn">Enregistrer</button>
          <button class="btn" id="loadDemoFleetBtn">Charger exemple</button>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
/* ------------ State & storage ------------ */
const store={get(){try{return JSON.parse(localStorage.getItem('rex-data')||'{}')}catch(e){return{}}},set(d){localStorage.setItem('rex-data',JSON.stringify(d))}};
const data=store.get();
if(!Array.isArray(data.problems)) data.problems=seedProblems();
if(!Array.isArray(data.visits)) data.visits=[];
if(!Array.isArray(data.fleet)) data.fleet=[];

/* ------------ Tabs (robuste) ------------ */
const tabs={problems:$('#problems'),visit:$('#visit'),analytics:$('#analytics'),settings:$('#settings')};
$$('nav .tabbtn').forEach(b=>{
  b.onclick=()=>{ $$('nav .tabbtn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const t=b.dataset.tab; for(const k in tabs){tabs[k].classList.toggle('hidden',k!==t)}
    if(t==='visit'){refreshVisitSelect(); renderVisit();} 
    if(t==='analytics'){renderAnalytics();}
    if(t==='settings'){renderFleet();}
  };
});

/* ------------ Helpers DOM ------------ */
function $(sel,ctx=document){return ctx.querySelector(sel)}
function $$(sel,ctx=document){return [...ctx.querySelectorAll(sel)]}
function rid(){return Math.random().toString(36).slice(2,9)}
function num(v){const n=parseFloat(v);return isNaN(n)?0:n}

/* ------------ Problems list ------------ */
const listEl=$('#problemsList'); const qEl=$('#qProblem'),fCat=$('#filterCat'),fImp=$('#filterImpact'),fRec=$('#filterRecurring');
$('#addProblemBtn').onclick=()=>openProblemDlg();
$('#clearSearch').onclick=()=>{qEl.value='';fCat.value='';fImp.value='';fRec.checked=false;renderProblems()}
qEl.oninput=renderProblems; fCat.onchange=renderProblems; fImp.oninput=renderProblems; fRec.onchange=renderProblems;

function matches(p){
  const q=(qEl.value||'').toLowerCase();
  const okQ=!q || [p.title,p.category,p.actor,p.desc].join(' ').toLowerCase().includes(q);
  const okC=!fCat.value || p.category===fCat.value;
  const okI=!num(fImp.value) || num(p.impact)>=num(fImp.value);
  const okR=!fRec.checked || !!p.recurring;
  return okQ && okC && okI && okR;
}
function renderProblems(){
  listEl.innerHTML='';
  data.problems.filter(matches).sort((a,b)=>(b.recurring?1:0)-(a.recurring?1:0)||(b.freq||0)-(a.freq||0))
    .forEach(p=>{
      const card=document.createElement('div'); card.className='panel';
      card.innerHTML=`
        <div class="row">
          <b>${escapeHtml(p.title)}</b>
          ${p.recurring?'<span class="pill">r√©current</span>':''}
          <span class="pill">${escapeHtml(p.category||'‚Äì')}</span>
          <span class="pill">Impact: ${p.impact||0}h</span>
          <span class="pill">Acteur: ${escapeHtml(p.actor||'‚Äì')}</span>
          <span class="pill">Fr√©q: ${p.freq||0}</span>
          <span class="right"></span>
          <button class="btn" data-act="use">Ajouter √† la visite</button>
          <button class="btn" data-act="edit">Modifier</button>
          <button class="btn bad" data-act="del">Supprimer</button>
        </div>
        <div class="small" style="margin-top:6px">${escapeHtml(p.desc||'')}</div>`;
      card.onclick=(e)=>{
        const a=e.target.closest('button'); if(!a) return;
        if(a.dataset.act==='edit') openProblemDlg(p);
        if(a.dataset.act==='del'){ if(confirm('Supprimer ce probl√®me ?')){ data.problems=data.problems.filter(x=>x.id!==p.id); save(); renderProblems(); } }
        if(a.dataset.act==='use'){ goVisit(); ensureVisit(); addProblemToVisit(p); }
      };
      listEl.appendChild(card);
    });
}
renderProblems();

/* Dialog add/edit */
const dlg=$('#problemDlg'); const p_title=$('#p_title'),p_cat=$('#p_cat'),p_imp=$('#p_impact'),p_actor=$('#p_actor'),p_desc=$('#p_desc'),p_rec=$('#p_recurring'),p_chk=$('#p_checkable');
let editing=null;
function openProblemDlg(p){
  editing=p||null;
  p_title.value=p?.title||''; p_cat.value=p?.category||''; p_imp.value=p?.impact??''; p_actor.value=p?.actor||''; p_desc.value=p?.desc||''; p_rec.checked=!!p?.recurring; p_chk.checked=p?.checkable!==false;
  dlg.showModal();
}
$('#saveProblem').onclick=(ev)=>{
  ev.preventDefault();
  const obj={
    id: editing?.id || rid(),
    title: p_title.value.trim(),
    category: (p_cat.value||'Autre').trim(),
    impact: num(p_imp.value),
    actor: p_actor.value.trim(),
    desc: p_desc.value.trim(),
    recurring: p_rec.checked,
    checkable: p_chk.checked,
    freq: editing?.freq||0,last: editing?.last||null,
  };
  if(!obj.title){ alert('Titre requis'); return }
  if(editing){ const i=data.problems.findIndex(x=>x.id===editing.id); data.problems[i]=obj; }
  else data.problems.push(obj);
  save(); dlg.close(); renderProblems();
}

/* ------------ Visits / checklist ------------ */
const visitSel=$('#visitSelect');
const v_reg=$('#v_reg'), v_check=$('#v_check'), v_arr_plan=$('#v_arrival_plan'), v_arr_real=$('#v_arrival_real'),
      v_dep_plan=$('#v_depart_plan'), v_dep_real=$('#v_depart_real'),
      v_hmo_plan=$('#v_hmo_plan'), v_hmo_real=$('#v_hmo_real'),
      v_cme=$('#v_cme'), v_eir=$('#v_eir'), v_eol=$('#v_eol_lines'),
      v_ext=$('#v_extractions'), v_reason=$('#v_extraction_reason');

const visitTable=$('#visitTable tbody'); const addItemBtn=$('#addItemBtn'); const autoBtn=$('#autoChecklistBtn'); const markAllBtn=$('#markAllDoneBtn');
const shiftBody=$('#shiftTable tbody'); const addShiftBtn=$('#addShiftBtn'); const staffDeltaBadge=$('#staffDeltaBadge'); const hmoDeltaBadge=$('#hmoDeltaBadge');

let currentVisitId=null;

function ensureVisit(){ if(!currentVisitId) createVisit(); }
function createVisit(){
  const v={id:rid(),reg:'',check:'A1',
   arrival_plan:'',arrival_real:'', depart_plan:'', depart_real:'',
   hmo_plan:0,hmo_real:0, shifts:[{name:'Matin',plan:0,real:0,cme:0,eir:0},{name:'Soir',plan:0,real:0,cme:0,eir:0},{name:'Nuit',plan:0,real:0,cme:0,eir:0}],
   cme:0,eir:0, eol:0, extractions:0, reason:'', items:[], created:Date.now()
  };
  data.visits.unshift(v); currentVisitId=v.id; save(); refreshVisitSelect(); renderVisit();
}
function refreshVisitSelect(){
  visitSel.innerHTML=''; data.visits.forEach(v=>{
    const o=document.createElement('option'); o.value=v.id; o.textContent=`${v.reg||'(?immat)'} ‚Äì ${v.check} ‚Äì ${v.arrival_plan?new Date(v.arrival_plan).toLocaleDateString():''}`; visitSel.appendChild(o);
  });
  if(currentVisitId && data.visits.find(x=>x.id===currentVisitId)) visitSel.value=currentVisitId; else currentVisitId=data.visits[0]?.id||null;
}
visitSel.onchange=()=>{ currentVisitId=visitSel.value; renderVisit(); }
$('#newVisitBtn').onclick=createVisit;
$('#deleteVisitBtn').onclick=()=>{ if(!currentVisitId) return; if(!confirm('Supprimer cette visite ?')) return;
  data.visits=data.visits.filter(v=>v.id!==currentVisitId); currentVisitId=data.visits[0]?.id||null; save(); refreshVisitSelect(); renderVisit();
}

function getV(){ return data.visits.find(v=>v.id===currentVisitId) }

function renderVisit(){
  const v=getV(); if(!v){ visitTable.innerHTML=''; shiftBody.innerHTML=''; return }
  fillFleet();
  v_reg.value=v.reg||''; v_check.value=v.check||'A1';
  v_arr_plan.value=v.arrival_plan||''; v_arr_real.value=v.arrival_real||''; v_dep_plan.value=v.depart_plan||''; v_dep_real.value=v.depart_real||'';
  v_hmo_plan.value=v.hmo_plan??''; v_hmo_real.value=v.hmo_real??''; v_cme.value=v.cme??''; v_eir.value=v.eir??''; v_eol.value=v.eol??''; v_ext.value=v.extractions??''; v_reason.value=v.reason||'';

  // Shifts
  shiftBody.innerHTML='';
  v.shifts.forEach((s,i)=>shiftBody.appendChild(renderShiftRow(s,i)));
  updateAutoTotals(v);
  // Items
  visitTable.innerHTML=''; v.items.forEach((it,idx)=>visitTable.appendChild(renderItemRow(it,idx)));
  updateBadges(v);
}
function renderShiftRow(s,i){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input value="${escapeAttr(s.name)}" data-i="${i}" data-k="name"></td>
    <td><input type="number" step="1" min="0" value="${s.plan||0}" data-i="${i}" data-k="plan"></td>
    <td><input type="number" step="1" min="0" value="${s.real||0}" data-i="${i}" data-k="real"></td>
    <td><input type="number" step="0.1" min="0" value="${s.cme||0}" data-i="${i}" data-k="cme"></td>
    <td><input type="number" step="0.1" min="0" value="${s.eir||0}" data-i="${i}" data-k="eir"></td>
    <td><button class="btn bad" data-i="${i}" data-act="rm">Retirer</button></td>`;
  tr.oninput=(e)=>{ const v=getV(); const k=e.target.dataset.k; const idx=+e.target.dataset.i; if(v&&k){ v.shifts[idx][k]=k==='name'?e.target.value:num(e.target.value); save(); updateAutoTotals(v); updateBadges(v);} }
  tr.onclick=(e)=>{ if(e.target.dataset.act==='rm'){ const v=getV(); v.shifts.splice(+e.target.dataset.i,1); save(); renderVisit(); } }
  return tr;
}
addShiftBtn.onclick=()=>{ const v=getV(); v.shifts.push({name:'Vac',plan:0,real:0,cme:0,eir:0}); save(); renderVisit(); }

function updateAutoTotals(v){
  // CME/EIR total from leaders
  v.cme = v.shifts.reduce((a,s)=>a+num(s.cme),0);
  v_eir.value = v.eir = v.shifts.reduce((a,s)=>a+num(s.eir),0);
  v_cme.value = v.cme;
  save();
}
function updateBadges(v){
  const hDelta=num(v.hmo_real)-num(v.hmo_plan);
  hmoDeltaBadge.textContent=`Œî HMO : ${hDelta.toFixed(1)} h ${pct(num(v.hmo_real),num(v.hmo_plan))}`;
  hmoDeltaBadge.className='badge '+(hDelta>0?'neg':(hDelta<0?'pos':''));  

  const p=v.shifts.reduce((a,s)=>a+num(s.plan),0), r=v.shifts.reduce((a,s)=>a+num(s.real),0);
  const sDelta=r-p;
  staffDeltaBadge.textContent=`Œî effectif : ${sDelta} ${pct(r,p)}`;
  staffDeltaBadge.className='badge '+(sDelta>0?'neg':(sDelta<0?'pos':''));
}
function pct(a,b){ if(b<=0) return ''; const v=((a-b)/b*100); return `(${v>=0?'+':''}${v.toFixed(0)}%)` }

[v_reg,v_check,v_arr_plan,v_arr_real,v_dep_plan,v_dep_real,v_hmo_plan,v_hmo_real,v_cme,v_eir,v_eol,v_ext,v_reason].forEach(el=>{
  el.oninput=()=>{ const v=getV(); if(!v) return;
    if(el===v_reg) v.reg=v_reg.value; else if(el===v_check) v.check=v_check.value;
    else if(el===v_arr_plan) v.arrival_plan=el.value; else if(el===v_arr_real) v.arrival_real=el.value;
    else if(el===v_dep_plan) v.depart_plan=el.value; else if(el===v_dep_real) v.depart_real=el.value;
    else if(el===v_hmo_plan) v.hmo_plan=num(el.value); else if(el===v_hmo_real) v.hmo_real=num(el.value);
    else if(el===v_cme) v.cme=num(el.value); else if(el===v_eir) v.eir=num(el.value);
    else if(el===v_eol) v.eol=num(el.value); else if(el===v_ext) v.extractions=num(el.value);
    else if(el===v_reason) v.reason=el.value;
    save(); updateBadges(v);
  }
});

function renderItemRow(it,idx){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input type="checkbox" ${it.done?'checked':''} data-idx="${idx}" data-k="done"></td>
    <td class="small mono">${escapeHtml(it.title||'')}</td>
    <td class="small">${escapeHtml(it.category||'')}</td>
    <td>${it.impact||0}</td>
    <td class="small">${escapeHtml(it.actor||'')}</td>
    <td><input value="${escapeAttr(it.note||'')}" data-idx="${idx}" data-k="note"></td>
    <td><button class="btn bad" data-idx="${idx}" data-act="rm">Retirer</button></td>`;
  tr.oninput=(e)=>{ const v=getV(); const i=+e.target.dataset.idx; const k=e.target.dataset.k; if(!v) return;
    if(e.target.type==='checkbox') v.items[i][k]=e.target.checked; else v.items[i][k]=e.target.value; save();
  };
  tr.onclick=(e)=>{ if(e.target.dataset.act==='rm'){ const v=getV(); v.items.splice(+e.target.dataset.idx,1); save(); renderVisit(); } }
  return tr;
}
addItemBtn.onclick=()=>openPicker();
autoBtn.onclick=()=>{ const v=getV(); if(!v) return;
  const cands=[...data.problems].filter(p=>p.checkable!==false).sort((a,b)=>(b.recurring?1:0)-(a.recurring?1:0)||(b.freq||0)-(a.freq||0)).slice(0,25);
  cands.forEach(p=>addProblemToVisit(p));
}
markAllBtn.onclick=()=>{ const v=getV(); if(!v) return; v.items.forEach(i=>i.done=true); save(); renderVisit(); }
function addProblemToVisit(p){
  const v=getV(); if(!v) return;
  v.items.push({pid:p.id,title:p.title,category:p.category,impact:p.impact,actor:p.actor,done:false,note:''});
  const ref=data.problems.find(x=>x.id===p.id); if(ref){ ref.freq=(ref.freq||0)+1; ref.last=Date.now(); }
  save(); renderVisit();
}
function openPicker(){ const pick=prompt('Ajouter probl√®me (mot-cl√©) :'); if(!pick) return;
  const p=data.problems.find(x=>x.title.toLowerCase().includes(pick.toLowerCase())); if(!p) return alert('Aucun trouv√©'); addProblemToVisit(p);
}

/* ------------ Analytics ------------ */
let paretoChart=null, pieChart=null;
function renderAnalytics(){
  const m=$('#monthFilter').value; // yyyy-mm
  // dataset
  const problemsUsed={}; const catCount={}; const rows=[];
  data.visits.forEach(v=>{
    const monthStr=v.arrival_plan? v.arrival_plan.slice(0,7) : '';
    if(m && monthStr!==m) return;
    const p=v.shifts.reduce((a,s)=>a+num(s.plan),0), r=v.shifts.reduce((a,s)=>a+num(s.real),0);
    rows.push([v.check,v.reg,`${v.hmo_plan} ‚Üí ${v.hmo_real} (${(num(v.hmo_real)-num(v.hmo_plan)).toFixed(1)}h)`,
               `${p} ‚Üí ${r} (${r-p})`, `${fmtDT(v.depart_plan)} ‚Üí ${fmtDT(v.depart_real)}`]);
    v.items.forEach(it=>{ problemsUsed[it.title]=(problemsUsed[it.title]||0)+1; catCount[it.category]=(catCount[it.category]||0)+1; })
  });
  // table
  const tb=$('#aggTable tbody'); tb.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r[0]}</td><td>${r[1]||''}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td>`; tb.appendChild(tr) });

  // pareto
  const sorted=Object.entries(problemsUsed).sort((a,b)=>b[1]-a[1]).slice(0,12);
  const labels=sorted.map(x=>x[0]); const vals=sorted.map(x=>x[1]);
  const ctx1=$('#paretoChart').getContext('2d');
  if(paretoChart) paretoChart.destroy();
  paretoChart=new Chart(ctx1,{type:'bar',data:{labels,datasets:[{label:'Fr√©quence',data:vals}]},options:{plugins:{legend:{display:false}}}});

  // pie
  const cSorted=Object.entries(catCount).sort((a,b)=>b[1]-a[1]);
  const cl=cSorted.map(x=>x[0]||'‚Äì'), cv=cSorted.map(x=>x[1]);
  const ctx2=$('#pieChart').getContext('2d');
  if(pieChart) pieChart.destroy();
  pieChart=new Chart(ctx2,{type:'pie',data:{labels:cl,datasets:[{data:cv}]}});
}
$('#recountBtn').onclick=renderAnalytics;

/* ------------ Settings / Fleet ------------ */
function renderFleet(){ $('#fleetTextarea').value=(data.fleet||[]).join('\n'); }
function fillFleet(){
  v_reg.innerHTML='<option value="">‚Äî choisir ‚Äî</option>'+ (data.fleet||[]).map(r=>`<option>${r}</option>`).join('');
  const v=getV(); if(v) v_reg.value=v.reg||'';
}
$('#saveFleetBtn').onclick=()=>{ const lines=$('#fleetTextarea').value.split(/\n+/).map(s=>s.trim()).filter(Boolean); data.fleet=[...new Set(lines)]; save(); alert('Flotte mise √† jour.'); }
$('#loadDemoFleetBtn').onclick=()=>{ data.fleet=['F-HTYA','F-HTYB','F-HTYC','F-HTYD','F-HTYE']; save(); renderFleet(); alert('Exemple charg√©.'); }

/* ------------ Import/Export ------------ */
$('#exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rex-planning-a350.json'; a.click(); URL.revokeObjectURL(a.href); }
$('#importFile').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); if(o.problems&&o.visits){ data.problems=o.problems; data.visits=o.visits; data.fleet=Array.isArray(o.fleet)?o.fleet:[]; save(); renderProblems(); refreshVisitSelect(); renderVisit(); alert('Import OK'); } else alert('Fichier invalide'); }catch(err){ alert('Erreur JSON') } }; r.readAsText(f); }

/* ------------ Seed & utils ------------ */
function seedProblems(){
  return [
    {id:rid(),title:'Cabine ‚Äì confirmation STT manquante S-1',category:'Cabine',impact:2,actor:'Cabine/STT',desc:'Absence de confirmation sur lot housses/rideaux.',recurring:true,checkable:true,freq:0},
    {id:rid(),title:'Query ‚Äì T√¢che FH critique mal s√©quenc√©e',category:'Query/Pr√©pa',impact:3,actor:'Pr√©pa',desc:'Chevauchement interventions.',recurring:true,checkable:true,freq:0},
    {id:rid(),title:'Pi√®ces ‚Äì R√©f√©rence manquante (BTC)',category:'Pi√®ces/Log',impact:4,actor:'Log',desc:'Commande non visible / retard BTC.',recurring:true,checkable:true,freq:0},
    {id:rid(),title:'Effectif ‚Äì indisponibilit√© √©quipe nuit J-1',category:'Effectifs/Planif',impact:2,actor:'Planif',desc:'Sous-capacit√© cr√©neau critique.',recurring:true,checkable:true,freq:0},
    {id:rid(),title:'Documentation ‚Äì RUM incomplet',category:'Documentation',impact:1,actor:'DOC',desc:'Proc√©dure manquante.',recurring:false,checkable:true,freq:0}
  ];
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
function escapeAttr(s){return escapeHtml(s).replace(/"/g,'&quot;')}
function fmtDT(x){return x?new Date(x).toLocaleString():''}
function save(){ store.set(data) }
function goVisit(){ $$('nav .tabbtn').forEach(b=>b.classList.remove('active')); $$('nav .tabbtn')[1].classList.add('active'); for(const k in tabs){tabs[k].classList.toggle('hidden',k!=='visit')} }
window.addEventListener('keydown',e=>{
  if(e.key==='/' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)){ e.preventDefault(); qEl.focus() }
  if((e.key==='n'||e.key==='N') && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) openProblemDlg();
  if((e.key==='v'||e.key==='V') && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) { goVisit(); ensureVisit(); }
});
</script>
</body>
</html>
