<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>REX A350 – Check A (simple & fiable)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#60a5fa;--line:#27324a;}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui}
h1{font-size:18px;margin:0;font-weight:700}
header{display:flex;gap:10px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--muted);position:sticky;top:0;background:rgba(15,23,42,.9);backdrop-filter:saturate(140%) blur(8px)}
.tag{background:#0ea5e9;color:#00111b;border-radius:6px;padding:3px 8px;font-weight:700}
.right{margin-left:auto}
.btn{display:inline-flex;gap:8px;align-items:center;background:#0ea5e9;border:none;border-radius:10px;padding:8px 12px;color:#00111b;font-weight:700;cursor:pointer}
.btn.small{padding:5px 9px;border-radius:8px;font-size:12px}
.btn.ghost{background:transparent;border:1px solid #344055;color:#e5e7eb}
.wrap{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 56px)}
nav{border-right:1px solid var(--muted);padding:12px}
nav .tab{display:block;width:100%;text-align:left;background:#0b1220;border:1px solid #243044;padding:10px 12px;margin:8px 0;border-radius:10px;color:#e5e7eb;cursor:pointer}
nav .tab.active{background:#0ea5e9;color:#00111b;border-color:#0ea5e9}
main{padding:16px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
.grid{display:grid;gap:10px}
.cols-2{grid-template-columns:1fr 1fr}.cols-3{grid-template-columns:repeat(3,1fr)}.cols-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;opacity:.8}
input,select,textarea{width:100%;background:#0b1220;border:1px solid #334155;color:#e5e7eb;border-radius:10px;padding:10px}
table{width:100%;border-collapse:collapse}th,td{border-bottom:1px solid #223049;padding:8px;text-align:left}
thead th{position:sticky;top:0;background:#0b1220;z-index:1}tfoot td{background:#0b1220;font-weight:700}
.badge{display:inline-flex;gap:6px;align-items:center;background:#0b1220;border:1px solid #223049;border-radius:999px;padding:4px 10px;font-size:12px}
.small{opacity:.75}
.delbtn{background:#1f2937;color:#e5e7eb;border:1px solid #334155;border-radius:8px;padding:4px 8px;cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>REX A350 – <span class="tag">Check A</span></h1>
  <span class="right"></span>
  <button id="exportJson" class="btn ghost">Exporter JSON</button>
  <label class="btn ghost" for="importJson">Importer JSON</label>
  <input id="importJson" type="file" accept="application/json" style="display:none">
</header>

<div class="wrap">
  <nav>
    <button class="tab active" data-tab="visit">🧰 Visite</button>
    <button class="tab" data-tab="perf">📈 Performance</button>
  </nav>

  <main>
    <!-- VISITE -->
    <section id="visit" class="panel">
      <h2>Visite (Check A)</h2>
      <div class="grid cols-4">
        <div>
          <label>Immatriculation</label>
          <input id="v_immat" list="immatList" placeholder="ex. F-HUVK">
          <datalist id="immatList">
            <option>F-HTYA</option><option>F-HTYB</option><option>F-HTYC</option><option>F-HTYD</option>
            <option>F-HTYE</option><option>F-HTYF</option><option>F-HTYG</option><option>F-HTYH</option>
            <option>F-HTYI</option><option>F-HTYJ</option><option>F-HTYK</option><option>F-HTYL</option>
            <option>F-HTYM</option><option>F-HTYN</option><option>F-HUVK</option><option>F-HUVL</option>
          </datalist>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Ajouter une immat</label>
            <input id="newImmat" placeholder="ex. F-HUVP">
          </div>
          <div style="align-self:end">
            <button class="btn small ghost" id="addImmat">+ Ajouter</button>
          </div>
        </div>
        <div>
          <label>Arrivée réelle</label>
          <input id="v_arr_real" type="datetime-local">
        </div>
        <div>
          <label>Départ réel</label>
          <input id="v_dep_real" type="datetime-local">
        </div>
        <div>
          <label>Nb lignes désassignées</label>
          <input id="v_unassign" type="number" min="0" value="0">
        </div>
        <div>
          <label>Raison(s)</label>
          <input id="v_unassign_reason" placeholder="ex. pièce manquante, outillage…">
        </div>
        <div>
          <label>Nb lignes fin de chantier</label>
          <input id="v_eoj" type="number" min="0" value="0">
        </div>
        <div style="align-self:end">
          <label class="btn ghost" for="xmlImport">Importer XML</label>
          <input id="xmlImport" type="file" accept=".xml" style="display:none">
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;align-items:center;gap:10px">
          <h3 style="margin:0">Effectifs par vacation</h3>
          <button id="addVac" class="btn small">+ Ajouter une vacation</button>
        </div>
        <table id="vacTable">
          <thead>
            <tr>
              <th>Vacation</th>
              <th>CME dem.</th><th>EIR dem.</th><th>Leader dem.</th><th>Eff. demandé total</th>
              <th>CME réel</th><th>EIR réel</th><th>Leader réel</th><th>Eff. réel total</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td><b>Total général</b></td>
              <td id="tg_cme_dem">0</td><td id="tg_eir_dem">0</td><td id="tg_lead_dem">0</td><td id="tg_dem">0</td>
              <td id="tg_cme_real">0</td><td id="tg_eir_real">0</td><td id="tg_lead_real">0</td><td id="tg_real">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
        <div class="small" style="display:flex;gap:10px;margin-top:8px">
          <span class="badge">Δ Effectif : <span id="deltaEff">0</span></span>
          <span class="badge">Δ HMO : <span id="deltaHmo">—</span></span>
        </div>
      </div>

      <div style="display:flex;gap:10px">
        <button id="saveVisit" class="btn">💾 Enregistrer</button>
        <button id="clearForm" class="btn ghost">Effacer le formulaire</button>
      </div>
    </section>

    <!-- PERFORMANCE -->
    <section id="perf" class="panel" style="display:none">
      <h2>Performance</h2>
      <div class="grid cols-4">
        <div><label>Du</label><input id="f_from" type="date"></div>
        <div><label>Au</label><input id="f_to" type="date"></div>
        <div><label>Immat</label><input id="f_immat" list="immatList" placeholder="Toutes"></div>
      </div>

      <div class="grid cols-3" style="margin-top:10px">
        <div class="panel"><div class="small">Écart Effectif (moy.)</div><div id="kpiEff" style="font-size:22px;font-weight:800">0%</div></div>
        <div class="panel"><div class="small">Écart HMO (moy.)</div><div id="kpiHmo" style="font-size:22px;font-weight:800">0%</div></div>
        <div class="panel"><div class="small">Respect planning (sortie à l’heure)</div><div id="kpiOnTime" style="font-size:22px;font-weight:800">0%</div></div>
      </div>

      <div class="panel">
        <h3>Visites</h3>
        <table id="perfTable">
          <thead><tr>
            <th>Date</th><th>Immat</th>
            <th>Eff. dem.</th><th>Eff. réel</th><th>ΔEff</th>
            <th>HMO dem.</th><th>HMO réel</th><th>ΔHMO</th>
            <th>Arrivée</th><th>Départ</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<script>
const $ = (s,ctx=document)=>ctx.querySelector(s);
const $$=(s,ctx=document)=>Array.from(ctx.querySelectorAll(s));

/* ------------ Tabs ------------ */
$$('nav .tab').forEach(b=>{
  b.onclick=()=>{
    $$('nav .tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    ['visit','perf'].forEach(id=>$('#'+id).style.display='none');
    $('#'+b.dataset.tab).style.display='';
    if(b.dataset.tab==='perf') renderPerf();
  };
});

/* ------------ Data store ------------ */
const db = {
  visits : JSON.parse(localStorage.getItem('rex_min_visits')||'[]')
};
const save = ()=>localStorage.setItem('rex_min_visits',JSON.stringify(db.visits));

/* ------------ Immat add ------------ */
$('#addImmat').onclick=()=>{
  const v=$('#newImmat').value.trim().toUpperCase();
  if(!v) return;
  const dl=$('#immatList');
  if(!$$('option',dl).some(o=>o.value===v)){
    const op=document.createElement('option'); op.value=v; dl.appendChild(op);
  }
  $('#v_immat').value=v; $('#newImmat').value='';
};

/* ------------ Vacations table ------------ */
const vacBody = $('#vacTable tbody');

function rowVac(name='Matin'){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="vac_name" value="${name}"></td>
    <td><input class="cme_dem" type="number" min="0" step="1" value="0"></td>
    <td><input class="eir_dem" type="number" min="0" step="1" value="0"></td>
    <td><input class="lead_dem" type="number" min="0" step="1" value="0"></td>
    <td class="dem_tot">0</td>
    <td><input class="cme_real" type="number" min="0" step="1" value="0"></td>
    <td><input class="eir_real" type="number" min="0" step="1" value="0"></td>
    <td><input class="lead_real" type="number" min="0" step="1" value="0"></td>
    <td class="real_tot">0</td>
    <td><button class="delbtn">Retirer</button></td>`;
  return tr;
}
function seedVac(){ vacBody.innerHTML=''; ['Matin','Soir','Nuit'].forEach(n=>vacBody.appendChild(rowVac(n))); recalc(); }
seedVac();

$('#addVac').onclick=()=>{ vacBody.appendChild(rowVac('Vac.')); };

vacBody.addEventListener('input', e=>{ if(e.target.tagName==='INPUT') recalc(); });
vacBody.addEventListener('click', e=>{
  if(e.target.classList.contains('delbtn')){ e.target.closest('tr').remove(); recalc(); }
});

/* ------------ Calculs ------------ */
function recalc(){
  let tg={cme_dem:0,eir_dem:0,lead_dem:0,dem:0,cme_real:0,eir_real:0,lead_real:0,real:0};
  $$('#vacTable tbody tr').forEach(tr=>{
    const d = +$('.cme_dem',tr).value + +$('.eir_dem',tr).value + +$('.lead_dem',tr).value;
    const r = +$('.cme_real',tr).value + +$('.eir_real',tr).value + +$('.lead_real',tr).value;
    $('.dem_tot',tr).textContent=d; $('.real_tot',tr).textContent=r;
    tg.cme_dem+= +$('.cme_dem',tr).value; tg.eir_dem+= +$('.eir_dem',tr).value; tg.lead_dem+= +$('.lead_dem',tr).value; tg.dem+=d;
    tg.cme_real+= +$('.cme_real',tr).value; tg.eir_real+= +$('.eir_real',tr).value; tg.lead_real+= +$('.lead_real',tr).value; tg.real+=r;
  });
  $('#tg_cme_dem').textContent=tg.cme_dem; $('#tg_eir_dem').textContent=tg.eir_dem; $('#tg_lead_dem').textContent=tg.lead_dem; $('#tg_dem').textContent=tg.dem;
  $('#tg_cme_real').textContent=tg.cme_real; $('#tg_eir_real').textContent=tg.eir_real; $('#tg_lead_real').textContent=tg.lead_real; $('#tg_real').textContent=tg.real;
  $('#deltaEff').textContent = tg.real - tg.dem;

  const arr = $('#v_arr_real').value? new Date($('#v_arr_real').value):null;
  const dep = $('#v_dep_real').value? new Date($('#v_dep_real').value):null;
  if(arr && dep && dep>arr){
    const hours=(dep-arr)/3600000;
    const hDem=tg.dem*hours, hReal=tg.real*hours;
    $('#deltaHmo').textContent=((hReal-hDem)>=0?'+':'')+ (Math.round((hReal-hDem)*10)/10)+'h';
  }else{
    $('#deltaHmo').textContent='—';
  }
}
['v_arr_real','v_dep_real'].forEach(id=>$('#'+id).addEventListener('input',recalc));

/* ------------ XML (nom de fichier) ------------ */
$('#xmlImport').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const name=f.name;
  const im=(name.match(/F-?H.../i)||[])[0]; if(im) $('#v_immat').value=im.toUpperCase().replace(/(F)(H)/,'F-H');
  f.text().then(t=>{
    const ts=(t.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}/)||[])[0];
    if(ts && !$('#v_arr_real').value) $('#v_arr_real').value=ts.slice(0,16);
    alert('XML importé (immat détectée si possible).');
  });
};

/* ------------ Enregistrer / Effacer ------------ */
$('#saveVisit').onclick=()=>{
  const vac = $$('#vacTable tbody tr').map(tr=>({
    n:$('.vac_name',tr).value.trim()||'Vac.',
    cd:+$('.cme_dem',tr).value||0, ed:+$('.eir_dem',tr).value||0, ld:+$('.lead_dem',tr).value||0,
    cr:+$('.cme_real',tr).value||0, er:+$('.eir_real',tr).value||0, lr:+$('.lead_real',tr).value||0
  }));
  const sum = vac.reduce((a,v)=>({dem:a.dem+v.cd+v.ed+v.ld, real:a.real+v.cr+v.er+v.lr}),{dem:0,real:0});
  const arr=$('#v_arr_real').value? new Date($('#v_arr_real').value):null;
  const dep=$('#v_dep_real').value? new Date($('#v_dep_real').value):null;
  let hDem=0,hReal=0;
  if(arr&&dep&&dep>arr){ const h=(dep-arr)/3600000; hDem=sum.dem*h; hReal=sum.real*h; }
  const visit={
    id:Date.now(), immat:($('#v_immat').value||'').toUpperCase(),
    arrReal:$('#v_arr_real').value, depReal:$('#v_dep_real').value,
    unassign:+$('#v_unassign').value||0, reason:$('#v_unassign_reason').value, eoj:+$('#v_eoj').value||0,
    vac, effDem:sum.dem, effReal:sum.real, hmoDem:hDem, hmoReal:hReal,
    createdAt:new Date().toISOString()
  };
  db.visits.push(visit); save(); alert('Visite enregistrée'); renderPerf();
};
$('#clearForm').onclick=()=>{ seedVac(); ['v_immat','v_arr_real','v_dep_real','v_unassign_reason','newImmat'].forEach(id=>$('#'+id).value=''); $('#v_unassign').value=0; $('#v_eoj').value=0; recalc(); };

/* ------------ Export / Import JSON ------------ */
$('#exportJson').onclick=()=>{
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'rex-data.json'}); a.click(); URL.revokeObjectURL(a.href);
};
$('#importJson').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  f.text().then(t=>{ const d=JSON.parse(t); if(d.visits) db.visits=d.visits; save(); alert('Import OK'); renderPerf(); });
};

/* ------------ Performance ------------ */
function rangeFilter(v){
  const from=$('#f_from').value? new Date($('#f_from').value): new Date('2000-01-01');
  const to  =$('#f_to').value? new Date($('#f_to').value): new Date('2100-01-01'); to.setHours(23,59,59,999);
  const im=$('#f_immat').value.trim().toUpperCase();
  const d=v.arrReal? new Date(v.arrReal):new Date(v.createdAt);
  if(d<from||d>to) return false;
  if(im && v.immat!==im) return false;
  return true;
}
function fmtH(x){return (Math.round(x*10)/10)+'h';}
function pct(a,b){return b? ((a-b)/b):0;}
function renderPerf(){
  const vs=db.visits.filter(rangeFilter);
  const tb=$('#perfTable tbody'); tb.innerHTML='';
  let eD=0,eR=0,hD=0,hR=0,on=0,c=0;
  vs.forEach(v=>{
    eD+=v.effDem; eR+=v.effReal; hD+=v.hmoDem; hR+=v.hmoReal; c++;
    if(v.depReal && v.arrReal && v.depReal>=v.arrReal) on++; // sortie “valide” simple
    const d=v.arrReal? new Date(v.arrReal): new Date(v.createdAt);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${d.toLocaleDateString()}</td><td>${v.immat||'—'}</td>
      <td>${v.effDem}</td><td>${v.effReal}</td><td>${v.effReal-v.effDem}</td>
      <td>${v.hmoDem?fmtH(v.hmoDem):'—'}</td><td>${v.hmoReal?fmtH(v.hmoReal):'—'}</td><td>${(v.hmoDem||v.hmoReal)?fmtH((v.hmoReal||0)-(v.hmoDem||0)):'—'}</td>
      <td>${v.arrReal?new Date(v.arrReal).toLocaleTimeString():'—'}</td><td>${v.depReal?new Date(v.depReal).toLocaleTimeString():'—'}</td>`;
    tb.appendChild(tr);
  });
  $('#kpiEff').textContent = (eD? Math.round(pct(eR,eD)*100):0)+'%';
  $('#kpiHmo').textContent = (hD? Math.round(pct(hR,hD)*100):0)+'%';
  $('#kpiOnTime').textContent= (c? Math.round(on/c*100):0)+'%';
}
['f_from','f_to','f_immat'].forEach(id=>$('#'+id).addEventListener('input',renderPerf));
renderPerf();
</script>
</body>
</html>
