<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>REX Planning A350 ‚Äì Standalone</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#60a5fa}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Ubuntu}
    header{display:flex;gap:12px;align-items:center;padding:14px 18px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:rgba(15,23,42,.9);backdrop-filter:saturate(140%) blur(8px)}
    header h1{font-size:16px;margin:0;font-weight:700}
    .tag{padding:2px 8px;border-radius:999px;background:var(--muted);font-size:12px;color:#cbd5e1}
    .wrap{display:grid;grid-template-columns:260px 1fr;height:calc(100vh - 56px)}
    nav{border-right:1px solid #1f2937;background:#0b1222;padding:10px;overflow:auto}
    nav .btn{display:block;width:100%;text-align:left;margin:6px 0;padding:10px 12px;border:1px solid #1f2937;border-radius:10px;background:#0f1a30;color:#dbeafe;cursor:pointer}
    nav .btn.active{outline:2px solid var(--accent)}
    main{padding:14px;overflow:auto}
    .panel{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:12px;margin:12px 0}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    input,select,textarea{width:100%;background:#0b1222;border:1px solid #223050;color:#e5e7eb;border-radius:10px;padding:10px}
    input[type="checkbox"], input[type="radio"]{width:auto}
    textarea{min-height:76px}
    label{font-size:12px;color:#94a3b8}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid #223050;background:#0b1222;border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
    .btn2{border:1px solid #223050;background:#0b1222;border-radius:10px;padding:8px 10px;color:#e5e7eb;cursor:pointer}
    .btn2.primary{background:#11345a;border-color:#1d4ed8}
    .btn2.good{background:#0d2d1b;border-color:#16a34a}
    .btn2.bad{background:#3a0a0a;border-color:#ef4444}
    .list{display:grid;gap:8px}
    .card{background:#0c1528;border:1px solid #1e293b;border-radius:12px;padding:10px}
    .card h3{margin:0 0 6px 0;font-size:14px}
    .muted{color:#94a3b8}
    .right{margin-left:auto}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #1e293b;padding:8px;text-align:left;vertical-align:top}
    .small{font-size:12px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;background:#111827;border:1px solid #273146;border-radius:6px;padding:1px 6px}
    .footer{opacity:.7;font-size:12px;margin-top:12px}
  </style>
</head>
<body>
  <header>
    <h1>REX Planning A350 ‚Äì Standalone</h1>
    <span class="tag">Sans serveur (LocalStorage)</span>
    <span class="right"></span>
    <button class="btn2" id="exportBtn">Exporter JSON</button>
    <label class="btn2" for="importFile">Importer JSON</label>
    <input type="file" id="importFile" accept="application/json" style="display:none" />
  </header>
  <div class="wrap">
    <nav>
      <button class="btn active" data-tab="problems">üìö Biblioth√®que Probl√®mes</button>
      <button class="btn" data-tab="visit">üßæ Checklist Visite</button>
      <button class="btn" data-tab="analytics">üìà Fr√©quences & REX</button>
      <button class="btn" data-tab="settings">‚öôÔ∏è Param√®tres flotte</button>
    </nav>

    <main>
      <section id="tab-problems" class="tab">
        <div class="panel">
          <div class="row">
            <input id="qProblem" placeholder="üîé Rechercher un probl√®me (titre, cat√©gorie, acteur, description)‚Ä¶" />
            <button class="btn2" id="clearSearch">Effacer</button>
            <span class="right"></span>
            <button class="btn2 primary" id="addProblemBtn">+ Nouveau probl√®me</button>
          </div>
        </div>
        <div class="panel">
          <div class="grid cols-3">
            <div>
              <label>Cat√©gorie</label>
              <select id="filterCat">
                <option value="">(toutes)</option>
                <option>Cabine</option><option>Sous-traitance</option><option>Query/Pr√©pa</option>
                <option>Pi√®ces/Log</option><option>Effectifs/Planif</option><option>Documentation</option><option>Autre</option>
              </select>
            </div>
            <div>
              <label>Impact min (heures)</label>
              <input type="number" id="filterImpact" min="0" step="0.5" placeholder="0" />
            </div>
            <div class="small muted" style="align-self:end">Cochez ‚Äúr√©current‚Äù dans l‚Äôitem pour qu‚Äôil apparaisse en priorit√© dans les checklists.</div>
          </div>
        </div>
        <div class="list" id="problemsList"></div>

        <dialog id="problemDlg">
          <form method="dialog" style="min-width:640px">
            <div class="panel">
              <h3 style="margin:0 0 8px 0">Probl√®me</h3>
              <div class="grid cols-2">
                <div><label>Titre</label><input id="p_title" required /></div>
                <div><label>Cat√©gorie</label><select id="p_cat">
                  <option>Cabine</option><option>Sous-traitance</option><option>Query/Pr√©pa</option>
                  <option>Pi√®ces/Log</option><option>Effectifs/Planif</option><option>Documentation</option><option>Autre</option>
                </select></div>
                <div><label>Impact estim√© (heures)</label><input type="number" id="p_impact" min="0" step="0.5" /></div>
                <div><label>Acteur/Responsable</label><input id="p_actor" placeholder="ex. Cabine, STT, Query, Planif‚Ä¶"/></div>
              </div>
              <div style="margin-top:8px"><label>Description</label><textarea id="p_desc" placeholder="Contexte, sympt√¥mes, documents concern√©s‚Ä¶"></textarea></div>
              <div class="row" style="margin-top:8px">
                <label><input type="checkbox" id="p_recurring"/> R√©current</label>
                <label><input type="checkbox" id="p_checkable" checked/> Utilisable en checklist</label>
                <span class="right"></span>
                <button class="btn2" value="cancel">Annuler</button>
                <button class="btn2 primary" id="saveProblem" value="default">Enregistrer</button>
              </div>
            </div>
          </form>
        </dialog>
      </section>

      <section id="tab-visit" class="tab" hidden>
        <div class="panel">
          <div class="row">
            <button class="btn2 primary" id="newVisitBtn">+ Nouvelle visite</button>
            <select id="visitSelect"></select>
            <button class="btn2 bad" id="deleteVisitBtn">Supprimer visite</button>
            <span class="right"></span>
            <span class="muted">Cr√©er une checklist √† partir des probl√®mes r√©currents (cocher sans ressaisir).</span>
          </div>
        </div>

        <div class="panel">
          <div class="grid cols-4">
            <div><label>Immatriculation (AF A350)</label><select id="v_reg"></select></div>
            <div><label>Type de Check</label><select id="v_check">
              <option>A1</option><option>A2</option><option>A3</option><option>A4</option>
              <option>A5</option><option>A6</option><option>A7</option><option>A8</option>
              <option>A9</option><option>A10</option><option>A11</option><option>A12</option>
            </select></div>
            <div><label>Arriv√©e pr√©vue</label><input id="v_arrival" type="datetime-local"/></div>
            <div><label>Arriv√©e r√©elle</label><input id="v_arrival_real" type="datetime-local"/></div>
          </div>
          <div class="grid cols-4" style="margin-top:10px">
            <div><label>Sortie pr√©vue</label><input id="v_departure" type="datetime-local"/></div>
            <div><label>Sortie r√©elle</label><input id="v_departure_real" type="datetime-local"/></div>
            <div><label>HMO pr√©vue (h)</label><input id="v_hmo_plan" type="number" min="0" step="0.5"/></div>
            <div><label>HMO r√©elle (h)</label><input id="v_hmo_real" type="number" min="0" step="0.5"/></div>
          </div>
          <div class="grid cols-4" style="margin-top:10px">
            <div><label>Effectif matin</label><input id="v_staff_m" type="number" min="0" step="1"/></div>
            <div><label>Effectif soir</label><input id="v_staff_s" type="number" min="0" step="1"/></div>
            <div><label>Effectif nuit</label><input id="v_staff_n" type="number" min="0" step="1"/></div>
            <div><label>Nb lignes fin de chantier</label><input id="v_eol_lines" type="number" min="0" step="1"/></div>
          </div>
          <div class="grid cols-4" style="margin-top:10px">
            <div><label>Poids Leader</label><input id="v_p_lead" type="number" min="0" step="0.1"/></div>
            <div><label>Poids EIR</label><input id="v_p_eir" type="number" min="0" step="0.1"/></div>
            <div><label>Poids CME</label><input id="v_p_cme" type="number" min="0" step="0.1"/></div>
            <div><label>Poids total (auto)</label><input id="v_p_total" disabled/></div>
          </div>
          <div class="grid cols-4" style="margin-top:10px">
            <div><label>Extractions (nombre)</label><input id="v_extractions" type="number" min="0" step="1"/></div>
            <div class="cols-3" style="grid-column: span 3;">
              <label>Raison des extractions</label>
              <input id="v_extraction_reason" placeholder="Motif(s) (ex. pi√®ce manquante, doc, STT, cabine‚Ä¶)"/>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn2" id="autoChecklistBtn">G√©n√©rer checklist (r√©currents + top)</button>
            <button class="btn2" id="addItemBtn">+ Ajouter un item</button>
            <span class="right"></span>
            <button class="btn2 good" id="markAllDoneBtn">Tout marquer fait</button>
          </div>
        </div>

        <div class="panel">
          <table class="table" id="visitTable">
            <thead>
              <tr><th>‚úî</th><th>Probl√®me</th><th>Cat.</th><th>Impact(h)</th><th>Acteur</th><th>Notes</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="tab-analytics" class="tab" hidden>
        <div class="panel">
          <div class="row">
            <div class="pill">Top probl√®mes r√©currents</div>
            <span class="right"></span>
            <button class="btn2" id="recountBtn">Actualiser</button>
          </div>
        </div>
        <div class="panel">
          <table class="table" id="freqTable">
            <thead>
              <tr><th>#</th><th>Probl√®me</th><th>Cat.</th><th>Fr√©quence</th><th>Impact(h) m√©dian</th><th>Derni√®re utilisation</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="footer">Utilisez ces infos pour prioriser l'anticipation (S-3 / S-1) et s√©curiser la sortie √† l'heure.</div>
        </div>
      </section>

      <section id="tab-settings" class="tab" hidden>
        <div class="panel">
          <h3 style="margin:0 0 8px 0">Flotte A350 Air France ‚Äì Immatriculations</h3>
          <p class="small muted">Collez la liste des immatriculations (une par ligne). Exemple : <span class="kbd">F-HTYA</span>.</p>
          <textarea id="fleetTextarea" placeholder="F-HTYA
F-HTYB
F-HTYC" style="width:100%;min-height:120px"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn2 primary" id="saveFleetBtn">Enregistrer la flotte</button>
            <button class="btn2" id="loadDemoFleetBtn">Charger un exemple</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- Storage helpers
    const store = {
      get(){ try{ return JSON.parse(localStorage.getItem('rex-data-standalone')||'{}') }catch(e){ return {} } },
      set(d){ localStorage.setItem('rex-data-standalone', JSON.stringify(d)) }
    }

    // Data shape
    const data = store.get();
    if(!data.problems) data.problems = seedProblems();
    if(!data.visits) data.visits = [];
    if(!Array.isArray(data.fleet)) data.fleet = [];

    // --- Tabs
    const tabs = {
      problems: document.getElementById('tab-problems'),
      visit: document.getElementById('tab-visit'),
      analytics: document.getElementById('tab-analytics'),
      settings: document.getElementById('tab-settings'),
    }
    document.querySelectorAll('nav .btn').forEach(b=>{
      b.addEventListener('click',()=>{
        document.querySelectorAll('nav .btn').forEach(x=>x.classList.remove('active'))
        b.classList.add('active')
        const t=b.dataset.tab
        for(const k in tabs){ tabs[k].hidden = (k!==t) }
        if(t==='analytics') renderFreq();
        if(t==='visit') { refreshVisitSelect(); renderVisit(); }
        if(t==='settings') { renderFleetSettings(); }
      })
    })

    // --- Problems
    const list = document.getElementById('problemsList');
    const qProblem = document.getElementById('qProblem');
    const filterCat = document.getElementById('filterCat');
    const filterImpact = document.getElementById('filterImpact');
    const addProblemBtn = document.getElementById('addProblemBtn');
    const clearSearch = document.getElementById('clearSearch');

    function matches(p){
      const q=(qProblem.value||'').toLowerCase();
      const okQ = !q || [p.title,p.category,p.actor,p.desc].join(' ').toLowerCase().includes(q)
      const okC = !filterCat.value || p.category===filterCat.value
      const minI = parseFloat(filterImpact.value||0)
      const okI = !minI || (parseFloat(p.impact||0) >= minI)
      return okQ && okC && okI
    }

    function renderProblems(){
      list.innerHTML='';
      data.problems.filter(matches).sort((a,b)=>{
        const ra=(a.recurring?1:0), rb=(b.recurring?1:0);
        if(rb-ra!==0) return rb-ra;
        const fa=(a.freq||0), fb=(b.freq||0);
        if(fb-fa!==0) return fb-fa;
        return a.title.localeCompare(b.title)
      }).forEach(p=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `
          <h3>${escapeHtml(p.title)} ${p.recurring?'<span class="tag">r√©current</span>':''}</h3>
          <div class="row small">
            <span class="pill">${escapeHtml(p.category||'‚Äì')}</span>
            <span class="pill">Impact: ${p.impact||0}h</span>
            <span class="pill">Acteur: ${escapeHtml(p.actor||'‚Äì')}</span>
            <span class="pill">Fr√©q: ${p.freq||0}</span>
            <span class="right"></span>
            <button class="btn2" data-act="use">Ajouter √† une visite</button>
            <button class="btn2" data-act="dup">Dupliquer</button>
            <button class="btn2" data-act="edit">Modifier</button>
            <button class="btn2 bad" data-act="del">Supprimer</button>
          </div>
          <div class="muted" style="margin-top:6px">${escapeHtml(p.desc||'')}</div>
        `;
        el.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>onProblemAction(btn.dataset.act,p)) )
        list.appendChild(el)
      })
    }

    function onProblemAction(act,p){
      if(act==='edit') openProblemDlg(p)
      if(act==='dup') { const c={...p,id:rid(),title:p.title+" (copie)"}; data.problems.push(c); save(); renderProblems() }
      if(act==='del') { if(confirm('Supprimer ce probl√®me ?')){ data.problems=data.problems.filter(x=>x.id!==p.id); save(); renderProblems() } }
      if(act==='use'){
        document.querySelector('[data-tab="visit"]').click();
        ensureVisit();
        addProblemToCurrentVisit(p)
      }
    }

    function rid(){ return Math.random().toString(36).slice(2,9) }

    // Add/Edit dialog
    const dlg = document.getElementById('problemDlg');
    const p_title = document.getElementById('p_title');
    const p_cat = document.getElementById('p_cat');
    const p_impact = document.getElementById('p_impact');
    const p_actor = document.getElementById('p_actor');
    const p_desc = document.getElementById('p_desc');
    const p_recurring = document.getElementById('p_recurring');
    const p_checkable = document.getElementById('p_checkable');
    let editing=null;
    function openProblemDlg(p){
      editing=p||null;
      p_title.value=p?.title||''; p_cat.value=p?.category||'Cabine';
      p_impact.value=p?.impact||''; p_actor.value=p?.actor||''; p_desc.value=p?.desc||'';
      p_recurring.checked=!!(p?.recurring); p_checkable.checked= p?.checkable!==false;
      dlg.showModal();
    }
    document.getElementById('saveProblem').addEventListener('click', (e)=>{
      e.preventDefault();
      const obj = {
        id: editing?.id || rid(),
        title: p_title.value.trim(),
        category: p_cat.value,
        impact: parseFloat(p_impact.value||0),
        actor: p_actor.value.trim(),
        desc: p_desc.value.trim(),
        recurring: p_recurring.checked,
        checkable: p_checkable.checked,
        freq: editing?.freq||0,
        last: editing?.last||null,
      };
      if(!obj.title){ alert('Titre requis'); return }
      if(editing){ const i=data.problems.findIndex(x=>x.id===editing.id); data.problems[i]=obj } else { data.problems.push(obj) }
      save(); dlg.close(); renderProblems();
    })

    addProblemBtn.addEventListener('click',()=>openProblemDlg())
    clearSearch.addEventListener('click',()=>{ qProblem.value=''; filterCat.value=''; filterImpact.value=''; renderProblems(); qProblem.focus() })
    qProblem.addEventListener('input', renderProblems)
    filterCat.addEventListener('change', renderProblems)
    filterImpact.addEventListener('input', renderProblems)

    // --- Visits
    const newVisitBtn = document.getElementById('newVisitBtn');
    const visitSelect = document.getElementById('visitSelect');
    const deleteVisitBtn = document.getElementById('deleteVisitBtn');
    const v_reg = document.getElementById('v_reg');
    const v_check = document.getElementById('v_check');
    const v_arrival = document.getElementById('v_arrival');
    const v_arrival_real = document.getElementById('v_arrival_real');
    const v_departure = document.getElementById('v_departure');
    const v_departure_real = document.getElementById('v_departure_real');
    const v_hmo_plan = document.getElementById('v_hmo_plan');
    const v_hmo_real = document.getElementById('v_hmo_real');
    const v_staff_m = document.getElementById('v_staff_m');
    const v_staff_s = document.getElementById('v_staff_s');
    const v_staff_n = document.getElementById('v_staff_n');
    const v_eol_lines = document.getElementById('v_eol_lines');
    const v_p_lead = document.getElementById('v_p_lead');
    const v_p_eir = document.getElementById('v_p_eir');
    const v_p_cme = document.getElementById('v_p_cme');
    const v_p_total = document.getElementById('v_p_total');
    const v_extractions = document.getElementById('v_extractions');
    const v_extraction_reason = document.getElementById('v_extraction_reason');

    const visitTable = document.getElementById('visitTable').querySelector('tbody');
    const autoChecklistBtn = document.getElementById('autoChecklistBtn');
    const addItemBtn = document.getElementById('addItemBtn');
    const markAllDoneBtn = document.getElementById('markAllDoneBtn');

    let currentVisitId = data.visits[0]?.id || null;

    function ensureVisit(){ if(!currentVisitId){ createVisit(); } }
    function createVisit(){
      const v={ id: rid(), reg:'', check:'A1', arrival:'', arrival_real:'', departure:'', departure_real:'', hmo_plan:null, hmo_real:null, staff_m:null, staff_s:null, staff_n:null, eol_lines:null, p_lead:null, p_eir:null, p_cme:null, p_total:null, extractions:null, extraction_reason:'', items:[], created: Date.now() };
      data.visits.unshift(v); currentVisitId=v.id; save(); refreshVisitSelect(); renderVisit();
    }

    function refreshVisitSelect(){
      visitSelect.innerHTML='';
      data.visits.forEach(v=>{
        const opt=document.createElement('option');
        const d=v.departure? (' ‚Äì sortie '+(v.departure||'')): '';
        opt.value=v.id; opt.textContent=`${v.reg||'(!) immat ?'} ‚Äì ${v.check||'A?'}${d}`;
        visitSelect.appendChild(opt);
      })
      if(currentVisitId && data.visits.find(x=>x.id===currentVisitId)) visitSelect.value=currentVisitId;
      else currentVisitId=data.visits[0]?.id||null;
    }

    function fillRegSelect(){
      v_reg.innerHTML='';
      const placeholder=document.createElement('option'); placeholder.value=''; placeholder.textContent='‚Äî choisir ‚Äî'; v_reg.appendChild(placeholder);
      data.fleet.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; v_reg.appendChild(o) })
      const v=getV(); if(v){ v_reg.value=v.reg||'' }
    }

    function renderVisit(){
      const v = data.visits.find(x=>x.id===currentVisitId);
      if(!v){ visitTable.innerHTML=''; return }
      fillRegSelect();
      v_check.value=v.check||'A1';
      v_arrival.value=v.arrival||''; v_arrival_real.value=v.arrival_real||'';
      v_departure.value=v.departure||''; v_departure_real.value=v.departure_real||'';
      v_hmo_plan.value = v.hmo_plan??''; v_hmo_real.value=v.hmo_real??'';
      v_staff_m.value = v.staff_m??''; v_staff_s.value = v.staff_s??''; v_staff_n.value = v.staff_n??'';
      v_eol_lines.value = v.eol_lines??'';
      v_p_lead.value = v.p_lead??''; v_p_eir.value=v.p_eir??''; v_p_cme.value=v.p_cme??'';
      v_p_total.value = ((+v.p_lead||0)+(+v.p_eir||0)+(+v.p_cme||0)).toFixed(1);
      v_extractions.value=v.extractions??''; v_extraction_reason.value = v.extraction_reason||'';

      visitTable.innerHTML='';
      v.items.forEach((it,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><input type="checkbox" ${it.done?'checked':''} data-idx="${idx}" data-k="done"></td>
          <td class="small">${escapeHtml(it.title||'')}</td>
          <td class="small">${escapeHtml(it.category||'')}</td>
          <td>${it.impact||0}</td>
          <td class="small">${escapeHtml(it.actor||'')}</td>
          <td><input value="${escapeAttr(it.note||'')}" data-idx="${idx}" data-k="note"/></td>
          <td><button class="btn2 bad" data-idx="${idx}" data-act="rm">Retirer</button></td>
        `;
        tr.querySelectorAll('input,button').forEach(x=>x.addEventListener('input', onVisitEdit));
        tr.querySelectorAll('button').forEach(x=>x.addEventListener('click', onVisitEdit));
        visitTable.appendChild(tr)
      })
    }

    function onVisitEdit(e){
      const v = data.visits.find(x=>x.id===currentVisitId); if(!v) return;
      const idx = +e.target.dataset.idx; const k=e.target.dataset.k;
      if(e.target.type==='checkbox'){ v.items[idx][k]=e.target.checked }
      else if(e.target.tagName==='INPUT' && k){ v.items[idx][k]=e.target.value }
      if(e.target.dataset.act==='rm'){ if(confirm('Supprimer cet item ?')) v.items.splice(idx,1) }
      save(); renderVisit();
    }

    // persist visit header fields
    function getV(){ return data.visits.find(x=>x.id===currentVisitId) }
    v_reg.addEventListener('change', ()=>{ const v=getV(); v.reg=v_reg.value; save(); refreshVisitSelect() })
    v_check.addEventListener('change', ()=>{ const v=getV(); v.check=v_check.value; save(); refreshVisitSelect() })
    ;[v_arrival,v_arrival_real,v_departure,v_departure_real,v_extraction_reason].forEach(el=> el.addEventListener('input', ()=>{ const v=getV(); v[el.id.replace('v_','')]=el.value; save() }))
    ;[v_hmo_plan,v_hmo_real,v_staff_m,v_staff_s,v_staff_n,v_eol_lines,v_p_lead,v_p_eir,v_p_cme,v_extractions].forEach(el=> el.addEventListener('input', ()=>{ const v=getV(); v[el.id.replace('v_','')]=toNum(el.value); v_p_total.value=((+v.p_lead||0)+(+v.p_eir||0)+(+v.p_cme||0)).toFixed(1); save() }))

    function toNum(v){ const n=parseFloat(v); return isNaN(n)?null:n }

    newVisitBtn.addEventListener('click', createVisit)
    visitSelect.addEventListener('change', ()=>{ currentVisitId=visitSelect.value; renderVisit() })
    deleteVisitBtn.addEventListener('click', ()=>{
      if(!currentVisitId) return; if(!confirm('‚ö†Ô∏è Supprimer cette visite ?')) return;
      data.visits = data.visits.filter(v=>v.id!==currentVisitId); currentVisitId=data.visits[0]?.id||null; save(); refreshVisitSelect(); renderVisit();
    })

    function addProblemToCurrentVisit(p){
      const v=getV(); if(!v) return;
      v.items.push({ pid:p.id, title:p.title, category:p.category, impact:p.impact, actor:p.actor, done:false, note:'' });
      const ref=data.problems.find(x=>x.id===p.id); if(ref){ ref.freq=(ref.freq||0)+1; ref.last=Date.now(); }
      save(); renderVisit();
    }

    document.getElementById('autoChecklistBtn').addEventListener('click', ()=>{
      const v=getV(); if(!v) return;
      const candidates = [...data.problems]
        .filter(p=>p.checkable!==false)
        .sort((a,b)=> (b.recurring?-1:0)-(a.recurring?-1:0) || (b.freq||0)-(a.freq||0))
        .slice(0,25);
      candidates.forEach(p=> addProblemToCurrentVisit(p))
    })

    document.getElementById('addItemBtn').addEventListener('click', ()=>{
      const pick = prompt('Ajouter un probl√®me existant (mot-cl√©) :');
      if(!pick) return;
      const p = data.problems.find(p=>p.title.toLowerCase().includes(pick.toLowerCase()));
      if(p) addProblemToCurrentVisit(p); else alert('Aucun probl√®me correspondant');
    })

    document.getElementById('markAllDoneBtn').addEventListener('click', ()=>{
      const v=getV(); if(!v) return; v.items.forEach(it=>it.done=true); save(); renderVisit();
    })

    // --- Analytics
    const freqTable = document.getElementById('freqTable').querySelector('tbody');
    function renderFreq(){
      const arr=[...data.problems].filter(p=> (p.freq||0)>0).sort((a,b)=> (b.freq||0)-(a.freq||0));
      freqTable.innerHTML='';
      arr.forEach((p,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td class="small">${escapeHtml(p.title)}</td>
          <td class="small">${escapeHtml(p.category||'')}</td>
          <td>${p.freq||0}</td>
          <td>${p.impact||0}</td>
          <td>${p.last? new Date(p.last).toLocaleDateString(): '‚Äì'}</td>
        `;
        freqTable.appendChild(tr)
      })
    }
    document.getElementById('recountBtn').addEventListener('click', renderFreq)

    // --- Settings / Fleet
    const fleetTextarea = document.getElementById('fleetTextarea');
    const saveFleetBtn = document.getElementById('saveFleetBtn');
    const loadDemoFleetBtn = document.getElementById('loadDemoFleetBtn');

    function renderFleetSettings(){
      fleetTextarea.value = (data.fleet||[]).join('\n');
    }
    saveFleetBtn.addEventListener('click', ()=>{
      const lines = fleetTextarea.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      data.fleet = Array.from(new Set(lines));
      save(); alert('Flotte mise √† jour ('+data.fleet.length+' immatriculations).');
      fillRegSelect();
    })
    loadDemoFleetBtn.addEventListener('click', ()=>{
      const demo=['F-HTYA','F-HTYB','F-HTYC','F-HTYD','F-HTYE'];
      data.fleet = demo; save(); renderFleetSettings(); alert('Exemple charg√©.');
      fillRegSelect();
    })

    // --- Export/Import
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rex-planning-a350-data.json'; a.click(); URL.revokeObjectURL(a.href);
    })
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.problems&&obj.visits){ data.problems=obj.problems; data.visits=obj.visits; if(Array.isArray(obj.fleet)) data.fleet=obj.fleet; save(); renderProblems(); refreshVisitSelect(); renderVisit(); alert('Import r√©ussi') } else alert('Fichier invalide') }catch(err){ alert('Erreur JSON') } };
      r.readAsText(f);
    })

    function seedProblems(){
      return [
        {id:rid(), title:'Cabine ‚Äì confirmation sous-traitant manquante √† S-1', category:'Cabine', impact:2, actor:'Cabine/STT', desc:'Absence de confirmation sur lot housses/rideaux.', recurring:true, checkable:true, freq:0},
        {id:rid(), title:'Query ‚Äì T√¢che critique mal s√©quenc√©e', category:'Query/Pr√©pa', impact:3, actor:'Pr√©pa', desc:'La t√¢che FH critique se chevauche avec d\\'autres interventions.', recurring:true, checkable:true, freq:0},
        {id:rid(), title:'Pi√®ces ‚Äì r√©f√©rence manquante (BTC)', category:'Pi√®ces/Log', impact:4, actor:'Log', desc:'R√©f√©rence √† commander non visible / retard BTC.', recurring:true, checkable:true, freq:0},
        {id:rid(), title:'Effectif ‚Äì indisponibilit√© √©quipe nuit J-1', category:'Effectifs/Planif', impact:2, actor:'Planif', desc:'Sous-capacit√© sur cr√©neau critique.', recurring:true, checkable:true, freq:0},
        {id:rid(), title:'Documentation ‚Äì RUM incomplet', category:'Documentation', impact:1, actor:'DOC', desc:'Proc√©dure manquante pour t√¢che cabine.', recurring:false, checkable:true, freq:0}
      ]
    }

    function save(){ store.set(data) }
    function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;') }

    // init
    renderProblems(); refreshVisitSelect(); renderVisit();
  </script>
</body>
</html>
