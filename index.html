<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REX Planning A350 – Check A (Vacations CME/EIR/Leader)</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Ubuntu}
    header{display:flex;gap:12px;align-items:center;padding:14px 18px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:rgba(15,23,42,.9);backdrop-filter:saturate(140%) blur(8px)}
    header h1{font-size:16px;margin:0;font-weight:700}
    .tag{padding:2px 8px;border-radius:999px;background:var(--muted);font-size:12px;color:#cbd5e1}
    main{max-width:1100px;margin:20px auto;padding:0 14px}
    .panel{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:12px;margin:12px 0}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    label{font-size:12px;color:#94a3b8;display:block;margin-bottom:4px}
    input,select{width:100%;background:#0b1222;border:1px solid #223050;color:#e5e7eb;border-radius:10px;padding:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid #223050;background:#0b1222;border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #1e293b;padding:8px;text-align:left;vertical-align:middle}
    .table th{font-size:12px;color:#9fb5d6}
    .vac-label{min-width:72px}
    .muted{color:#94a3b8}
    .badge{display:inline-block;border-radius:999px;padding:4px 8px;font-size:12px;line-height:1;border:1px solid #223050;background:#0b1222}
    .badge.ok{border-color:#14532d;background:#052e16;color:#86efac}
    .badge.warn{border-color:#78350f;background:#3a2a0a;color:#fed7aa}
    .badge.bad{border-color:#7f1d1d;background:#3a0a0a;color:#fecaca}
    .right{margin-left:auto}
    .hint{color:#93c5fd}
    .sep{height:8px}
  </style>
</head>
<body>
  <header>
    <h1>REX Planning A350 – Check A</h1>
    <span class="tag">Vacations CME/EIR/Leader (Dem / Réel)</span>
    <span class="right"></span>
    <button id="exportBtn" class="pill">Exporter JSON</button>
    <label class="pill" for="importFile">Importer JSON</label>
    <input type="file" id="importFile" accept="application/json" style="display:none"/>
  </header>

  <main>
    <!-- VISITE -->
    <section class="panel">
      <h3 style="margin:0 0 8px 0">En-tête de la visite</h3>
      <div class="grid cols-4">
        <div>
          <label>Immatriculation (AF A350)</label>
          <select id="v_reg"></select>
        </div>
        <div>
          <label>Type de Check</label>
          <select id="v_check">
            <option value="A1">A1</option><option value="A2">A2</option><option value="A3">A3</option><option value="A4">A4</option>
            <option value="A5">A5</option><option value="A6">A6</option><option value="A7">A7</option><option value="A8">A8</option>
            <option value="A9">A9</option><option value="A10">A10</option><option value="A11">A11</option><option value="A12">A12</option>
          </select>
        </div>
        <div>
          <label>Arrivée prévue</label>
          <input id="v_arrival" type="datetime-local"/>
        </div>
        <div>
          <label>Sortie prévue</label>
          <input id="v_departure" type="datetime-local"/>
        </div>
      </div>
      <div class="sep"></div>
      <div class="grid cols-4">
        <div>
          <label>HMO prévue (h)</label>
          <input id="v_hmo_plan" type="number" step="0.5" min="0"/>
        </div>
        <div>
          <label>HMO réelle (h)</label>
          <input id="v_hmo_real" type="number" step="0.5" min="0"/>
        </div>
        <div class="row" style="align-items:flex-end">
          <div>
            <div class="muted">Δ HMO</div>
            <div id="badgeHmo" class="badge">—</div>
          </div>
        </div>
        <div class="row" style="align-items:flex-end">
          <div>
            <div class="muted">Δ effectif (réel − demandé)</div>
            <div id="badgeEff" class="badge">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- STAFF GRID -->
    <section class="panel">
      <h3 style="margin:0 0 8px 0">Effectifs par vacation (CME / EIR / Leader)</h3>
      <table class="table" id="staffTable">
        <thead>
          <tr>
            <th class="vac-label">Vacation</th>
            <th colspan="2">CME</th>
            <th colspan="2">EIR</th>
            <th colspan="2">Leader</th>
          </tr>
          <tr class="muted">
            <th></th>
            <th>Demandé</th><th>Réel</th>
            <th>Demandé</th><th>Réel</th>
            <th>Demandé</th><th>Réel</th>
          </tr>
        </thead>
        <tbody id="staffBody">
          <!-- lignes injectées par JS -->
        </tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <span class="hint">Astuce : si un <b>Réel</b> &gt; 0 et le <b>Demandé</b> est 0, on met automatiquement 1 (modifiable).</span>
      </div>
    </section>

    <!-- FLOTTE -->
    <section class="panel">
      <h3 style="margin:0 0 8px 0">Flotte A350 Air France – Immatriculations</h3>
      <p class="muted" style="margin:0 0 8px 0">Une par ligne (ex : F-HTYA). Le menu de la visite propose cette liste.</p>
      <textarea id="fleetTextarea" style="width:100%;min-height:120px;background:#0b1222;border:1px solid #223050;color:#e5e7eb;border-radius:10px;padding:10px"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="pill" id="saveFleetBtn">Enregistrer la flotte</button>
        <button class="pill" id="loadDemoFleetBtn">Charger exemple AF</button>
      </div>
    </section>
  </main>

  <script>
    // ----------- Storage helpers
    const store = {
      get(){ try{ return JSON.parse(localStorage.getItem('rex-data')||'{}') }catch(e){ return {} } },
      set(d){ localStorage.setItem('rex-data', JSON.stringify(d)) }
    };

    // Data shape
    const data = store.get();
    if(!data.visits) data.visits = [];
    if(!Array.isArray(data.fleet)) data.fleet = [];

    // Create or get current visit
    let v = data.visits[0];
    if(!v){
      v = {
        id: String(Date.now()),
        reg: "", check: "A1",
        arrival: "", departure: "",
        hmo_plan: null, hmo_real: null,
        staff: {
          Matin:  { cme_d:0,cme_r:0, eir_d:0,eir_r:0, lead_d:0,lead_r:0 },
          Soir:   { cme_d:0,cme_r:0, eir_d:0,eir_r:0, lead_d:0,lead_r:0 },
          Nuit:   { cme_d:0,cme_r:0, eir_d:0,eir_r:0, lead_d:0,lead_r:0 },
        }
      };
      data.visits.unshift(v);
      save();
    }

    function save(){ store.set(data) }

    // ----------- DOM refs
    const v_reg = document.getElementById('v_reg');
    const v_check = document.getElementById('v_check');
    const v_arrival = document.getElementById('v_arrival');
    const v_departure = document.getElementById('v_departure');
    const v_hmo_plan = document.getElementById('v_hmo_plan');
    const v_hmo_real = document.getElementById('v_hmo_real');
    const staffBody = document.getElementById('staffBody');
    const badgeHmo = document.getElementById('badgeHmo');
    const badgeEff = document.getElementById('badgeEff');

    // ----------- Fleet UI
    const fleetTextarea = document.getElementById('fleetTextarea');
    const saveFleetBtn = document.getElementById('saveFleetBtn');
    const loadDemoFleetBtn = document.getElementById('loadDemoFleetBtn');

    function renderFleet(){
      fleetTextarea.value = (data.fleet||[]).join('\n');
      // fill select
      v_reg.innerHTML = '';
      const ph = document.createElement('option'); ph.value=''; ph.textContent='— choisir —';
      v_reg.appendChild(ph);
      data.fleet.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; v_reg.appendChild(o) });
      v_reg.value = v.reg || '';
    }

    saveFleetBtn.addEventListener('click', ()=>{
      const lines = fleetTextarea.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      data.fleet = Array.from(new Set(lines));
      save(); renderFleet(); alert('Flotte mise à jour ('+data.fleet.length+')');
    });

    loadDemoFleetBtn.addEventListener('click', ()=>{
      data.fleet = [
        'F-HTYA','F-HTYB','F-HTYC','F-HTYD','F-HTYE','F-HTYF','F-HTYG','F-HTYH','F-HTYI','F-HTYJ','F-HTYK',
        'F-HTYL','F-HTYM','F-HTYN','F-HTYO','F-HTYP','F-HTYQ','F-HTYR','F-HTYS','F-HTYT',
        'F-HUVA','F-HUVB','F-HUVC','F-HUVD','F-HUVE','F-HUVF','F-HUVG','F-HUVH','F-HUVI','F-HUVJ','F-HUVK','F-HUVL','F-HUVM','F-HUVN','F-HUVO','F-HUVP','F-HUVQ','F-HUVR','F-HUVS','F-HUVT'
      ];
      save(); renderFleet(); alert('Exemple flotte chargé.');
    });

    // ----------- Visit header render/bind
    function renderHeader(){
      v_check.value = v.check||'A1';
      v_arrival.value = v.arrival||'';
      v_departure.value = v.departure||'';
      v_hmo_plan.value = v.hmo_plan ?? '';
      v_hmo_real.value = v.hmo_real ?? '';
      renderBadges();
    }
    v_reg.addEventListener('change', ()=>{ v.reg=v_reg.value; save() });
    v_check.addEventListener('change', ()=>{ v.check=v_check.value; save() });
    v_arrival.addEventListener('input', ()=>{ v.arrival=v_arrival.value; save() });
    v_departure.addEventListener('input', ()=>{ v.departure=v_departure.value; save() });
    v_hmo_plan.addEventListener('input', ()=>{ v.hmo_plan=toNum(v_hmo_plan.value); save(); renderBadges() });
    v_hmo_real.addEventListener('input', ()=>{ v.hmo_real=toNum(v_hmo_real.value); save(); renderBadges() });

    function toNum(x){ const n=parseFloat(x); return isNaN(n)?null:n }

    // ----------- Staff table
    const VACATIONS = ['Matin','Soir','Nuit'];
    const ROLES = [
      {key:'cme',   label:'CME'},
      {key:'eir',   label:'EIR'},
      {key:'lead',  label:'Leader'},
    ];

    function renderStaff(){
      staffBody.innerHTML='';
      VACATIONS.forEach(vac=>{
        const tr=document.createElement('tr');
        const th=document.createElement('th'); th.textContent=vac; th.className='vac-label';
        tr.appendChild(th);
        ROLES.forEach(role=>{
          // demand
          tr.appendChild(makeStaffCell(vac, role.key, 'd'));
          // real
          tr.appendChild(makeStaffCell(vac, role.key, 'r'));
        });
        staffBody.appendChild(tr);
      });
      renderBadges();
    }

    function makeStaffCell(vac, role, kind){
      const td=document.createElement('td');
      const inp=document.createElement('input');
      inp.type='number'; inp.min='0'; inp.step='1';
      const k = role+'_'+(kind==='d'?'d':'r');
      inp.value = v.staff[vac][k] ?? 0;
      inp.dataset.vac = vac;
      inp.dataset.role = role;
      inp.dataset.kind = kind; // 'd' or 'r'
      inp.addEventListener('input', onStaffChange);
      td.appendChild(inp);
      return td;
    }

    function onStaffChange(e){
      const inp=e.target;
      const vac=inp.dataset.vac;
      const role=inp.dataset.role;
      const kind=inp.dataset.kind; // 'd' or 'r'
      const key = role+'_'+(kind==='d'?'d':'r');
      const val = Math.max(0, Math.floor(parseFloat(inp.value||0)));
      v.staff[vac][key] = val;

      // auto-fill: if real>0 and demand==0 => demand=1
      if(kind==='r' && val>0){
        const kd = role+'_d';
        if((v.staff[vac][kd]||0)===0){
          v.staff[vac][kd] = 1;
          // update paired input in DOM
          const sel = `input[data-vac="${vac}"][data-role="${role}"][data-kind="d"]`;
          const dInp = staffBody.querySelector(sel);
          if(dInp) dInp.value = 1;
        }
      }
      save(); renderBadges();
    }

    // ----------- Badges
    function renderBadges(){
      // Δ Effectif
      const effPlan = sumDemanded();
      const effReal = sumReal();
      const deltaEff = effReal - effPlan;
      badgeEff.textContent = `Δ effectif : ${deltaEff>=0?'+':''}${deltaEff}`;
      badgeEff.className = 'badge ' + (deltaEff===0?'':(deltaEff>0?'warn':'ok'));

      // Δ HMO
      const p = v.hmo_plan, r = v.hmo_real;
      if(p!=null && r!=null && p>0){
        const d = r - p;
        const pct = (d/p*100);
        badgeHmo.textContent = `Δ HMO : ${d>=0?'+':''}${d.toFixed(1)} h (${pct>=0?'+':''}${pct.toFixed(0)}%)`;
        badgeHmo.className = 'badge ' + (Math.abs(pct)<5 ? 'ok' : (pct>0 ? 'warn' : 'ok'));
      } else {
        badgeHmo.textContent='Δ HMO : —';
        badgeHmo.className='badge';
      }
    }

    function sumDemanded(){
      let s=0;
      VACATIONS.forEach(vac=>{
        const row=v.staff[vac];
        s += (row.cme_d||0)+(row.eir_d||0)+(row.lead_d||0);
      });
      return s;
    }
    function sumReal(){
      let s=0;
      VACATIONS.forEach(vac=>{
        const row=v.staff[vac];
        s += (row.cme_r||0)+(row.eir_r||0)+(row.lead_r||0);
      });
      return s;
    }

    // ----------- Export / Import
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rex-planning-a350.json'; a.click(); URL.revokeObjectURL(a.href);
    });

    document.getElementById('importFile').addEventListener('change', (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          const obj=JSON.parse(r.result);
          if(obj.visits && Array.isArray(obj.visits)){
            data.visits=obj.visits;
            if(Array.isArray(obj.fleet)) data.fleet=obj.fleet;
            // reset current visit ref
            v = data.visits[0];
            if(!v.staff){ v.staff = {
              Matin:{cme_d:0,cme_r:0,eir_d:0,eir_r:0,lead_d:0,lead_r:0},
              Soir:{cme_d:0,cme_r:0,eir_d:0,eir_r:0,lead_d:0,lead_r:0},
              Nuit:{cme_d:0,cme_r:0,eir_d:0,eir_r:0,lead_d:0,lead_r:0},
            }; }
            save(); renderFleet(); renderHeader(); renderStaff();
            alert('Import réussi.');
          } else alert('Fichier invalide');
        }catch(err){ alert('Erreur JSON'); }
      };
      r.readAsText(f);
    });

    // ----------- Init
    function init(){
      renderFleet();
      renderHeader();
      renderStaff();
    }
    init();
  </script>
</body>
</html>
