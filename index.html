<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>REX A350 ‚Äì Check A</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#e9eef6; --panel:#ffffff; --muted:#eef3fb; --text:#0b1220; --accent:#2563eb;
  --ok:#16a34a; --bad:#dc2626; --line:#d1d9e6;
  --prevue:#0ea5e9; /* bleu clair pr√©vue */
  --reel:#dc2626;   /* rouge r√©el */
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto}
.wrap{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
aside{background:var(--muted);border-right:1px solid var(--line);padding:16px 12px}
main{padding:16px}
h1{margin:0 0 12px;font-size:20px}
h2{margin:0 0 8px;font-size:16px}
.menu h3{font-size:12px;letter-spacing:.08em;color:#334155;margin:0 0 10px;text-transform:uppercase}
.menu button{display:block;width:100%;text-align:left;background:#f5f8ff;border:1px solid var(--line);color:var(--text);
  padding:10px 12px;margin:6px 0;border-radius:10px;cursor:pointer}
.menu button.active{outline:2px solid var(--accent)}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:repeat(3,1fr)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,select,textarea{width:100%;background:#fff;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px}
input[type="number"]{text-align:right}
input[data-clearzero="1"]::placeholder{color:#94a3b8}
input[data-clearzero="1"] {caret-color:#111}
.btn{border:1px solid var(--line);background:#f5f8ff;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.ok{background:#e8f7ee;border-color:#b7e3c6;color:#065f46}
.btn.bad{background:#fde8e8;border-color:#fecaca;color:#7f1d1d}
.btn.fuse{background:#eefcef;border-color:#bbf7d0;color:#14532d;font-weight:600}
.btn.primary{background:#e7efff;border-color:#bfdbfe;color:#1e3a8a}
.btn.ghost{background:transparent}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--line);padding:8px;text-align:right}
th:first-child,td:first-child{text-align:left}
thead th{background:#f7faff;position:sticky;top:0;z-index:1}
.small{font-size:12px;opacity:.9;color:#334155}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .pill{padding:8px 10px;border-radius:999px;background:#f5f8ff;border:1px solid var(--line)}
.hidden{display:none}
.topbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:12px}
.tag{font-size:11px;opacity:.9;padding:2px 6px;border:1px solid var(--line);border-radius:999px;background:#fff}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px}
label .pill{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid var(--line);display:inline-block;margin-left:6px}
.p-prevue{color:var(--prevue);border-color:currentColor}
.p-reel{color:var(--reel);border-color:currentColor}
dialog{border:none;border-radius:12px;max-width:800px;width:clamp(300px,90vw,800px);background:#fff;color:var(--text);box-shadow:0 10px 30px rgba(0,0,0,.2)}
dialog .head{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
dialog .body{padding:12px 14px}
.chart-wrap{height:320px; max-height:50vh;}
.chart-wrap canvas{width:100% !important; height:100% !important; display:block;}
</style>
</head>
<body>
<div class="wrap">
  <aside>
    <div class="menu">
      <h3>REX A350</h3>
      <button class="active" data-tab="visit">üõ†Ô∏è Visite</button>
      <button data-tab="problems">üìö Probl√®mes</button>
      <button data-tab="perf">üìä Performance</button>
    </div>
  </aside>

  <main>
    <div class="topbar">
      <button id="exportJson" class="btn">Exporter JSON</button>
      <input id="importJsonFile" type="file" accept="application/json" class="hidden">
      <button id="importJsonBtn" class="btn">Importer (remplacer)</button>
      <input id="mergeJsonFile" type="file" accept="application/json" class="hidden">
      <button id="mergeJsonBtn" class="btn fuse">Importer / Fusionner JSON</button>
    </div>

    <!-- VISITE -->
    <section id="tab-visit">
      <h1>Visite (Check A)</h1>

      <!-- Liste des visites -->
      <div class="card">
        <div class="row" style="align-items:end">
          <div style="flex:1">
            <h2 style="margin:0">Liste des visites</h2>
            <span class="small tag">Cliquer ‚ÄúOuvrir‚Äù charge le formulaire</span>
          </div>
          <!-- üîé Recherche TRFX -->
          <div>
            <label>Recherche TRFX</label>
            <input id="visitSearchTrfx" placeholder="ex. TRFX-2025-001">
          </div>
          <button id="btnVisitFilter" class="btn">Filtrer</button>
          <button id="btnVisitClear" class="btn">Effacer filtre</button>
          <button id="btnNewVisit" class="btn ok">+ Nouvelle visite</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="visitsTable">
            <thead>
              <tr>
                <th>#</th><th>TRFX</th><th>Immat</th><th>Check</th>
                <th>Arr. pr√©v</th><th>APRS sign√© (pr√©v.)</th>
                <th>Arr. r√©el</th><th>APRS sign√© (r√©el)</th>
                <th>HMO plan</th><th>HMO r√©el</th><th>Œî HMO</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="visitsBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Informations visite</h2>

        <!-- Ligne 1 : Immat + TRFX (obligatoire) + Check -->
        <div class="grid cols-3">
          <div>
            <label>Immatriculation</label>
            <input id="vImmat" list="immatList" placeholder="ex. F-HUVK">
            <datalist id="immatList"></datalist>
          </div>
          <div>
            <label>TRFX de la visite <span class="badge" style="color:#b45309;border-color:#f59e0b;background:#fff8e1">Obligatoire</span></label>
            <input id="vTrfx" placeholder="ex. TRFX-2025-001">
          </div>
          <div>
            <label>Type de check</label>
            <select id="vCheck">
              <option>A1</option><option>A2</option><option>A3</option><option>A4</option>
              <option>A5</option><option>A6</option><option>A7</option><option>A8</option>
              <option>A9</option><option>A10</option><option>A11</option><option>A12</option>
            </select>
          </div>
        </div>

        <!-- Ligne 2 : Arr pr√©v + Arr r√©el -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label>Arriv√©e pr√©vue <span class="pill p-prevue">Pr√©vue</span></label>
            <input id="vArrPrev" type="datetime-local">
          </div>
          <div>
            <label>Arriv√©e r√©elle <span class="pill p-reel">R√©el</span></label>
            <input id="vArrReal" type="datetime-local">
          </div>
        </div>

        <!-- Ligne 3 : APRS pr√©vu + APRS r√©el -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label>APRS sign√© (pr√©v.) <span class="pill p-prevue">Pr√©vue</span></label>
            <input id="vDepPrev" type="datetime-local">
          </div>
          <div>
            <label>APRS sign√© (r√©el) <span class="pill p-reel">R√©el</span></label>
            <input id="vDepReal" type="datetime-local">
          </div>
        </div>

        <!-- Ligne 4 : HMO plan + HMO r√©el -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label>HMO pr√©vue (h) <span class="pill p-prevue">Pr√©vue</span></label>
            <input id="vHmoPlan" type="number" min="0" step="0.5" value="0" data-clearzero="1" placeholder="0">
          </div>
          <div>
            <label>HMO r√©elle (h) <span class="pill p-reel">R√©el</span></label>
            <input id="vHmoReal" type="number" min="0" step="0.5" value="0" data-clearzero="1" placeholder="0">
          </div>
        </div>

        <!-- Ligne 5 : Nb pr√©l√®vements (manuel cumul√©) + bouton ajout TRFX pr√©l√®vements -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label>Nombre de pr√©l√®vements (auto)</label>
            <input id="vPrelCount" type="number" value="0" disabled>
          </div>
          <div class="row">
            <button id="btnAddPrelevement" class="btn">+ Ajouter un TRFX de pr√©l√®vement</button>
            <span class="small">Saisie TRFX un par un, cumul automatique.</span>
          </div>
        </div>

        <!-- Liste pr√©l√®vements -->
        <div id="prelListWrap" class="row" style="margin-top:4px;flex-wrap:wrap;gap:6px"></div>

        <!-- Ligne 6 : PF / BORO -->
        <div class="grid cols-2" style="margin-top:8px">
          <label class="row"><input id="vHasPF" type="checkbox"> PF pr√©sent ?</label>
          <label class="row"><input id="vHasBORO" type="checkbox"> BORO pr√©sent ?</label>
        </div>

        <!-- Ligne 7 : Lignes d√©sassign√©es (tableau d√©taill√©) -->
        <div class="card" style="margin-top:10px">
          <div class="row">
            <h3 style="margin:0">D√©sassignations (d√©tails)</h3>
            <button id="btnAddUnassign" class="btn">+ Ajouter une ligne</button>
          </div>
          <div style="overflow:auto;margin-top:8px">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Qt√©</th><th>Raison</th><th>Skill</th><th></th>
                </tr>
              </thead>
              <tbody id="unassignBody"></tbody>
              <tfoot>
                <tr>
                  <th>Total</th><th id="unassignTotal">0</th><th colspan="3"></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Ligne 8 : Lignes fin de chantier -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label>Nb lignes fin de chantier</label>
            <input id="vEndLines" type="number" min="0" value="0" data-clearzero="1" placeholder="0">
          </div>
          <div>
            <label>Infos utiles (MXI / Poids avion ‚Äì jalon START)</label>
            <input id="vMxiStart" placeholder="ex. 180.2 t ‚Äì 124 lignes">
          </div>
        </div>

        <!-- Import XML -->
        <div class="row" style="margin-top:8px">
          <input id="xmlFile" type="file" accept=".xml">
          <button id="btnImportXml" class="btn primary">Importer XML (auto)</button>
          <span class="small" style="margin-left:auto">L‚ÄôXML peut pr√©remplir immat / TRFX / check / dates / HMO pr√©vue.</span>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Effectifs par vac</h2>
          <button id="btnAddVac" class="btn">+ Ajouter une vac</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="vacTable">
            <thead>
              <tr>
                <th>Vac</th><th>Type</th>
                <th>CME dem.</th><th>EIR dem.</th><th>Leader dem.</th><th>Eff. dem. total</th>
                <th>CME r√©el</th><th>EIR r√©el</th><th>Leader r√©el</th><th>Eff. r√©el total</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="vacBody"></tbody>
            <tfoot>
              <tr>
                <th>Total g√©n√©ral</th><th></th>
                <th id="tCmeD">0</th><th id="tEirD">0</th><th id="tLeadD">0</th><th id="tDem">0</th>
                <th id="tCmeR">0</th><th id="tEirR">0</th><th id="tLeadR">0</th><th id="tReal">0</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="pill">Œî Effectif : <b id="deltaEff">0</b></div>
          <div class="pill">Œî HMO : <b id="deltaHmoBadge">0.0 h</b></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnSaveVisit" class="btn ok">üíæ Enregistrer</button>
          <button id="btnSaveAsNew" class="btn primary">üÜï Enregistrer (nouvelle)</button>
          <button id="btnClearVisit" class="btn bad">üßπ Effacer le formulaire</button>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Probl√®mes li√©s √† cette visite</h2>
          <button id="btnLinkProblem" class="btn">+ Ajouter depuis la biblioth√®que</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table>
            <thead><tr><th>#</th><th>Titre</th><th>Cat.</th><th>Impact(h)</th><th>R√©c.</th><th></th></tr></thead>
            <tbody id="visitProblemsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PROBL√àMES -->
    <section id="tab-problems" class="hidden">
      <h1>Probl√®mes (REX)</h1>
      <div class="card">
        <h2>Ajouter un probl√®me</h2>
        <div class="grid cols-3">
          <div><label>Titre</label><input id="pTitle"></div>
          <div>
            <label>Cat√©gorie</label>
            <select id="pCat">
              <option>Cabine</option><option>Sous-traitance</option>
              <option>Query/Pr√©pa</option><option>Pi√®ces/Log</option>
              <option>Effectifs/Planif</option><option>Documentation</option>
              <option>Autre</option><option>Moyen Industriel</option>
            </select>
          </div>
          <div><label>Impact (h)</label><input id="pImpact" type="number" min="0" step="0.5" value="0" data-clearzero="1" placeholder="0"></div>
          <div><label>Acteur/Responsable</label><input id="pActor" placeholder="ex. Cabine, STT, Query, Planif‚Ä¶"></div>
          <div><label>R√©current</label><input id="pRecurring" type="checkbox"></div>
          <div class="cols-3" style="grid-column:1/-1"><label>Description</label><textarea id="pDesc" rows="3" placeholder="Contexte, sympt√¥mes, documents concern√©s‚Ä¶"></textarea></div>
        </div>
        <button id="btnAddProblem" class="btn ok">+ Enregistrer en biblioth√®que (non assign√©)</button>
      </div>

      <div class="card">
        <h2>Probl√®mes enregistr√©s</h2>
        <div class="row">
          <div><label>Recherche</label><input id="pbSearch" placeholder="titre/cat/acteur‚Ä¶"></div>
          <div><label>R√©currents seulement</label><input id="pbRecOnly" type="checkbox"></div>
          <div><label>D√©but</label><input id="fStart" type="date"></div>
          <div><label>Fin</label><input id="fEnd" type="date"></div>
          <div><label>Immat</label><input id="fImmat" placeholder="Toutes"></div>
          <div>
            <label>Type</label>
            <select id="fCheck"><option value="">Tous</option><option>A1</option><option>A2</option><option>A3</option><option>A4</option><option>A5</option><option>A6</option><option>A7</option><option>A8</option><option>A9</option><option>A10</option><option>A11</option><option>A12</option></select>
          </div>
          <div>
            <label>Cat√©gorie</label>
            <select id="fCat"><option value="">Toutes</option><option>Cabine</option><option>Sous-traitance</option><option>Query/Pr√©pa</option><option>Pi√®ces/Log</option><option>Effectifs/Planif</option><option>Documentation</option><option>Autre</option><option>Moyen Industriel</option></select>
          </div>
          <button id="btnFilterProblems" class="btn">Filtrer</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Probl√®me</th><th>Cat.</th><th>Impact(h)</th><th>R√©c.</th>
                <th>Assignations</th><th>%</th><th>Enregistr√©</th><th></th>
              </tr>
            </thead>
            <tbody id="problemsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PERFORMANCE -->
    <section id="tab-perf" class="hidden">
      <h1>Performance</h1>
      <div class="card">
        <div class="row">
          <div><label>D√©but</label><input id="pfStart" type="date"></div>
          <div><label>Fin</label><input id="pfEnd" type="date"></div>
          <div><label>Immat</label><input id="pfImmat" placeholder="Toutes"></div>
          <div>
            <label>Type</label>
            <select id="pfCheck"><option value="">Tous</option><option>A1</option><option>A2</option><option>A3</option><option>A4</option><option>A5</option><option>A6</option><option>A7</option><option>A8</option><option>A9</option><option>A10</option><option>A11</option><option>A12</option></select>
          </div>
          <button id="btnPerfRefresh" class="btn">Actualiser</button>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="pill">Respect planning (dep. r√©el ‚â§ pr√©vu) : <b id="kpiRespect">0%</b></div>
          <div class="pill">Œî HMO moyen : <b id="kpiHmo">0.0 h (0%)</b></div>
          <div class="pill">Œî effectif moyen : <b id="kpiEff">0%</b></div>
        </div>
      </div>
      <div class="grid cols-2">
        <div class="card">
          <h2>Pareto par cat√©gorie</h2>
          <table>
            <thead><tr><th>Cat√©gorie</th><th>Comptes</th><th>%</th><th>Cumul %</th></tr></thead>
            <tbody id="paretoBody"></tbody>
          </table>
        </div>
        <div class="card">
          <h2>R√©partition (camembert)</h2>
          <div class="chart-wrap">
            <canvas id="pie"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- S√©lecteur de probl√®mes -->
<dialog id="dlgPick">
  <div class="head">
    <div style="font-weight:600">Ajouter des probl√®mes √† la visite</div>
    <button class="btn" onclick="dlgPick.close()">Fermer</button>
  </div>
  <div class="body">
    <div class="row">
      <input id="pickSearch" placeholder="Rechercher (titre/cat/acteur)‚Ä¶" style="flex:1">
      <label class="row small"><input id="pickRec" type="checkbox"> R√©currents seulement</label>
      <button id="pickRefresh" class="btn">Rechercher</button>
    </div>
    <div style="max-height:50vh;overflow:auto;margin-top:10px">
      <table>
        <thead><tr><th>Choisir</th><th>Titre</th><th>Cat.</th><th>Impact</th><th>R√©c.</th></tr></thead>
        <tbody id="pickBody"></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="pickAdd" class="btn ok">+ Ajouter √† la visite</button>
      <span class="small" style="margin-left:auto;opacity:.9">Les √©l√©ments coch√©s seront ajout√©s avec confirmation.</span>
    </div>
  </div>
</dialog>

<script>
/* ======================= stockage & base immats (LS) ====================== */
const LS_KEY="rexA350_checkA_main";
const BASE_IMMATS=[
  "F-HTYA","F-HTYB","F-HTYC","F-HTYD","F-HTYE","F-HTYF","F-HTYG","F-HTYH",
  "F-HTYI","F-HTYJ","F-HTYK","F-HTYL","F-HTYM","F-HTYN","F-HTYO","F-HTYP",
  "F-HTYQ","F-HTYR","F-HTYS","F-HTYT","F-HUVA","F-HUVB","F-HUVC","F-HUVD",
  "F-HUVE","F-HUVF","F-HUVG","F-HUVH","F-HUVI","F-HUVJ","F-HUVK","F-HUVL",
  "F-HUVM","F-HUVN","F-HUVO","F-HUVP","F-HUVQ","F-HUVR","F-HUVS","F-HUVT",
  "F-HUVU"
];
function load(){ try{return JSON.parse(localStorage.getItem(LS_KEY))}catch{ return null } }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)) }
let state = load() || { immat:[...BASE_IMMATS], visits:[], problems:[] };
if(!Array.isArray(state.immat) || !state.immat.length) state.immat=[...BASE_IMMATS];
state.immat=Array.from(new Set([...state.immat,...BASE_IMMATS])).sort();

/* =============================== utilitaires ============================== */
const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
const num=v=>{const n=parseFloat(v);return isNaN(n)?0:n}
const within=(d,a,b)=>{ if(!d) return false; const t=new Date(d).getTime(); const ta=a?new Date(a).getTime():-1e15; const tb=b?new Date(b).getTime()+86399999:1e15; return t>=ta&&t<=tb }
function fmtDate(v){ if(!v) return "‚Äî"; const d=new Date(v); return isNaN(d)?"‚Äî":d.toLocaleString() }
function uuid(){ return Math.random().toString(36).slice(2,10) }

/* ================================ onglets ================================= */
$$('aside .menu button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('aside .menu button').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
    ['tab-visit','tab-problems','tab-perf'].forEach(id=>$('#'+id).classList.add('hidden'));
    $('#tab-'+btn.dataset.tab).classList.remove('hidden');
    if(btn.dataset.tab==='perf') renderPerf();
    if(btn.dataset.tab==='problems') renderProblems();
    if(btn.dataset.tab==='visit') { renderVisitsList(); }
  })
})

/* ============================= immats (datalist) ========================== */
function refreshImmatList(){
  const dl=$('#immatList'); dl.innerHTML='';
  state.immat.forEach(i=>{ const o=document.createElement('option'); o.value=i; dl.appendChild(o) })
}
refreshImmatList();

/* ========= helpers: clear zero in number fields when user types ========== */
document.addEventListener('focusin', (e)=>{
  if(e.target.matches('input[type="number"][data-clearzero="1"]')){
    if(e.target.value==="0"||e.target.value==="0.0") e.target.value="";
  }
});
document.addEventListener('focusout', (e)=>{
  if(e.target.matches('input[type="number"][data-clearzero="1"]')){
    if(e.target.value==="") e.target.value="0";
  }
});

/* ============================ vacations (table) =========================== */
const VAC_TYPES = ["Matin","Soir","Nuit"];
const vacBody=$('#vacBody');
function nextVacName(){
  const count = $$('#vacBody tr').length;
  return `Vac ${count+1}`;
}
function vacRow(name, type="Matin"){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="vacName" value="${name}"></td>
    <td>
      <select class="vacType">
        ${VAC_TYPES.map(v=>`<option ${v===type?'selected':''}>${v}</option>`).join('')}
      </select>
    </td>
    <td><input class="cmeD" type="number" min="0" value="0" data-clearzero="1" placeholder="0"></td>
    <td><input class="eirD" type="number" min="0" value="0" data-clearzero="1" placeholder="0"></td>
    <td><input class="leadD" type="number" min="0" value="0" data-clearzero="1" placeholder="0"></td>
    <td class="demTot">0</td>
    <td><input class="cmeR" type="number" min="0" value="0" data-clearzero="1" placeholder="0"></td>
    <td><input class="eirR" type="number" min="0" value="0" data-clearzero="1" placeholder="0"></td>
    <td><input class="leadR" type="number" min="0" value="0" data-clearzero="1" placeholder="0"></td>
    <td class="realTot">0</td>
    <td><button class="btn bad delVac">Retirer</button></td>`;
  vacBody.appendChild(tr);
  autoChainVacTypes();
  recalcTotals();
}
function seedVacs(){
  vacBody.innerHTML='';
  VAC_TYPES.forEach((t,i)=>vacRow(`Vac ${i+1}`, t));
}
seedVacs();

function autoChainVacTypes(){
  // encha√Æne les types √† partir de la 1√®re ligne
  const trs = $$('#vacBody tr');
  if(!trs.length) return;
  const firstType = $('.vacType', trs[0]).value;
  let idx = VAC_TYPES.indexOf(firstType);
  trs.forEach((tr,i)=>{
    if(i===0) return;
    idx = (idx+1)%VAC_TYPES.length;
    $('.vacType', tr).value = VAC_TYPES[idx];
  });
  // auto-nommage
  trs.forEach((tr,i)=>{ $('.vacName',tr).value = `Vac ${i+1}`; });
}

vacBody.addEventListener('input', e=>{ if(e.target.tagName==='INPUT') recalcTotals() });
vacBody.addEventListener('change', e=>{
  if(e.target.classList.contains('vacType')) autoChainVacTypes();
});
vacBody.addEventListener('click', e=>{
  if(e.target.classList.contains('delVac')){
    if(confirm('Retirer cette vac ?')){ e.target.closest('tr').remove(); recalcTotals(); autoChainVacTypes(); }
  }
});
$('#btnAddVac').onclick=()=>{
  // ajoute une vac encha√Æn√©e
  const trs = $$('#vacBody tr');
  let nextType = "Matin";
  if(trs.length){
    const lastType = $('.vacType', trs[trs.length-1]).value;
    nextType = VAC_TYPES[(VAC_TYPES.indexOf(lastType)+1)%VAC_TYPES.length];
  }
  vacRow(nextVacName(), nextType);
};

/* ========================== calculs (totaux & KPI) ======================== */
function recalcTotals(){
  let tCmeD=0,tEirD=0,tLeadD=0,tDem=0,tCmeR=0,tEirR=0,tLeadR=0,tReal=0;
  $$('#vacBody tr').forEach(tr=>{
    const cmeD=num($('.cmeD',tr).value), eirD=num($('.eirD',tr).value), leadD=num($('.leadD',tr).value);
    const cmeR=num($('.cmeR',tr).value), eirR=num($('.eirR',tr).value), leadR=num($('.leadR',tr).value);
    const demTot=cmeD+eirD+leadD, realTot=cmeR+eirR+leadR;
    $('.demTot',tr).textContent=demTot; $('.realTot',tr).textContent=realTot;
    tCmeD+=cmeD; tEirD+=eirD; tLeadD+=leadD; tDem+=demTot;
    tCmeR+=cmeR; tEirR+=eirR; tLeadR+=leadR; tReal+=realTot;
  });
  $('#tCmeD').textContent=tCmeD; $('#tEirD').textContent=tEirD; $('#tLeadD').textContent=tLeadD; $('#tDem').textContent=tDem;
  $('#tCmeR').textContent=tCmeR; $('#tEirR').textContent=tEirR; $('#tLeadR').textContent=tLeadR; $('#tReal').textContent=tReal;

  const dEff=tReal - tDem;
  $('#deltaEff').textContent=dEff;

  const dHmo = num($('#vHmoReal').value) - num($('#vHmoPlan').value);
  $('#deltaHmoBadge').textContent = dHmo.toFixed(1)+' h';
}
;['vHmoPlan','vHmoReal'].forEach(id=> $('#'+id).addEventListener('input', recalcTotals));

/* ====================== D√©sassignations (tableau d√©tail) ================== */
const unTb = $('#unassignBody');
function unassignRow(q=0, reason='', skill='SKILL CABB'){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td></td>
    <td><input class="unQty" type="number" min="0" value="${q}" data-clearzero="1" placeholder="0"></td>
    <td><input class="unReason" value="${reason}"></td>
    <td>
      <select class="unSkill">
        <option ${skill==='SKILL CABB'?'selected':''}>SKILL CABB</option>
        <option ${skill==='SKILL B1/B2'?'selected':''}>SKILL B1/B2</option>
      </select>
    </td>
    <td><button class="btn bad unDel">Retirer</button></td>`;
  unTb.appendChild(tr);
  renumUnassign(); calcUnassignTotal();
}
function renumUnassign(){
  $$('#unassignBody tr').forEach((tr,i)=>{ tr.firstElementChild.textContent = i+1; });
}
function calcUnassignTotal(){
  let s=0; $$('.unQty').forEach(i=> s+=num(i.value));
  $('#unassignTotal').textContent=s;
}
$('#btnAddUnassign').onclick=()=>unassignRow();
unTb.addEventListener('input', (e)=>{ if(e.target.classList.contains('unQty')) calcUnassignTotal(); });
unTb.addEventListener('click', (e)=>{
  if(e.target.classList.contains('unDel')){ e.target.closest('tr').remove(); renumUnassign(); calcUnassignTotal(); }
});

/* =============================== pr√©l√®vements ============================= */
const prelWrap = $('#prelListWrap');
function refreshPrelCount(){
  $('#vPrelCount').value = $$('#prelListWrap .badge').length;
}
$('#btnAddPrelevement').onclick=()=>{
  const code = prompt('TRFX de pr√©l√®vement (ex. TRFX-PR-001) :');
  if(!code) return;
  const span = document.createElement('span');
  span.className='badge';
  span.textContent=code.trim();
  span.title='Cliquer pour retirer';
  span.style.cursor='pointer';
  span.onclick=()=>{ span.remove(); refreshPrelCount(); }
  prelWrap.appendChild(span);
  refreshPrelCount();
};

/* =============================== Import XML =============================== */
$('#btnImportXml').onclick=()=>{
  const f=$('#xmlFile').files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const xml=new DOMParser().parseFromString(r.result,'text/xml');
      const tx=r.result;

      // immat (F-Hxxx‚Ä¶)
      const m = tx.match(/F-?H[A-Z0-9]{3}/i);
      if(m) $('#vImmat').value = m[0].toUpperCase().replace(/^F(H)/,'F-$1');

      // TRFX (motif simple ‚ÄúTRFX-‚Ä¶‚Äù si pr√©sent)
      const mt = tx.match(/TRFX[-_ ]?[A-Z0-9\-_/]+/i);
      if(mt) $('#vTrfx').value = mt[0].toUpperCase().replace(/[_ ]/g,'-');

      // check si balise/attribut connu(e)
      const guess = xml.querySelector('Check,Type,VisitType');
      if(guess && guess.textContent) $('#vCheck').value = (guess.textContent.match(/A\d{1,2}/)||['A1'])[0];

      // dates (arriv√©e pr√©vue / APRS pr√©vu) : premiers ISO d√©tect√©s
      const isos = tx.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}/g) || [];
      if(isos[0]) $('#vArrPrev').value = isos[0].replace(' ','T');
      if(isos[1]) $('#vDepPrev').value = isos[1].replace(' ','T');

      // HMO pr√©vue si balises probables
      const getNumNode = sel => {
        const n=xml.querySelector(sel); if(!n) return NaN;
        const v=parseFloat(n.textContent||n.getAttribute('value')); return isNaN(v)?NaN:v;
      }
      let hPlan = getNumNode('HMOPlan, HmoPlan, PlanHMO, HMO_Plan');
      if(!isFinite(hPlan)) hPlan = 0;
      $('#vHmoPlan').value = hPlan;
      recalcTotals();
      alert('XML import√© ‚úÖ (immat / TRFX / check / dates pr√©vues / HMO pr√©vue)');
    }catch(e){ alert('XML invalide'); }
  };
  r.readAsText(f);
};

/* ========================= Enregistrer / Brouillon ======================== */
let currentVisitId = null;

function collectUnassign(){
  return $$('#unassignBody tr').map(tr=>({
    qty: num($('.unQty',tr).value),
    reason: $('.unReason',tr).value.trim(),
    skill: $('.unSkill',tr).value
  }));
}
function collectPrelevements(){
  return $$('#prelListWrap .badge').map(b=>b.textContent.trim());
}
function collectVacs(){
  return $$('#vacBody tr').map(tr=>({
    name:$(".vacName",tr).value.trim(),
    type:$(".vacType",tr).value,
    cmeDem:num($('.cmeD',tr).value), eirDem:num($('.eirD',tr).value), leadDem:num($('.leadD',tr).value),
    cmeReal:num($('.cmeR',tr).value), eirReal:num($('.eirR',tr).value), leadReal:num($('.leadR',tr).value)
  }));
}
function collectVisitFromForm(){
  return {
    id: currentVisitId || uuid(),
    trfx: $('#vTrfx').value.trim(),                 // üî¥ obligatoire
    immat: $('#vImmat').value.trim().toUpperCase(),
    check: $('#vCheck').value,
    arrPrev: $('#vArrPrev').value || null,
    arrReal: $('#vArrReal').value || null,
    depPrev: $('#vDepPrev').value || null,          // APRS sign√© (pr√©v.)
    depReal: $('#vDepReal').value || null,          // APRS sign√© (r√©el)
    hmoPlan: num($('#vHmoPlan').value),
    hmoReal: num($('#vHmoReal').value),
    hasPF: $('#vHasPF').checked,
    hasBORO: $('#vHasBORO').checked,
    prelevements: collectPrelevements(),
    unassign: collectUnassign(),                     // d√©tail
    endLines: num($('#vEndLines').value),
    mxiStart: $('#vMxiStart').value.trim(),
    vacs: collectVacs(),
    problems: (getCurrentVisit()?.problems)||[],
    createdAt: getCurrentVisit()?.createdAt || new Date().toISOString()
  };
}
function getCurrentVisit(){ return state.visits.find(v=>v.id===currentVisitId) || null; }

function renderFormFromVisit(v){
  currentVisitId = v?.id || null;
  $('#vTrfx').value = v?.trfx||'';
  $('#vImmat').value = v?.immat||'';
  $('#vCheck').value = v?.check||'A1';
  $('#vArrPrev').value = v?.arrPrev||'';
  $('#vArrReal').value = v?.arrReal||'';
  $('#vDepPrev').value = v?.depPrev||'';
  $('#vDepReal').value = v?.depReal||'';
  $('#vHmoPlan').value = v?.hmoPlan??0;
  $('#vHmoReal').value = v?.hmoReal??0;
  $('#vHasPF').checked = !!v?.hasPF;
  $('#vHasBORO').checked = !!v?.hasBORO;
  // pr√©l√®vements
  prelWrap.innerHTML='';
  (v?.prelevements||[]).forEach(code=>{
    const span=document.createElement('span');
    span.className='badge'; span.textContent=code; span.style.cursor='pointer';
    span.title='Cliquer pour retirer'; span.onclick=()=>{ span.remove(); refreshPrelCount(); }
    prelWrap.appendChild(span);
  });
  refreshPrelCount();
  // unassign
  unTb.innerHTML='';
  (v?.unassign||[]).forEach(x=> unassignRow(x.qty,x.reason,x.skill));
  if(!(v?.unassign?.length)) renumUnassign(), calcUnassignTotal();
  // fin chantier / MXI
  $('#vEndLines').value = v?.endLines??0;
  $('#vMxiStart').value = v?.mxiStart||'';
  // vacs
  vacBody.innerHTML='';
  (v?.vacs?.length?v.vacs:[{name:'Vac 1',type:'Matin'},{name:'Vac 2',type:'Soir'},{name:'Vac 3',type:'Nuit'}]).forEach(x=>{
    vacRow(x.name||'', x.type||'Matin');
    const tr=vacBody.lastElementChild;
    $('.cmeD',tr).value=x.cmeDem||0; $('.eirD',tr).value=x.eirDem||0; $('.leadD',tr).value=x.leadDem||0;
    $('.cmeR',tr).value=x.cmeReal||0; $('.eirR',tr).value=x.eirReal||0; $('.leadR',tr).value=x.leadReal||0;
  });
  autoChainVacTypes(); recalcTotals();
  renderVisitProblems(v||{problems:[]});
}

function validateVisit(v){
  if(!v.trfx){ alert('TRFX obligatoire pour la visite. Merci de renseigner le champ.'); $('#vTrfx').focus(); return false; }
  return true;
}

$('#btnSaveVisit').onclick=()=>{
  const v = collectVisitFromForm();
  if(!validateVisit(v)) return;
  const idx = state.visits.findIndex(x=>x.id===v.id);
  if(idx>=0) state.visits[idx]=v; else state.visits.push(v);
  if(v.immat && !state.immat.includes(v.immat)){ state.immat.push(v.immat); refreshImmatList(); }
  save(); renderVisitsList();
  alert('Visite enregistr√©e ‚úÖ');
};

$('#btnSaveAsNew').onclick=()=>{
  const prevId = currentVisitId;
  currentVisitId = null;
  const v = collectVisitFromForm();
  if(!validateVisit(v)) { currentVisitId = prevId; return; }
  state.visits.push(v);
  if(v.immat && !state.immat.includes(v.immat)){ state.immat.push(v.immat); refreshImmatList(); }
  save(); renderVisitsList();
  renderFormFromVisit(v);
  alert('Nouvelle visite enregistr√©e ‚úÖ');
};

$('#btnClearVisit').onclick=()=>{
  if(!confirm('Effacer le formulaire en cours ?')) return;
  currentVisitId=null;
  ['vTrfx','vImmat','vArrPrev','vArrReal','vDepPrev','vDepReal','vMxiStart'].forEach(id=> $('#'+id).value='');
  $('#vCheck').value='A1';
  ['vHmoPlan','vHmoReal','vEndLines'].forEach(id=> $('#'+id).value=0);
  $('#vHasPF').checked=false; $('#vHasBORO').checked=false;
  prelWrap.innerHTML=''; refreshPrelCount();
  unTb.innerHTML=''; renumUnassign(); calcUnassignTotal();
  seedVacs(); recalcTotals(); renderVisitProblems({problems:[]});
};

$('#btnNewVisit').onclick=()=>{
  if(!confirm('Cr√©er une nouvelle visite (brouillon vide) ?')) return;
  const v={ id:uuid(), trfx:'', immat:'', check:'A1',
    arrPrev:null, arrReal:null, depPrev:null, depReal:null,
    hmoPlan:0, hmoReal:0, hasPF:false, hasBORO:false,
    prelevements:[], unassign:[], endLines:0, mxiStart:'',
    vacs:[{name:'Vac 1',type:'Matin',cmeDem:0,eirDem:0,leadDem:0,cmeReal:0,eirReal:0,leadReal:0},
          {name:'Vac 2',type:'Soir',cmeDem:0,eirDem:0,leadDem:0,cmeReal:0,eirReal:0,leadReal:0},
          {name:'Vac 3',type:'Nuit',cmeDem:0,eirDem:0,leadDem:0,cmeReal:0,eirReal:0,leadReal:0}],
    problems:[], createdAt:new Date().toISOString()
  };
  state.visits.push(v); save();
  renderVisitsList(); renderFormFromVisit(v);
};

/* ============================ Liste des visites =========================== */
function renderVisitsList(){
  const tb=$('#visitsBody'); tb.innerHTML='';
  const qTRFX = ($('#visitSearchTrfx').value||'').trim().toLowerCase();
  const list = state.visits.slice().filter(v=> !qTRFX || (v.trfx||'').toLowerCase().includes(qTRFX)).reverse();
  list.forEach((v,idx)=>{
    const dH = (v.hmoReal||0)-(v.hmoPlan||0);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${list.length-idx}</td>
      <td>${v.trfx||'‚Äî'}</td>
      <td>${v.immat||'‚Äî'}</td>
      <td>${v.check||'A?'}</td>
      <td>${fmtDate(v.arrPrev)}</td>
      <td>${fmtDate(v.depPrev)}</td>
      <td>${fmtDate(v.arrReal)}</td>
      <td>${fmtDate(v.depReal)}</td>
      <td>${v.hmoPlan||0}</td>
      <td>${v.hmoReal||0}</td>
      <td>${(dH>0?'+':'')+(dH||0)}</td>
      <td>
        <button class="btn" data-act="open" data-id="${v.id}">Ouvrir</button>
        <button class="btn" data-act="pbl" data-id="${v.id}">Probl√®mes</button>
        <button class="btn bad" data-act="del" data-id="${v.id}">Supprimer</button>
      </td>`;
    tb.appendChild(tr);
  });
}
renderVisitsList();
$('#btnVisitFilter').onclick=renderVisitsList;
$('#btnVisitClear').onclick=()=>{ $('#visitSearchTrfx').value=''; renderVisitsList(); };

$('#visitsTable').addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.id; const act=b.dataset.act;
  const v=state.visits.find(x=>x.id===id); if(!v) return;
  if(act==='open'){ renderFormFromVisit(v); }
  if(act==='pbl'){ openPickDialogFor(id); }
  if(act==='del'){
    if(confirm('Supprimer d√©finitivement cette visite ? Cette action affecte les statistiques REX.')){
      state.visits=state.visits.filter(x=>x.id!==id); save(); renderVisitsList();
      if(currentVisitId===id){ $('#btnClearVisit').click(); }
    }
  }
});

/* ==================== Probl√®mes li√©s √† une visite (table) ================= */
function renderVisitProblems(v){
  const tb=$('#visitProblemsBody'); tb.innerHTML='';
  (v.problems||[]).forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${p.title}</td><td>${p.cat||'‚Äî'}</td><td>${p.impact||0}</td><td>${p.recurring?'Oui':'Non'}</td>
    <td><button class="btn bad" data-i="${i}">Retirer</button></td>`;
    tb.appendChild(tr);
  });
}
$('#visitProblemsBody').addEventListener('click',(e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const i=Number(b.dataset.i);
  const v=getCurrentVisit(); if(!v) return alert('Aucune visite charg√©e');
  if(confirm('Retirer ce probl√®me de la visite ?')){
    v.problems.splice(i,1); save(); renderVisitProblems(v);
  }
});

/* ===================== Biblioth√®que Probl√®mes (ajout & filtres) =========== */
$('#btnAddProblem').onclick=()=>{
  const title=$('#pTitle').value.trim(); if(!title) return alert('Titre manquant');
  const p={
    id: uuid(),
    title, cat:$('#pCat').value, impact:num($('#pImpact').value), actor:$('#pActor').value.trim(),
    recurring:$('#pRecurring').checked, desc:$('#pDesc').value.trim(),
    immat:'', check:'', ts:new Date().toISOString()
  };
  state.problems.push(p); save();
  $('#pTitle').value=''; $('#pImpact').value=0; $('#pActor').value=''; $('#pRecurring').checked=false; $('#pDesc').value='';
  renderProblems();
};
function filterProblemsList(list){
  const q=$('#pbSearch').value.trim().toLowerCase();
  const rec=$('#pbRecOnly').checked;
  const s=$('#fStart').value, e=$('#fEnd').value, im=($('#fImmat').value||'').toUpperCase(), ck=$('#fCheck').value, cat=$('#fCat').value;
  return list.filter(p=>{
    const inQ=!q || (p.title+p.cat+(p.actor||'')+(p.desc||'')).toLowerCase().includes(q);
    const inRec=!rec || !!p.recurring;
    const inP = within(p.ts,s||null,e||null);
    const inI = im? p.immat===im : true;
    const inC = ck? p.check===ck : true;
    const inCat = cat? p.cat===cat : true;
    return inQ && inRec && inP && inI && inC && inCat;
  });
}
function countAssignments(pid, visitsSubset=null){
  const visits = Array.isArray(visitsSubset) ? visitsSubset : state.visits;
  let n = 0;
  visits.forEach(v=>{
    if(Array.isArray(v.problems)){
      n += v.problems.filter(x=>x.pid === pid).length;
    }
  });
  return n;
}
function renderProblems(){
  const tbody = document.getElementById('problemsBody');
  tbody.innerHTML = '';
  const filtered = filterProblemsList(state.problems);
  const totalAssign = filtered.reduce((acc,p)=> acc + countAssignments(p.id), 0) || 1;
  filtered.forEach((p,i)=>{
    const assigns = countAssignments(p.id);
    const pct = Math.round(assigns * 100 / totalAssign);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${p.title}</td>
      <td>${p.cat}</td>
      <td>${p.impact||0}</td>
      <td>${p.recurring?'Oui':'Non'}</td>
      <td>${assigns}</td>
      <td>${pct}%</td>
      <td>${new Date(p.ts).toLocaleString()}</td>
      <td><button class="btn bad" data-del="${p.id}">Supprimer</button></td>
    `;
    tbody.appendChild(tr);
  });
}
document.getElementById('problemsBody').addEventListener('click', (e)=>{
  const id = e.target?.dataset?.del;
  if(!id) return;
  const cascade = confirm("Supprimer ce probl√®me de la biblioth√®que ?\n\nOK = supprime aussi ce probl√®me de toutes les visites.");
  state.problems = state.problems.filter(p => p.id !== id);
  if (cascade) {
    state.visits.forEach(v=>{
      if (Array.isArray(v.problems)) v.problems = v.problems.filter(x => x.pid !== id);
    });
  }
  save(); renderProblems();
  const v = state.visits.find(x => x.id === (currentVisitId||'')); if (v) renderVisitProblems(v);
  alert('Probl√®me supprim√© ‚úÖ' + (cascade ? ' (et retir√© des visites)' : ''));
});
$('#btnFilterProblems').onclick=renderProblems;
renderProblems();

/* ================ Dialog: assigner probl√®mes √† une visite ================= */
const dlgPick = $('#dlgPick');
function openPickDialogFor(visitId){
  const v = state.visits.find(x=>x.id===visitId); if(!v) return;
  currentVisitId = visitId;
  $('#pickSearch').value=''; $('#pickRec').checked=false;
  renderPickList();
  dlgPick.showModal();
}
function renderPickList(){
  const tb=$('#pickBody'); tb.innerHTML='';
  const q=$('#pickSearch').value.trim().toLowerCase();
  const rec=$('#pickRec').checked;
  state.problems.filter(p=>{
    const inQ=!q || (p.title+p.cat+(p.actor||'')+(p.desc||'')).toLowerCase().includes(q);
    const inRec=!rec || !!p.recurring;
    return inQ && inRec;
  }).forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="text-align:center"><input type="checkbox" data-id="${p.id}"></td>
      <td>${p.title}</td><td>${p.cat||'‚Äî'}</td><td>${p.impact||0}</td><td>${p.recurring?'Oui':'Non'}</td>`;
    tb.appendChild(tr);
  });
}
$('#pickRefresh').onclick=renderPickList;
$('#pickAdd').onclick=()=>{
  const v=getCurrentVisit(); if(!v) return alert('Aucune visite charg√©e');
  const ids=$$('#pickBody input[type="checkbox"]:checked').map(x=>x.dataset.id);
  if(!ids.length) return alert('S√©lectionne au moins un probl√®me.');
  if(!confirm(`Ajouter ${ids.length} probl√®me(s) √† cette visite ?`)) return;
  const toAdd = state.problems.filter(p=>ids.includes(p.id)).map(p=>({
    pid:p.id, title:p.title, cat:p.cat, impact:p.impact, recurring:!!p.recurring
  }));
  v.problems = (v.problems||[]).concat(toAdd);
  save(); renderVisitProblems(v); dlgPick.close();
}

/* ============================ Export / Import JSON ======================== */
$('#exportJson').onclick=()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rex-a350.json'; a.click();
}
$('#importJsonBtn').onclick=()=>$('#importJsonFile').click();
$('#importJsonFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const d=JSON.parse(r.result);
      if(d && d.visits && d.problems){
        if(!confirm('Remplacer enti√®rement les donn√©es locales par ce JSON ?')) return;
        state=d;
        state.immat=Array.from(new Set([...(state.immat||[]), ...BASE_IMMATS])).sort();
        save(); refreshImmatList(); renderProblems(); renderPerf(); renderVisitsList();
        alert('Import (remplacement) OK ‚úÖ');
      } else alert('JSON invalide');
    }catch{ alert('Erreur JSON'); }
  };
  r.readAsText(f);
});
$('#mergeJsonBtn').onclick=()=>$('#mergeJsonFile').click();
$('#mergeJsonFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const incoming=JSON.parse(r.result);
      if(!(incoming && (incoming.visits||incoming.problems||incoming.immat))) return alert('JSON sans contenu utile');
      const before = JSON.stringify(state).length;
      if(Array.isArray(incoming.immat)) state.immat = Array.from(new Set([...state.immat, ...incoming.immat])).sort();
      if(Array.isArray(incoming.problems)){
        const byId = new Map(state.problems.map(p=>[p.id,p]));
        incoming.problems.forEach(p=>{
          if(p && p.id){
            if(!byId.has(p.id)) byId.set(p.id,p);
            else{
              const cur=byId.get(p.id);
              byId.set(p.id,{...cur,
                title:p.title||cur.title, cat:p.cat||cur.cat,
                impact:(typeof p.impact==='number')?p.impact:cur.impact,
                actor:p.actor||cur.actor, recurring:(typeof p.recurring==='boolean')?p.recurring:cur.recurring,
                desc:p.desc||cur.desc, immat:p.immat||cur.immat, check:p.check||cur.check, ts:p.ts||cur.ts
              });
            }
          }else{
            const cp={...p, id: uuid(), ts: p?.ts || new Date().toISOString()};
            byId.set(cp.id, cp);
          }
        });
        state.problems = Array.from(byId.values());
      }
      if(Array.isArray(incoming.visits)){
        const mapV = new Map(state.visits.map(v=>[v.id,v]));
        const keyOf = v => [v.trfx,v.immat,v.check,v.arrPrev,v.depPrev,v.hmoPlan].join('|');
        const seenKeys = new Set(state.visits.map(v=>keyOf(v)));
        incoming.visits.forEach(v=>{
          if(v && v.id && mapV.has(v.id)){
            const cur = mapV.get(v.id);
            const merged = {...cur, ...v,
              vacs: Array.isArray(v.vacs) ? v.vacs : cur.vacs,
              problems: Array.isArray(v.problems) ? v.problems : cur.problems,
              prelevements: Array.isArray(v.prelevements) ? v.prelevements : cur.prelevements,
              unassign: Array.isArray(v.unassign) ? v.unassign : cur.unassign
            };
            mapV.set(v.id, merged);
          } else {
            const k = keyOf(v||{});
            if(!seenKeys.has(k)){
              const nv = v && v.id ? v : {...v, id: uuid()};
              mapV.set(nv.id, nv);
              seenKeys.add(k);
            }
          }
        });
        state.visits = Array.from(mapV.values());
      }
      save(); refreshImmatList(); renderProblems(); renderPerf(); renderVisitsList();
      const after = JSON.stringify(state).length;
      alert('Fusion JSON termin√©e ‚úÖ (+'+ (after-before) +' octets env.)');
    }catch{ alert('Erreur JSON'); }
  };
  r.readAsText(f);
});

/* ================================ Performance ============================= */
let pie=null;
function renderPerf(){
  const s=$('#pfStart').value, e=$('#pfEnd').value, im=($('#pfImmat').value||'').toUpperCase(), ck=$('#pfCheck').value;
  const visits=state.visits.filter(v=> within(v.createdAt||v.arrPrev||v.arrReal||v.depPrev||v.depReal, s||null, e||null) && (im? v.immat===im:true) && (ck? v.check===ck:true));
  let res=0,tot=0, sumDH=0,sumHD=0, sumPctEff=0, cntPct=0;
  visits.forEach(v=>{
    if(v.depPrev && v.depReal){ tot++; if(new Date(v.depReal)<=new Date(v.depPrev)) res++; }
    const dH = (v.hmoReal||0) - (v.hmoPlan||0);
    sumDH += dH; sumHD += (v.hmoPlan||0);
    const dem = (v.vacs||[]).reduce((a,x)=>a+(x.cmeDem||0)+(x.eirDem||0)+(x.leadDem||0),0);
    const rea = (v.vacs||[]).reduce((a,x)=>a+(x.cmeReal||0)+(x.eirReal||0)+(x.leadReal||0),0);
    if(dem>0){ sumPctEff += ((rea-dem)/dem)*100; cntPct++; }
  });
  $('#kpiRespect').textContent = (tot? Math.round(res*100/tot):0)+'%';
  const avgDH = visits.length? (sumDH/visits.length):0;
  const pctDH = sumHD? Math.round(sumDH*100/sumHD):0;
  $('#kpiHmo').textContent = `${avgDH.toFixed(1)} h (${pctDH}%)`;
  $('#kpiEff').textContent = `${cntPct? Math.round(sumPctEff/cntPct):0}%`;

  const probs=state.problems.filter(p=> within(p.ts,s||null,e||null) && (im? p.immat===im:true) && (ck? p.check===ck:true));
  const byCat={}; probs.forEach(p=> byCat[p.cat]=(byCat[p.cat]||0)+1 );
  const arr=Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  const total=arr.reduce((a,[,c])=>a+c,0)||1;
  const pb=$('#paretoBody'); pb.innerHTML='';
  let cumul=0;
  arr.forEach(([cat,c])=>{
    const pc=Math.round(c*100/total); cumul+=pc;
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${cat}</td><td>${c}</td><td>${pc}%</td><td>${Math.min(cumul,100)}%</td>`;
    pb.appendChild(tr);
  });
  const ctx=$('#pie').getContext('2d'); if(pie) pie.destroy();
  pie=new Chart(ctx,{ type:'doughnut', data:{ labels:arr.map(x=>x[0]), datasets:[{ data:arr.map(x=>x[1]) }]}, options:{plugins:{legend:{position:'bottom'}},maintainAspectRatio:false} });
}
$('#btnPerfRefresh').onclick=renderPerf;

/* ================================ init UI ================================= */
function initialRender(){ refreshImmatList(); renderProblems(); renderVisitsList(); }
initialRender();
</script>
</body>
</html>
