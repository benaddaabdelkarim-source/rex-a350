<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>REX A350 ‚Äì Check A (clair + fusion JSON)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  /* Th√®me clair lisible */
  --bg:#e9eef6;           /* fond de page gris bleut√© doux */
  --panel:#ffffff;        /* cartes/panneaux blancs */
  --muted:#eef3fb;        /* fonds secondaires */
  --text:#0b1220;         /* texte principal sombre */
  --accent:#2563eb;       /* bleu pr√©vu */
  --real:#0f766e;         /* vert r√©el (teal fonc√©) */
  --ok:#16a34a;           /* vert ok */
  --bad:#dc2626;          /* rouge */
  --line:#d1d9e6;         /* bordures */
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto}
.wrap{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
aside{background:var(--muted);border-right:1px solid var(--line);padding:16px 12px}
main{padding:16px}
h1{margin:0 0 12px;font-size:20px}
h2{margin:0 0 8px;font-size:16px}
.menu h3{font-size:12px;letter-spacing:.08em;color:#334155;margin:0 0 10px;text-transform:uppercase}
.menu button{
  display:block;width:100%;text-align:left;
  background:#f5f8ff;border:1px solid var(--line);color:var(--text);
  padding:10px 12px;margin:6px 0;border-radius:10px;cursor:pointer
}
.menu button.active{outline:2px solid var(--accent)}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:1fr 1fr}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,select,textarea{
  width:100%;background:#fff;border:1px solid var(--line);color:var(--text);
  border-radius:10px;padding:10px
}
input[type="number"]{text-align:right}
input::placeholder, textarea::placeholder{color:#94a3b8}
input.clean-zeros::-webkit-outer-spin-button,
input.clean-zeros::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
.btn{
  border:1px solid var(--line);background:#f5f8ff;color:var(--text);
  border-radius:10px;padding:8px 12px;cursor:pointer
}
.btn.ok{background:#e8f7ee;border-color:#b7e3c6;color:#065f46}
.btn.bad{background:#fde8e8;border-color:#fecaca;color:#7f1d1d}
.btn.fuse{background:#eefcef;border-color:#bbf7d0;color:#14532d;font-weight:600}
.btn.primary{background:#e7efff;border-color:#bfdbfe;color:#1e3a8a}
.btn.ghost{background:transparent}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--line);padding:8px;text-align:right}
th:first-child,td:first-child{text-align:left}
thead th{background:#f7faff;position:sticky;top:0;z-index:1}
.small{font-size:12px;opacity:.9;color:#334155}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .pill{padding:8px 10px;border-radius:999px;background:#f5f8ff;border:1px solid var(--line)}
.hidden{display:none}
.topbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:12px}
.tag{font-size:11px;opacity:.9;padding:2px 6px;border:1px solid var(--line);border-radius:999px;background:#fff}

/* labels color√©s */
label.lbl-prev{font-weight:600;color:var(--accent)}
label.lbl-real{font-weight:600;color:var(--real)}
label.lbl-neutral{font-weight:600;color:#0b1220}

/* TRFX chips */
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef3fb;border:1px solid var(--line)}
.chip button{border:none;background:transparent;color:#7f1d1d;cursor:pointer}

dialog{border:none;border-radius:12px;max-width:800px;width:clamp(300px,90vw,800px);background:#fff;color:var(--text);box-shadow:0 10px 30px rgba(0,0,0,.2)}
dialog .head{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
dialog .body{padding:12px 14px}

/* Camembert responsive */
.chart-wrap{height:320px; max-height:50vh;}
.chart-wrap canvas{width:100% !important; height:100% !important; display:block;}
</style>
</head>
<body>
<div class="wrap">
  <aside>
    <div class="menu">
      <h3>REX A350</h3>
      <button class="active" data-tab="visit">üõ†Ô∏è Visite</button>
      <button data-tab="problems">üìö Probl√®mes</button>
      <button data-tab="perf">üìä Performance</button>
    </div>
  </aside>

  <main>
    <div class="topbar">
      <button id="exportJson" class="btn">Exporter JSON</button>
      <input id="importJsonFile" type="file" accept="application/json" class="hidden">
      <button id="importJsonBtn" class="btn">Importer (remplacer)</button>
      <input id="mergeJsonFile" type="file" accept="application/json" class="hidden">
      <button id="mergeJsonBtn" class="btn fuse">Importer / Fusionner JSON</button>
    </div>

    <!-- VISITE -->
    <section id="tab-visit">
      <h1>Visite (Check A)</h1>

      <!-- Liste des visites -->
      <div class="card">
        <div class="row">
          <h2 style="margin:0">Liste des visites</h2>
          <span class="small tag">Clique ‚ÄúOuvrir‚Äù pour charger dans le formulaire</span>
          <button id="btnNewVisit" class="btn ok">+ Nouvelle visite</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="visitsTable">
            <thead>
              <tr>
                <th>#</th><th>Immat</th><th>Check</th><th>Arr. pr√©v</th><th>APRS sign√© (pr√©v.)</th>
                <th>HMO plan</th><th>HMO r√©el</th><th>Œî HMO</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="visitsBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Informations visite</h2>

        <!-- Ligne 1 : Arriv√©e pr√©vue / Arriv√©e r√©elle -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label class="lbl-prev">Arriv√©e pr√©vue</label>
            <input id="vArrPrev" type="datetime-local">
          </div>
          <div>
            <label class="lbl-real">Arriv√©e r√©elle</label>
            <input id="vArrReal" type="datetime-local">
          </div>
        </div>

        <!-- Ligne 2 : APRS sign√© (pr√©vu) / APRS sign√© (r√©el) -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label class="lbl-prev">APRS sign√© (pr√©vu)</label>
            <input id="vAprsPrev" type="datetime-local">
          </div>
          <div>
            <label class="lbl-real">APRS sign√© (r√©el)</label>
            <input id="vAprsReal" type="datetime-local">
          </div>
        </div>

        <!-- Ligne 3 : HMO pr√©vue / HMO r√©elle -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label class="lbl-prev">HMO pr√©vue (h)</label>
            <input id="vHmoPlan" class="clean-zeros" type="number" min="0" step="0.5" placeholder="0">
          </div>
          <div>
            <label class="lbl-real">HMO r√©elle (h)</label>
            <input id="vHmoReal" class="clean-zeros" type="number" min="0" step="0.5" placeholder="0">
          </div>
        </div>

        <!-- Ligne 4 : Nb pr√©l√®vements / TRFX pr√©l√®vements (ajout un par un) -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label class="lbl-neutral">Nb pr√©l√®vements</label>
            <input id="vSamples" class="clean-zeros" type="number" min="0" step="1" placeholder="0">
          </div>
          <div>
            <label class="lbl-neutral">TRFX pr√©l√®vements (ajout un par un)</label>
            <div class="row" style="gap:8px">
              <input id="vTrfxInput" placeholder="ex. TRFX-12345">
              <button id="btnAddTrfx" class="btn">+ Ajouter TRFX</button>
            </div>
            <div id="trfxChips" class="chips" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Ligne 5 : Nb lignes d√©sassign√©es / Raison -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label class="lbl-neutral">Nb lignes d√©sassign√©es</label>
            <input id="vUnassigned" class="clean-zeros" type="number" min="0" step="1" placeholder="0">
          </div>
          <div>
            <label class="lbl-neutral">Raison(s) d√©sassignation</label>
            <input id="vUnassignedReason" placeholder="ex. pi√®ce manquante, outillage‚Ä¶">
          </div>
        </div>

        <!-- Ligne 6 : Nb lignes fin de chantier + Immat / Check -->
        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label class="lbl-neutral">Nb lignes fin de chantier</label>
            <input id="vEndLines" class="clean-zeros" type="number" min="0" step="1" placeholder="0">
          </div>
          <div class="grid cols-2">
            <div>
              <label class="lbl-neutral">Immatriculation</label>
              <input id="vImmat" list="immatList" placeholder="ex. F-HUVK">
              <datalist id="immatList"></datalist>
            </div>
            <div>
              <label class="lbl-neutral">Type de check</label>
              <select id="vCheck">
                <option>A1</option><option>A2</option><option>A3</option><option>A4</option>
                <option>A5</option><option>A6</option><option>A7</option><option>A8</option>
                <option>A9</option><option>A10</option><option>A11</option><option>A12</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Ajout immat + Import XML -->
        <div class="grid cols-2" style="margin-top:8px">
          <div class="row" style="align-items:end">
            <div style="flex:1">
              <label class="lbl-neutral">Ajouter une immat</label>
              <input id="vImmatAdd" placeholder="ex. F-HUVP">
            </div>
            <button id="btnAddImmat" class="btn">+ Ajouter</button>
          </div>
          <div class="row" style="align-items:end">
            <input id="xmlFile" type="file" accept=".xml">
            <button id="btnImportXml" class="btn primary">Importer XML (auto-pr√©remplir)</button>
            <span class="small" style="margin-left:auto">Immat/Check/Arr. pr√©v./APRS pr√©v./HMO pr√©v. auto ‚Äî modifiable ensuite.</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Effectifs par vac</h2>
          <button id="btnAddVac" class="btn">+ Ajouter une vac</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="vacTable">
            <thead>
              <tr>
                <th>Vac</th>
                <th>CME dem.</th><th>EIR dem.</th><th>Leader dem.</th><th>Eff. dem. total</th>
                <th>CME r√©el</th><th>EIR r√©el</th><th>Leader r√©el</th><th>Eff. r√©el total</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="vacBody"></tbody>
            <tfoot>
              <tr>
                <th>Total g√©n√©ral</th>
                <th id="tCmeD">0</th><th id="tEirD">0</th><th id="tLeadD">0</th><th id="tDem">0</th>
                <th id="tCmeR">0</th><th id="tEirR">0</th><th id="tLeadR">0</th><th id="tReal">0</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="pill">Œî Effectif : <b id="deltaEff">0</b></div>
          <div class="pill">Œî HMO : <b id="deltaHmoBadge">0.0 h</b></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnSaveVisit" class="btn ok">üíæ Enregistrer</button>
          <button id="btnSaveAsNew" class="btn primary">üÜï Enregistrer (nouvelle)</button>
          <button id="btnClearVisit" class="btn bad">üßπ Effacer le formulaire</button>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Probl√®mes li√©s √† cette visite</h2>
          <button id="btnLinkProblem" class="btn">+ Ajouter depuis la biblioth√®que</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table>
            <thead><tr><th>#</th><th>Titre</th><th>Cat.</th><th>Impact(h)</th><th>R√©c.</th><th></th></tr></thead>
            <tbody id="visitProblemsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PROBL√àMES -->
    <section id="tab-problems" class="hidden">
      <h1>Probl√®mes (REX)</h1>
      <div class="card">
        <h2>Ajouter un probl√®me</h2>
        <div class="grid cols-2">
          <div>
            <label class="lbl-neutral">Titre</label>
            <input id="pTitle">
          </div>
          <div>
            <label class="lbl-neutral">Cat√©gorie</label>
            <select id="pCat">
              <option>Cabine</option><option>Sous-traitance</option>
              <option>Query/Pr√©pa</option><option>Pi√®ces/Log</option>
              <option>Effectifs/Planif</option><option>Documentation</option><option>Autre</option>
            </select>
          </div>
          <div>
            <label class="lbl-neutral">Impact (h)</label>
            <input id="pImpact" class="clean-zeros" type="number" min="0" step="0.5" placeholder="0">
          </div>
          <div>
            <label class="lbl-neutral">Acteur/Responsable</label>
            <input id="pActor" placeholder="ex. Cabine, STT, Query, Planif‚Ä¶">
          </div>
          <div class="row" style="align-items:center">
            <label class="lbl-neutral" style="margin:0">R√©current</label>
            <input id="pRecurring" type="checkbox">
          </div>
          <div style="grid-column:1/-1">
            <label class="lbl-neutral">Description</label>
            <textarea id="pDesc" rows="3" placeholder="Contexte, sympt√¥mes, documents concern√©s‚Ä¶"></textarea>
          </div>
        </div>
        <button id="btnAddProblem" class="btn ok">+ Enregistrer en biblioth√®que (non assign√©)</button>
      </div>

      <div class="card">
        <h2>Probl√®mes enregistr√©s</h2>
        <div class="row">
          <div><label>Recherche</label><input id="pbSearch" placeholder="titre/cat/acteur‚Ä¶"></div>
          <div><label>R√©currents seulement</label><input id="pbRecOnly" type="checkbox"></div>
          <div><label>D√©but</label><input id="fStart" type="date"></div>
          <div><label>Fin</label><input id="fEnd" type="date"></div>
          <div><label>Immat</label><input id="fImmat" placeholder="Toutes"></div>
          <div>
            <label>Type</label>
            <select id="fCheck"><option value="">Tous</option><option>A1</option><option>A2</option><option>A3</option><option>A4</option><option>A5</option><option>A6</option><option>A7</option><option>A8</option><option>A9</option><option>A10</option><option>A11</option><option>A12</option></select>
          </div>
          <div>
            <label>Cat√©gorie</label>
            <select id="fCat"><option value="">Toutes</option><option>Cabine</option><option>Sous-traitance</option><option>Query/Pr√©pa</option><option>Pi√®ces/Log</option><option>Effectifs/Planif</option><option>Documentation</option><option>Autre</option></select>
          </div>
          <button id="btnFilterProblems" class="btn">Filtrer</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Probl√®me</th><th>Cat.</th><th>Impact(h)</th><th>R√©c.</th>
                <th>Assignations</th><th>%</th><th>Enregistr√©</th><th></th>
              </tr>
            </thead>
            <tbody id="problemsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PERFORMANCE -->
    <section id="tab-perf" class="hidden">
      <h1>Performance</h1>
      <div class="card">
        <div class="row">
          <div><label>D√©but</label><input id="pfStart" type="date"></div>
          <div><label>Fin</label><input id="pfEnd" type="date"></div>
          <div><label>Immat</label><input id="pfImmat" placeholder="Toutes"></div>
          <div>
            <label>Type</label>
            <select id="pfCheck"><option value="">Tous</option><option>A1</option><option>A2</option><option>A3</option><option>A4</option><option>A5</option><option>A6</option><option>A7</option><option>A8</option><option>A9</option><option>A10</option><option>A11</option><option>A12</option></select>
          </div>
          <button id="btnPerfRefresh" class="btn">Actualiser</button>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="pill">Respect planning (APRS r√©el ‚â§ APRS pr√©vu) : <b id="kpiRespect">0%</b></div>
          <div class="pill">Œî HMO moyen : <b id="kpiHmo">0.0 h (0%)</b></div>
          <div class="pill">Œî effectif moyen : <b id="kpiEff">0%</b></div>
          <div class="pill">Moy. pr√©l√®vements : <b id="kpiSamples">0</b></div>
        </div>
      </div>
      <div class="grid cols-2">
        <div class="card">
          <h2>Pareto par cat√©gorie</h2>
          <table>
            <thead><tr><th>Cat√©gorie</th><th>Comptes</th><th>%</th><th>Cumul %</th></tr></thead>
            <tbody id="paretoBody"></tbody>
          </table>
        </div>
        <div class="card">
          <h2>R√©partition (camembert)</h2>
          <div class="chart-wrap">
            <canvas id="pie"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- S√©lecteur de probl√®mes (assignation √† une visite) -->
<dialog id="dlgPick">
  <div class="head">
    <div style="font-weight:600">Ajouter des probl√®mes √† la visite</div>
    <button class="btn" onclick="dlgPick.close()">Fermer</button>
  </div>
  <div class="body">
    <div class="row">
      <input id="pickSearch" placeholder="Rechercher (titre/cat/acteur)‚Ä¶" style="flex:1">
      <label class="row small"><input id="pickRec" type="checkbox"> R√©currents seulement</label>
      <button id="pickRefresh" class="btn">Rechercher</button>
    </div>
    <div style="max-height:50vh;overflow:auto;margin-top:10px">
      <table>
        <thead><tr><th>Choisir</th><th>Titre</th><th>Cat.</th><th>Impact</th><th>R√©c.</th></tr></thead>
        <tbody id="pickBody"></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="pickAdd" class="btn ok">+ Ajouter √† la visite</button>
      <span class="small" style="margin-left:auto;opacity:.9">Les √©l√©ments coch√©s seront ajout√©s avec confirmation.</span>
    </div>
  </div>
</dialog>

<script>
/* ======================= stockage & base immats (LS) ====================== */
const LS_KEY="rexA350_checkA_v5_color_pairs_trfx";
const BASE_IMMATS=[
  "F-HTYA","F-HTYB","F-HTYC","F-HTYD","F-HTYE","F-HTYF","F-HTYG","F-HTYH",
  "F-HTYI","F-HTYJ","F-HTYK","F-HTYL","F-HTYM","F-HTYN","F-HTYO","F-HTYP",
  "F-HTYQ","F-HTYR","F-HTYS","F-HTYT","F-HUVA","F-HUVB","F-HUVC","F-HUVD",
  "F-HUVE","F-HUVF","F-HUVG","F-HUVH","F-HUVI","F-HUVJ","F-HUVK","F-HUVL",
  "F-HUVM","F-HUVN","F-HUVO","F-HUVP","F-HUVQ","F-HUVR","F-HUVS","F-HUVT",
  "F-HUVU"
];
function load(){ try{return JSON.parse(localStorage.getItem(LS_KEY))}catch{ return null } }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)) }
let state = load() || { immat:[...BASE_IMMATS], visits:[], problems:[] };
if(!Array.isArray(state.immat) || !state.immat.length) state.immat=[...BASE_IMMATS];
state.immat=Array.from(new Set([...state.immat,...BASE_IMMATS])).sort();

/* =============================== utilitaires ============================== */
const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
const num=v=>{const n=parseFloat(v);return isNaN(n)?0:n}
const within=(d,a,b)=>{ if(!d) return false; const t=new Date(d).getTime(); const ta=a?new Date(a).getTime():-1e15; const tb=b?new Date(b).getTime()+86399999:1e15; return t>=ta&&t<=tb }
function fmtDate(v){ if(!v) return "‚Äî"; const d=new Date(v); return isNaN(d)?"‚Äî":d.toLocaleString() }
function uuid(){ return Math.random().toString(36).slice(2,10) }

/* ================================ onglets ================================= */
$$('aside .menu button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('aside .menu button').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
    ['tab-visit','tab-problems','tab-perf'].forEach(id=>$('#'+id).classList.add('hidden'));
    $('#tab-'+btn.dataset.tab).classList.remove('hidden');
    if(btn.dataset.tab==='perf') renderPerf();
    if(btn.dataset.tab==='problems') renderProblems();
    if(btn.dataset.tab==='visit') { renderVisitsList(); }
  })
})

/* ============================= immats (datalist) ========================== */
function refreshImmatList(){
  const dl=$('#immatList'); dl.innerHTML='';
  state.immat.forEach(i=>{ const o=document.createElement('option'); o.value=i; dl.appendChild(o) })
}
refreshImmatList();
$('#btnAddImmat').onclick=()=>{
  const v=$('#vImmatAdd').value.trim().toUpperCase(); if(!v) return;
  if(!state.immat.includes(v)) state.immat.push(v);
  $('#vImmat').value=v; $('#vImmatAdd').value=''; refreshImmatList(); save();
}

/* ========================= Entr√©es sans ‚Äú0 collant‚Äù ======================= */
function setupCleanZeros(){
  $$('.clean-zeros').forEach(inp=>{
    inp.value=''; // vide par d√©faut
    inp.addEventListener('focus', ()=>{ if(inp.value==='0') inp.value=''; });
    inp.addEventListener('blur', ()=>{ if(inp.value==='') inp.value=''; }); // reste vide
    inp.addEventListener('input', ()=>{ /* calc √† la vol√©e */ recalcTotals(); });
  });
}
setupCleanZeros();

/* ============================ TRFX chips (par item) ======================= */
function renderTrfxChips(list){
  const wrap = $('#trfxChips'); wrap.innerHTML='';
  (list||[]).forEach((code,idx)=>{
    const d=document.createElement('div'); d.className='chip';
    d.innerHTML = `<span>${code}</span><button title="Retirer" data-i="${idx}">‚úï</button>`;
    wrap.appendChild(d);
  });
}
$('#btnAddTrfx').onclick=()=>{
  const v=getCurrentVisit() || collectVisitFromForm(); // si rien charg√©, on prend le formulaire en cours
  const code = $('#vTrfxInput').value.trim(); if(!code) return;
  v.trfx = Array.isArray(v.trfx)? v.trfx : [];
  v.trfx.push(code);
  $('#vTrfxInput').value='';
  // pousser dans state si la visite existe d√©j√†
  if(v.id && state.visits.find(x=>x.id===v.id)){
    const i = state.visits.findIndex(x=>x.id===v.id); state.visits[i]=v; save();
  }
  renderTrfxChips(v.trfx);
};
$('#trfxChips').addEventListener('click',(e)=>{
  const i=e.target?.dataset?.i; if(i==null) return;
  const v=getCurrentVisit() || collectVisitFromForm();
  if(Array.isArray(v.trfx)){ v.trfx.splice(Number(i),1); }
  if(v.id){
    const idx=state.visits.findIndex(x=>x.id===v.id); if(idx>=0){ state.visits[idx]=v; save(); }
  }
  renderTrfxChips(v.trfx||[]);
});

<!-- ============================ vacs (table effectifs) ====================== -->
<script>
const vacBody = document.getElementById('vacBody');

const SHIFT_CYCLE = ['matin','soir','nuit'];
const nextShift = s => SHIFT_CYCLE[(SHIFT_CYCLE.indexOf(s)+1)%SHIFT_CYCLE.length];

function makeShiftSelect(value='matin'){
  const sel = document.createElement('select');
  sel.className = 'shift';
  ['matin','soir','nuit'].forEach(opt=>{
    const o=document.createElement('option');
    o.value=opt; o.textContent=opt.charAt(0).toUpperCase()+opt.slice(1);
    if(opt===value) o.selected=true;
    sel.appendChild(o);
  });
  return sel;
}

function formatVacName(idx, shift){
  return `Vac ${idx+1} ${shift}`;
}

function vacRow(shift='matin'){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td class="vacTitle"></td>
    <td><input class="cmeD clean-zeros" type="number" min="0" placeholder="0"></td>
    <td><input class="eirD clean-zeros" type="number" min="0" placeholder="0"></td>
    <td><input class="leadD clean-zeros" type="number" min="0" placeholder="0"></td>
    <td class="demTot">0</td>
    <td><input class="cmeR clean-zeros" type="number" min="0" placeholder="0"></td>
    <td><input class="eirR clean-zeros" type="number" min="0" placeholder="0"></td>
    <td><input class="leadR clean-zeros" type="number" min="0" placeholder="0"></td>
    <td class="realTot">0</td>
    <td><button class="btn bad delVac">Retirer</button></td>`;
  vacBody.appendChild(tr);

  // ins√©rer s√©lecteur shift au d√©but dans la cellule titre
  const titleCell = tr.querySelector('.vacTitle');
  const wrap = document.createElement('div');
  wrap.className = 'row';
  const sel = makeShiftSelect(shift);
  const nameSpan = document.createElement('span');
  nameSpan.className = 'vacName';
  wrap.appendChild(sel);
  wrap.appendChild(nameSpan);
  titleCell.appendChild(wrap);

  setupCleanZeros();
  return tr;
}

/* Renum√©rote toutes les lignes et met √† jour le libell√© ‚ÄúVac N {shift}‚Äù */
function renumberVacNames(){
  const rows = Array.from(vacBody.querySelectorAll('tr'));
  rows.forEach((tr,idx)=>{
    const sel = tr.querySelector('select.shift');
    const shift = sel?.value || 'matin';
    tr.querySelector('.vacName').textContent = formatVacName(idx, shift);
  });
}

/* √Ä partir d‚Äôun index donn√©, impose la succession des shifts en cycle */
function cascadeShiftsFrom(startIdx){
  const rows = Array.from(vacBody.querySelectorAll('tr'));
  if(rows.length===0) return;
  // point de d√©part = shift de startIdx (ou matin si absent)
  let curShift = rows[startIdx]?.querySelector('select.shift')?.value || 'matin';
  // Les suivants suivent le cycle
  for(let i=startIdx+1; i<rows.length; i++){
    curShift = nextShift(curShift);
    const sel = rows[i].querySelector('select.shift');
    if(sel.value !== curShift){
      sel.value = curShift;
    }
  }
  renumberVacNames();
}

/* Graine initiale : Matin / Soir / Nuit */
function seedVacs(){
  vacBody.innerHTML='';
  ['matin','soir','nuit'].forEach(s=>vacRow(s));
  renumberVacNames();
  recalcTotals();
}

/* Nom/shift de la prochaine vac √† l‚Äôajout : on prend le shift suivant du dernier */
function nextVacShift(){
  const rows = Array.from(vacBody.querySelectorAll('tr'));
  if(rows.length===0) return 'matin';
  const lastShift = rows[rows.length-1].querySelector('select.shift').value || 'matin';
  return nextShift(lastShift);
}

document.getElementById('btnAddVac').onclick=()=>{
  vacRow(nextVacShift());
  renumberVacNames();
  recalcTotals();
};

/* √âcouteurs */
vacBody.addEventListener('input', e=>{
  if(e.target.tagName==='INPUT') recalcTotals();
});

vacBody.addEventListener('change', e=>{
  // changement du type de vac (matin/soir/nuit)
  if(e.target.classList.contains('shift')){
    const tr = e.target.closest('tr');
    const rowIdx = Array.from(vacBody.querySelectorAll('tr')).indexOf(tr);
    // renomme cette ligne et cascade sur les suivantes
    renumberVacNames();
    cascadeShiftsFrom(rowIdx);
  }
});

vacBody.addEventListener('click', e=>{
  if(e.target.classList.contains('delVac')){
    if(confirm('Retirer cette vac ?')){
      e.target.closest('tr').remove();
      // apr√®s suppression, on recalcule la cascade en partant de la premi√®re
      if(vacBody.querySelectorAll('tr').length>0){
        cascadeShiftsFrom(0);
      }
      recalcTotals();
    }
  }
});

/* Init */
seedVacs();
</script>

/* ========================== calculs (totaux & KPI) ======================== */
function recalcTotals(){
  let tCmeD=0,tEirD=0,tLeadD=0,tDem=0,tCmeR=0,tEirR=0,tLeadR=0,tReal=0;
  $$('#vacBody tr').forEach(tr=>{
    const cmeD=num($('.cmeD',tr).value), eirD=num($('.eirD',tr).value), leadD=num($('.leadD',tr).value);
    const cmeR=num($('.cmeR',tr).value), eirR=num($('.eirR',tr).value), leadR=num($('.leadR',tr).value);
    const demTot=cmeD+eirD+leadD, realTot=cmeR+eirR+leadR;
    $('.demTot',tr).textContent=demTot; $('.realTot',tr).textContent=realTot;
    tCmeD+=cmeD; tEirD+=eirD; tLeadD+=leadD; tDem+=demTot;
    tCmeR+=cmeR; tEirR+=eirR; tLeadR+=leadR; tReal+=realTot;
  });
  $('#tCmeD').textContent=tCmeD; $('#tEirD').textContent=tEirD; $('#tLeadD').textContent=tLeadD; $('#tDem').textContent=tDem;
  $('#tCmeR').textContent=tCmeR; $('#tEirR').textContent=tEirR; $('#tLeadR').textContent=tLeadR; $('#tReal').textContent=tReal;

  const dEff=tReal - tDem;
  $('#deltaEff').textContent=dEff;

  const dHmo = num($('#vHmoReal').value) - num($('#vHmoPlan').value);
  $('#deltaHmoBadge').textContent = dHmo.toFixed(1)+' h';
}
;['vHmoPlan','vHmoReal','vSamples','vUnassigned','vEndLines'].forEach(id=> {
  const el=$('#'+id); if(el) el.addEventListener('input', recalcTotals);
});

/* =============================== Import XML =============================== */
$('#btnImportXml').onclick=()=>{
  const f=$('#xmlFile').files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const xml=new DOMParser().parseFromString(r.result,'text/xml');
      const tx=r.result;

      // immat: motif F-HTxx / F-HUVx‚Ä¶
      const m = tx.match(/F-?H[A-Z0-9]{3,4}/i);
      if(m) $('#vImmat').value = m[0].toUpperCase().replace(/^F(H)/,'F-$1');

      // check type A1..A12
      const mc = tx.match(/\bA(1[0-2]|[1-9])\b/i);
      if(mc) $('#vCheck').value = mc[0].toUpperCase();

      // dates ISO : premier pour Arriv√©e pr√©vue, deuxi√®me pour APRS sign√© (pr√©vu) si dispo
      const isos = tx.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}/g) || [];
      if(isos[0]) $('#vArrPrev').value = isos[0].replace(' ','T');
      if(isos[1]) $('#vAprsPrev').value = isos[1].replace(' ','T');

      // HMO pr√©vue explicite ou somme durations
      const getNumNode = sel => {
        const n=xml.querySelector(sel); if(!n) return NaN;
        const v=parseFloat(n.textContent||n.getAttribute('value')); return isNaN(v)?NaN:v;
      }
      let hPlan = getNumNode('HMOPlan, HmoPlan, PlanHMO, HMO_Plan');
      if(isNaN(hPlan)){
        let sum=0;
        xml.querySelectorAll('[duration]').forEach(n=>{
          const v=parseFloat(n.getAttribute('duration')); if(!isNaN(v)) sum+=v;
        });
        hPlan=sum||0;
      }
      $('#vHmoPlan').value = isNaN(hPlan)? '' : String(hPlan);
      recalcTotals();
      alert('XML import√© ‚úÖ (Immat, Check, Arr. pr√©v., APRS pr√©v., HMO pr√©v. auto)');
    }catch(e){ alert('XML invalide'); }
  };
  r.readAsText(f);
};

/* ========================= Enregistrer / Brouillon ======================== */
let currentVisitId = null; // id de la visite charg√©e dans le formulaire

function collectVisitFromForm(){
  const vacs=$$('#vacBody tr').map(tr=>({
    name:$(".vacName",tr).value.trim(),
    cmeDem:num($('.cmeD',tr).value), eirDem:num($('.eirD',tr).value), leadDem:num($('.leadD',tr).value),
    cmeReal:num($('.cmeR',tr).value), eirReal:num($('.eirR',tr).value), leadReal:num($('.leadR',tr).value)
  }));
  const cur = getCurrentVisit();
  const trfxList = cur?.trfx || []; // d√©j√† ajout√©s via chips
  return {
    id: currentVisitId || uuid(),
    immat: $('#vImmat').value.trim().toUpperCase(),
    check: $('#vCheck').value,
    arrPrev: $('#vArrPrev').value || null,
    arrReal: $('#vArrReal').value || null,
    aprsPrev: $('#vAprsPrev').value || null,
    aprsReal: $('#vAprsReal').value || null,
    hmoPlan: num($('#vHmoPlan').value),
    hmoReal: num($('#vHmoReal').value),
    samples: num($('#vSamples').value),
    trfx: trfxList,
    unassigned: num($('#vUnassigned').value),
    unassignedReason: $('#vUnassignedReason').value.trim(),
    endLines: num($('#vEndLines').value),
    vacs,
    problems: (cur?.problems)||[], // conserve liens si modif
    createdAt: cur?.createdAt || new Date().toISOString()
  };
}
function getCurrentVisit(){ return state.visits.find(v=>v.id===currentVisitId) || null; }

function renderFormFromVisit(v){
  currentVisitId = v?.id || null;
  $('#vImmat').value = v?.immat||'';
  $('#vCheck').value = v?.check||'A1';
  $('#vArrPrev').value = v?.arrPrev||'';
  $('#vArrReal').value = v?.arrReal||'';
  $('#vAprsPrev').value = v?.aprsPrev||'';
  $('#vAprsReal').value = v?.aprsReal||'';
  $('#vHmoPlan').value = v?.hmoPlan? String(v.hmoPlan):'';
  $('#vHmoReal').value = v?.hmoReal? String(v.hmoReal):'';
  $('#vSamples').value = v?.samples? String(v.samples):'';
  $('#vUnassigned').value = v?.unassigned? String(v.unassigned):'';
  $('#vUnassignedReason').value = v?.unassignedReason||'';
  $('#vEndLines').value = v?.endLines? String(v.endLines):'';
  vacBody.innerHTML='';
  (v?.vacs?.length?v.vacs:[{name:'Vac 1 matin'},{name:'Vac 2 soir'},{name:'Vac 3 nuit'}]).forEach(x=>{
    vacRow(x.name||''); 
    const tr=vacBody.lastElementChild;
    $('.cmeD',tr).value=x.cmeDem||''; $('.eirD',tr).value=x.eirDem||''; $('.leadD',tr).value=x.leadDem||'';
    $('.cmeR',tr).value=x.cmeReal||''; $('.eirR',tr).value=x.eirReal||''; $('.leadR',tr).value=x.leadReal||'';
  });
  setupCleanZeros();
  recalcTotals();
  renderVisitProblems(v||{problems:[]});
  renderTrfxChips(v?.trfx||[]);
}

$('#btnSaveVisit').onclick=()=>{
  const v = collectVisitFromForm();
  const idx = state.visits.findIndex(x=>x.id===v.id);
  if(idx>=0) state.visits[idx]=v; else state.visits.push(v);
  if(v.immat && !state.immat.includes(v.immat)){ state.immat.push(v.immat); refreshImmatList(); }
  save(); renderVisitsList();
  alert('Visite enregistr√©e ‚úÖ');
};
$('#btnSaveAsNew').onclick=()=>{
  const prev = getCurrentVisit();
  currentVisitId = null; // force nouvel ID
  const v = collectVisitFromForm();
  state.visits.push(v);
  if(v.immat && !state.immat.includes(v.immat)){ state.immat.push(v.immat); refreshImmatList(); }
  save(); renderVisitsList(); renderFormFromVisit(v);
  alert('Nouvelle visite enregistr√©e ‚úÖ');
};
$('#btnClearVisit').onclick=()=>{
  if(!confirm('Effacer le formulaire en cours ?')) return;
  currentVisitId=null;
  ['vImmat','vImmatAdd','vArrPrev','vArrReal','vAprsPrev','vAprsReal','vHmoPlan','vHmoReal','vSamples','vUnassigned','vUnassignedReason','vEndLines','vTrfxInput']
    .forEach(id=> $('#'+id).value = '');
  renderTrfxChips([]);
  seedVacs(); recalcTotals(); renderVisitProblems({problems:[]});
};
$('#btnNewVisit').onclick=()=>{
  if(!confirm('Cr√©er une nouvelle visite (brouillon vide) ?')) return;
  const v={ id:uuid(), immat:'', check:'A1',
    arrPrev:null, arrReal:null, aprsPrev:null, aprsReal:null,
    hmoPlan:0, hmoReal:0, samples:0, trfx:[],
    unassigned:0, unassignedReason:'', endLines:0,
    vacs:[{name:'Vac 1 matin',cmeDem:0,eirDem:0,leadDem:0,cmeReal:0,eirReal:0,leadReal:0},
          {name:'Vac 2 soir',cmeDem:0,eirDem:0,leadDem:0,cmeReal:0,eirReal:0,leadReal:0},
          {name:'Vac 3 nuit',cmeDem:0,eirDem:0,leadDem:0,cmeReal:0,eirReal:0,leadReal:0}],
    problems:[], createdAt:new Date().toISOString()
  };
  state.visits.push(v); save();
  renderVisitsList(); renderFormFromVisit(v);
};

/* ============================ Liste des visites =========================== */
function renderVisitsList(){
  const tb=$('#visitsBody'); tb.innerHTML='';
  state.visits.slice().reverse().forEach((v,idx)=>{
    const dH = (v.hmoReal||0)-(v.hmoPlan||0);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${state.visits.length-idx}</td>
      <td>${v.immat||'‚Äî'}</td>
      <td>${v.check||'A?'}</td>
      <td>${fmtDate(v.arrPrev)}</td>
      <td>${fmtDate(v.aprsPrev)}</td>
      <td>${v.hmoPlan||0}</td>
      <td>${v.hmoReal||0}</td>
      <td>${dH>0?'+':''}${(v.hmoReal!=null&&v.hmoPlan!=null)?dH:0}</td>
      <td>
        <button class="btn" data-act="open" data-id="${v.id}">Ouvrir</button>
        <button class="btn" data-act="pbl" data-id="${v.id}">Probl√®mes</button>
        <button class="btn bad" data-act="del" data-id="${v.id}">Supprimer</button>
      </td>`;
    tb.appendChild(tr);
  });
}
renderVisitsList();
$('#visitsTable').addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.id; const act=b.dataset.act;
  const v=state.visits.find(x=>x.id===id); if(!v) return;
  if(act==='open'){ renderFormFromVisit(v); }
  if(act==='pbl'){ openPickDialogFor(id); }
  if(act==='del'){
    if(confirm('Supprimer d√©finitivement cette visite ? Cette action affecte les statistiques REX.')){
      state.visits=state.visits.filter(x=>x.id!==id); save(); renderVisitsList();
      if(currentVisitId===id){ $('#btnClearVisit').click(); }
    }
  }
});

/* ==================== Probl√®mes li√©s √† une visite (table) ================= */
function renderVisitProblems(v){
  const tb=$('#visitProblemsBody'); tb.innerHTML='';
  (v.problems||[]).forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${p.title}</td><td>${p.cat||'‚Äî'}</td><td>${p.impact||0}</td><td>${p.recurring?'Oui':'Non'}</td>
    <td><button class="btn bad" data-i="${i}">Retirer</button></td>`;
    tb.appendChild(tr);
  });
}
$('#visitProblemsBody').addEventListener('click',(e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const i=Number(b.dataset.i);
  const v=getCurrentVisit(); if(!v) return alert('Aucune visite charg√©e');
  if(confirm('Retirer ce probl√®me de la visite ?')){
    v.problems.splice(i,1); save(); renderVisitProblems(v);
  }
});

/* ============== Biblioth√®que Probl√®mes (ajout & comptage) ================ */
$('#btnAddProblem').onclick=()=>{
  const title=$('#pTitle').value.trim(); if(!title) return alert('Titre manquant');
  const p={
    id: uuid(),
    title, cat:$('#pCat').value, impact:num($('#pImpact').value), actor:$('#pActor').value.trim(),
    recurring:$('#pRecurring').checked, desc:$('#pDesc').value.trim(),
    immat:'', check:'', ts:new Date().toISOString()
  };
  state.problems.push(p); save();
  $('#pTitle').value=''; $('#pImpact').value=''; $('#pActor').value=''; $('#pRecurring').checked=false; $('#pDesc').value='';
  renderProblems();
};
function filterProblemsList(list){
  const q=$('#pbSearch').value.trim().toLowerCase();
  const rec=$('#pbRecOnly').checked;
  const s=$('#fStart').value, e=$('#fEnd').value, im=($('#fImmat').value||'').toUpperCase(), ck=$('#fCheck').value, cat=$('#fCat').value;
  return list.filter(p=>{
    const inQ=!q || (p.title+p.cat+(p.actor||'')+(p.desc||'')).toLowerCase().includes(q);
    const inRec=!rec || !!p.recurring;
    const inP = within(p.ts,s||null,e||null);
    const inI = im? p.immat===im : true; // compat
    const inC = ck? p.check===ck : true;  // compat
    const inCat = cat? p.cat===cat : true;
    return inQ && inRec && inP && inI && inC && inCat;
  });
}
function countAssignments(pid, visitsSubset=null){
  const visits = Array.isArray(visitsSubset) ? visitsSubset : state.visits;
  let n = 0;
  visits.forEach(v=>{
    if(Array.isArray(v.problems)){
      n += v.problems.filter(x=>x.pid === pid).length;
    }
  });
  return n;
}
function renderProblems(){
  const tbody = document.getElementById('problemsBody');
  tbody.innerHTML = '';
  const filtered = filterProblemsList(state.problems);
  const totalAssign = filtered.reduce((acc,p)=> acc + countAssignments(p.id), 0) || 1;
  filtered.forEach((p,i)=>{
    const assigns = countAssignments(p.id);
    const pct = Math.round(assigns * 100 / totalAssign);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${p.title}</td>
      <td>${p.cat}</td>
      <td>${p.impact||0}</td>
      <td>${p.recurring?'Oui':'Non'}</td>
      <td>${assigns}</td>
      <td>${pct}%</td>
      <td>${new Date(p.ts).toLocaleString()}</td>
      <td><button class="btn bad" data-del="${p.id}">Supprimer</button></td>
    `;
    tbody.appendChild(tr);
  });
}
document.getElementById('problemsBody').addEventListener('click', (e)=>{
  const id = e.target?.dataset?.del;
  if(!id) return;
  const cascade = confirm("Supprimer ce probl√®me de la biblioth√®que ?\n\nOK = supprime aussi ce probl√®me de toutes les visites.");
  state.problems = state.problems.filter(p => p.id !== id);
  if (cascade) {
    state.visits.forEach(v=>{
      if (Array.isArray(v.problems)) v.problems = v.problems.filter(x => x.pid !== id);
    });
  }
  save(); renderProblems();
  const v = state.visits.find(x => x.id === (currentVisitId||'')); if (v) renderVisitProblems(v);
  alert('Probl√®me supprim√© ‚úÖ' + (cascade ? ' (et retir√© des visites)' : ''));
});
$('#btnFilterProblems').onclick=renderProblems;
renderProblems();

/* ================ Dialog: assigner probl√®mes √† une visite ================= */
const dlgPick = $('#dlgPick');
function openPickDialogFor(visitId){
  const v = state.visits.find(x=>x.id===visitId); if(!v) return;
  currentVisitId = visitId;
  $('#pickSearch').value=''; $('#pickRec').checked=false;
  renderPickList();
  dlgPick.showModal();
}
function renderPickList(){
  const tb=$('#pickBody'); tb.innerHTML='';
  const q=$('#pickSearch').value.trim().toLowerCase();
  const rec=$('#pickRec').checked;
  state.problems.filter(p=>{
    const inQ=!q || (p.title+p.cat+(p.actor||'')+(p.desc||'')).toLowerCase().includes(q);
    const inRec=!rec || !!p.recurring;
    return inQ && inRec;
  }).forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="text-align:center"><input type="checkbox" data-id="${p.id}"></td>
      <td>${p.title}</td><td>${p.cat||'‚Äî'}</td><td>${p.impact||0}</td><td>${p.recurring?'Oui':'Non'}</td>`;
    tb.appendChild(tr);
  });
}
$('#pickRefresh').onclick=renderPickList;
$('#pickAdd').onclick=()=>{
  const v=getCurrentVisit(); if(!v) return alert('Aucune visite charg√©e');
  const ids=$$('#pickBody input[type="checkbox"]:checked').map(x=>x.dataset.id);
  if(!ids.length) return alert('S√©lectionne au moins un probl√®me.');
  if(!confirm(`Ajouter ${ids.length} probl√®me(s) √† cette visite ?`)) return;
  const toAdd = state.problems.filter(p=>ids.includes(p.id)).map(p=>({
    pid:p.id, title:p.title, cat:p.cat, impact:p.impact, recurring:!!p.recurring
  }));
  v.problems = (v.problems||[]).concat(toAdd);
  save(); renderVisitProblems(v); dlgPick.close();
}

/* ============================ Export / Import JSON ======================== */
$('#exportJson').onclick=()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rex-a350.json'; a.click();
}
/* Remplacement total */
$('#importJsonBtn').onclick=()=>$('#importJsonFile').click();
$('#importJsonFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const d=JSON.parse(r.result);
      if(d && d.visits && d.problems){
        if(!confirm('Remplacer enti√®rement les donn√©es locales par ce JSON ?')) return;
        state=d; 
        state.immat=Array.from(new Set([...(state.immat||[]), ...BASE_IMMATS])).sort();
        save(); refreshImmatList(); renderProblems(); renderPerf(); renderVisitsList();
        alert('Import (remplacement) OK ‚úÖ');
      } else alert('JSON invalide');
    }catch{ alert('Erreur JSON'); }
  };
  r.readAsText(f);
});
/* Fusion intelligente */
$('#mergeJsonBtn').onclick=()=>$('#mergeJsonFile').click();
$('#mergeJsonFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const incoming=JSON.parse(r.result);
      if(!(incoming && (incoming.visits||incoming.problems||incoming.immat))) return alert('JSON sans contenu utile');
      const before = JSON.stringify(state).length;

      // union immats
      if(Array.isArray(incoming.immat)) state.immat = Array.from(new Set([...state.immat, ...incoming.immat])).sort();

      // fusion probl√®mes (par id sinon ajout)
      if(Array.isArray(incoming.problems)){
        const byId = new Map(state.problems.map(p=>[p.id,p]));
        incoming.problems.forEach(p=>{
          if(p && p.id){
            if(!byId.has(p.id)) byId.set(p.id,p);
            else {
              const cur = byId.get(p.id);
              byId.set(p.id, {
                ...cur,
                title: p.title || cur.title,
                cat: p.cat || cur.cat,
                impact: (typeof p.impact==='number')? p.impact : cur.impact,
                actor: p.actor || cur.actor,
                recurring: (typeof p.recurring==='boolean')? p.recurring : cur.recurring,
                desc: p.desc || cur.desc,
                immat: p.immat || cur.immat,
                check: p.check || cur.check,
                ts: p.ts || cur.ts
              });
            }
          }else{
            const cp={...p, id: uuid(), ts: p?.ts || new Date().toISOString()};
            byId.set(cp.id, cp);
          }
        });
        state.problems = Array.from(byId.values());
      }

      // fusion visites (par id; sinon d√©doublonnage heuristique)
      if(Array.isArray(incoming.visits)){
        const mapV = new Map(state.visits.map(v=>[v.id,v]));
        const keyOf = v => [v.immat,v.check,v.arrPrev,v.aprsPrev,v.hmoPlan].join('|');
        const seenKeys = new Set(state.visits.map(v=>keyOf(v)));

        incoming.visits.forEach(v=>{
          if(v && v.id && mapV.has(v.id)){
            const cur = mapV.get(v.id);
            const merged = {
              ...cur,
              ...v,
              vacs: Array.isArray(v.vacs) ? v.vacs : cur.vacs,
              problems: Array.isArray(v.problems) ? v.problems : cur.problems,
              trfx: Array.isArray(v.trfx) ? v.trfx : cur.trfx
            };
            mapV.set(v.id, merged);
          } else {
            const k = keyOf(v||{});
            if(!seenKeys.has(k)){
              const nv = v && v.id ? v : {...v, id: uuid()};
              mapV.set(nv.id, nv);
              seenKeys.add(k);
            }
          }
        });
        state.visits = Array.from(mapV.values());
      }

      save(); refreshImmatList(); renderProblems(); renderPerf(); renderVisitsList();
      const after = JSON.stringify(state).length;
      alert('Fusion JSON termin√©e ‚úÖ\nDonn√©es cumul√©es et d√©doublonn√©es.\n(+'+ (after-before) +' octets environ)');
    }catch{ alert('Erreur JSON'); }
  };
  r.readAsText(f);
});

/* ================================ Performance ============================= */
let pie=null;
function renderPerf(){
  const s=$('#pfStart').value, e=$('#pfEnd').value, im=($('#pfImmat').value||'').toUpperCase(), ck=$('#pfCheck').value;
  const inRange = v => within(v.createdAt||v.arrPrev||v.arrReal||v.aprsPrev||v.aprsReal, s||null, e||null);
  const visits=state.visits.filter(v=> inRange(v) && (im? v.immat===im:true) && (ck? v.check===ck:true));

  // KPIs
  let res=0,tot=0, sumDH=0,sumHD=0, sumPctEff=0, cntPct=0, sumSamples=0, cntSamples=0;
  visits.forEach(v=>{
    if(v.aprsPrev && v.aprsReal){ tot++; if(new Date(v.aprsReal)<=new Date(v.aprsPrev)) res++; }
    const dH = (v.hmoReal||0) - (v.hmoPlan||0);
    sumDH += dH; sumHD += (v.hmoPlan||0);
    const dem = (v.vacs||[]).reduce((a,x)=>a+(x.cmeDem||0)+(x.eirDem||0)+(x.leadDem||0),0);
    const rea = (v.vacs||[]).reduce((a,x)=>a+(x.cmeReal||0)+(x.eirReal||0)+(x.leadReal||0),0);
    if(dem>0){ sumPctEff += ((rea-dem)/dem)*100; cntPct++; }
    if(typeof v.samples==='number'){ sumSamples += v.samples; cntSamples++; }
  });
  $('#kpiRespect').textContent = (tot? Math.round(res*100/tot):0)+'%';
  const avgDH = visits.length? (sumDH/visits.length):0;
  const pctDH = sumHD? Math.round(sumDH*100/sumHD):0;
  $('#kpiHmo').textContent = `${avgDH.toFixed(1)} h (${pctDH}%)`;
  $('#kpiEff').textContent = `${cntPct? Math.round(sumPctEff/cntPct):0}%`;
  $('#kpiSamples').textContent = (cntSamples? Math.round(sumSamples/cntSamples):0);

  // Pareto / pie depuis problems filtr√©s
  const probs=state.problems.filter(p=> within(p.ts,s||null,e||null) && (im? p.immat===im:true) && (ck? p.check===ck:true));
  const byCat={}; probs.forEach(p=> byCat[p.cat]=(byCat[p.cat]||0)+1 );
  const arr=Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  const total=arr.reduce((a,[,c])=>a+c,0)||1;
  const pb=$('#paretoBody'); pb.innerHTML='';
  let cumul=0;
  arr.forEach(([cat,c])=>{
    const pc=Math.round(c*100/total); cumul+=pc;
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${cat}</td><td>${c}</td><td>${pc}%</td><td>${Math.min(cumul,100)}%</td>`;
    pb.appendChild(tr);
  });
  const ctx=$('#pie').getContext('2d'); if(pie) pie.destroy();
  pie=new Chart(ctx,{ type:'doughnut', data:{ labels:arr.map(x=>x[0]), datasets:[{ data:arr.map(x=>x[1]) }]}, options:{plugins:{legend:{position:'bottom'}},maintainAspectRatio:false} });
}
$('#btnPerfRefresh').onclick=renderPerf;

/* ================================ init UI ================================= */
function initialRender(){
  refreshImmatList(); renderProblems(); renderVisitsList();
}
initialRender();
</script>
</body>
</html>
