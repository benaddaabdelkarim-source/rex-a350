<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>REX A350 ‚Äì Check A (tout-en-un)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#60a5fa;--line:#27324a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto}
.wrap{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
aside{background:var(--panel);border-right:1px solid var(--line);padding:16px 12px}
main{padding:16px}
h1{margin:0 0 12px;font-size:20px}
h2{margin:0 0 8px;font-size:16px}
.menu h3{font-size:12px;letter-spacing:.08em;color:#93a3b8;margin:0 0 10px;text-transform:uppercase}
.menu button{display:block;width:100%;text-align:left;background:#0b1220;border:1px solid var(--line);color:var(--text);padding:10px 12px;margin:6px 0;border-radius:10px;cursor:pointer}
.menu button.active{outline:2px solid var(--accent)}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:repeat(3,1fr)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,select,textarea{width:100%;background:#0b1220;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px}
input[type="number"]{text-align:right}
.btn{border:1px solid var(--line);background:#0b1220;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.ok{background:#0d2517;border-color:#154a2c;color:#bbf7d0}
.btn.bad{background:#2a0e12;border-color:#5b111c;color:#fecaca}
.btn.ghost{background:transparent}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--line);padding:8px;text-align:right}
th:first-child,td:first-child{text-align:left}
thead th{background:#0b1220;position:sticky;top:0}
.small{font-size:12px;opacity:.8}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .pill{padding:8px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--line)}
.hidden{display:none}
.topbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:12px}
</style>
</head>
<body>
<div class="wrap">
  <aside>
    <div class="menu">
      <h3>REX A350</h3>
      <button class="active" data-tab="visit">üõ†Ô∏è Visite</button>
      <button data-tab="problems">üìö Probl√®mes</button>
      <button data-tab="perf">üìä Performance</button>
    </div>
  </aside>

  <main>
    <div class="topbar">
      <button id="exportJson" class="btn">Exporter JSON</button>
      <input id="importJsonFile" type="file" accept="application/json" class="hidden">
      <button id="importJsonBtn" class="btn">Importer JSON</button>
    </div>

    <!-- VISITE -->
    <section id="tab-visit">
      <h1>Visite (Check A)</h1>

      <div class="card">
        <h2>Informations visite</h2>
        <div class="grid cols-3">
          <div>
            <label>Immatriculation</label>
            <input id="vImmat" list="immatList" placeholder="ex. F-HUVK">
            <datalist id="immatList"></datalist>
          </div>
          <div class="row" style="align-items:end">
            <div style="flex:1">
              <label>Ajouter une immat</label>
              <input id="vImmatAdd" placeholder="ex. F-HUVP">
            </div>
            <button id="btnAddImmat" class="btn">+ Ajouter</button>
          </div>
          <div>
            <label>Type de check</label>
            <select id="vCheck">
              <option>A1</option><option>A2</option><option>A3</option><option>A4</option>
              <option>A5</option><option>A6</option><option>A7</option><option>A8</option>
              <option>A9</option><option>A10</option><option>A11</option><option>A12</option>
            </select>
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:8px">
          <div>
            <label>Arriv√©e pr√©vue</label>
            <input id="vArrPrev" type="datetime-local">
          </div>
          <div>
            <label>Arriv√©e r√©elle</label>
            <input id="vArrReal" type="datetime-local">
          </div>
          <div>
            <label>D√©part pr√©vu</label>
            <input id="vDepPrev" type="datetime-local">
          </div>
          <div>
            <label>D√©part r√©el</label>
            <input id="vDepReal" type="datetime-local">
          </div>
        </div>

        <div class="grid cols-3" style="margin-top:8px">
          <div>
            <label>HMO pr√©vue (h)</label>
            <input id="vHmoPlan" type="number" min="0" step="0.5" value="0">
          </div>
          <div>
            <label>HMO r√©elle (h)</label>
            <input id="vHmoReal" type="number" min="0" step="0.5" value="0">
          </div>
          <div>
            <label>Œî HMO</label>
            <div id="vHmoDelta" class="small" style="padding:10px;border:1px solid var(--line);border-radius:10px">0.0 h</div>
          </div>
        </div>

        <div class="grid cols-3" style="margin-top:8px">
          <div>
            <label>Nb lignes d√©sassign√©es</label>
            <input id="vUnassigned" type="number" min="0" value="0">
          </div>
          <div>
            <label>Raison(s) d√©sassignation</label>
            <input id="vUnassignedReason" placeholder="ex. pi√®ce manquante, outillage‚Ä¶">
          </div>
          <div>
            <label>Nb lignes fin de chantier</label>
            <input id="vEndLines" type="number" min="0" value="0">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <input id="xmlFile" type="file" accept=".xml">
          <button id="btnImportXml" class="btn">Importer XML</button>
          <span class="small" style="margin-left:auto;opacity:.7">L‚ÄôXML peut pr√©remplir immat/dates/HMO si pr√©sent.</span>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <h2 style="margin:0">Effectifs par vacation</h2>
          <button id="btnAddVac" class="btn">+ Ajouter une vacation</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="vacTable">
            <thead>
              <tr>
                <th>Vacation</th>
                <th>CME dem.</th><th>EIR dem.</th><th>Leader dem.</th><th>Eff. dem. total</th>
                <th>CME r√©el</th><th>EIR r√©el</th><th>Leader r√©el</th><th>Eff. r√©el total</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="vacBody"></tbody>
            <tfoot>
              <tr>
                <th>Total g√©n√©ral</th>
                <th id="tCmeD">0</th><th id="tEirD">0</th><th id="tLeadD">0</th><th id="tDem">0</th>
                <th id="tCmeR">0</th><th id="tEirR">0</th><th id="tLeadR">0</th><th id="tReal">0</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="pill">Œî Effectif : <b id="deltaEff">0</b></div>
          <div class="pill">Œî HMO : <b id="deltaHmoBadge">0.0 h</b></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnSaveVisit" class="btn ok">üíæ Enregistrer</button>
          <button id="btnClearVisit" class="btn bad">üßπ Effacer le formulaire</button>
        </div>
      </div>
    </section>

    <!-- PROBL√àMES -->
    <section id="tab-problems" class="hidden">
      <h1>Probl√®mes (REX)</h1>
      <div class="card">
        <h2>Ajouter un probl√®me</h2>
        <div class="grid cols-3">
          <div>
            <label>Titre</label>
            <input id="pTitle">
          </div>
          <div>
            <label>Cat√©gorie</label>
            <select id="pCat">
              <option>Cabine</option><option>Sous-traitance</option>
              <option>Query/Pr√©pa</option><option>Pi√®ces/Log</option>
              <option>Effectifs/Planif</option><option>Documentation</option><option>Autre</option>
            </select>
          </div>
          <div>
            <label>Impact (h)</label>
            <input id="pImpact" type="number" min="0" step="0.5" value="0">
          </div>
          <div>
            <label>Acteur/Responsable</label>
            <input id="pActor" placeholder="ex. Cabine, STT, Query, Planif‚Ä¶">
          </div>
          <div>
            <label>R√©current</label>
            <input id="pRecurring" type="checkbox">
          </div>
          <div class="cols-3" style="grid-column:1/-1">
            <label>Description</label>
            <textarea id="pDesc" rows="3" placeholder="Contexte, sympt√¥mes, documents concern√©s‚Ä¶"></textarea>
          </div>
        </div>
        <button id="btnAddProblem" class="btn ok">+ Enregistrer le probl√®me</button>
      </div>

      <div class="card">
        <h2>Probl√®mes enregistr√©s</h2>
        <div class="row">
          <div><label>D√©but</label><input id="fStart" type="date"></div>
          <div><label>Fin</label><input id="fEnd" type="date"></div>
          <div><label>Immat</label><input id="fImmat" placeholder="Toutes"></div>
          <div>
            <label>Type</label>
            <select id="fCheck"><option value="">Tous</option><option>A1</option><option>A2</option><option>A3</option><option>A4</option><option>A5</option><option>A6</option><option>A7</option><option>A8</option><option>A9</option><option>A10</option><option>A11</option><option>A12</option></select>
          </div>
          <div>
            <label>Cat√©gorie</label>
            <select id="fCat"><option value="">Toutes</option><option>Cabine</option><option>Sous-traitance</option><option>Query/Pr√©pa</option><option>Pi√®ces/Log</option><option>Effectifs/Planif</option><option>Documentation</option><option>Autre</option></select>
          </div>
          <button id="btnFilterProblems" class="btn">Filtrer</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table>
            <thead><tr><th>#</th><th>Probl√®me</th><th>Cat.</th><th>Impact(h)</th><th>R√©c.</th><th>Immat</th><th>Check</th><th>Enregistr√©</th></tr></thead>
            <tbody id="problemsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PERFORMANCE -->
    <section id="tab-perf" class="hidden">
      <h1>Performance</h1>
      <div class="card">
        <div class="row">
          <div><label>D√©but</label><input id="pfStart" type="date"></div>
          <div><label>Fin</label><input id="pfEnd" type="date"></div>
          <div><label>Immat</label><input id="pfImmat" placeholder="Toutes"></div>
          <div>
            <label>Type</label>
            <select id="pfCheck"><option value="">Tous</option><option>A1</option><option>A2</option><option>A3</option><option>A4</option><option>A5</option><option>A6</option><option>A7</option><option>A8</option><option>A9</option><option>A10</option><option>A11</option><option>A12</option></select>
          </div>
          <button id="btnPerfRefresh" class="btn">Actualiser</button>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="pill">Respect planning (dep. r√©el ‚â§ pr√©vu) : <b id="kpiRespect">0%</b></div>
          <div class="pill">Œî HMO moyen : <b id="kpiHmo">0.0 h (0%)</b></div>
          <div class="pill">Œî effectif moyen : <b id="kpiEff">0%</b></div>
        </div>
      </div>

      <div class="grid cols-2">
        <div class="card">
          <h2>Pareto par cat√©gorie</h2>
          <table>
            <thead><tr><th>Cat√©gorie</th><th>Comptes</th><th>%</th><th>Cumul %</th></tr></thead>
            <tbody id="paretoBody"></tbody>
          </table>
        </div>
        <div class="card">
          <h2>R√©partition (camembert)</h2>
          <canvas id="pie" height="210"></canvas>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
/* ========================= stockage & base immats ========================= */
const LS_KEY="rexA350_checkA_v2";
const BASE_IMMATS=[
  "F-HTYA","F-HTYB","F-HTYC","F-HTYD","F-HTYE","F-HTYF","F-HTYG","F-HTYH",
  "F-HTYI","F-HTYJ","F-HTYK","F-HTYL","F-HTYM","F-HTYN","F-HTYO","F-HTYP",
  "F-HTYQ","F-HTYR","F-HTYS","F-HTYT","F-HUVA","F-HUVB","F-HUVC","F-HUVD",
  "F-HUVE","F-HUVF","F-HUVG","F-HUVH","F-HUVI","F-HUVJ","F-HUVK","F-HUVL",
  "F-HUVM","F-HUVN","F-HUVO","F-HUVP","F-HUVQ","F-HUVR","F-HUVS","F-HUVT",
  "F-HUVU"
];
function load(){ try{return JSON.parse(localStorage.getItem(LS_KEY))}catch{ return null } }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)) }
let state = load() || { immat:[...BASE_IMMATS], visits:[], problems:[] };
if(!Array.isArray(state.immat) || !state.immat.length) state.immat=[...BASE_IMMATS];
state.immat=Array.from(new Set([...state.immat,...BASE_IMMATS])).sort();

/* =============================== utilitaires ============================== */
const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
const num=v=>{const n=parseFloat(v);return isNaN(n)?0:n}
const fmtPct=(a,b)=> b? Math.round((a-b)*100/b):0;
const within=(d,a,b)=>{ if(!d) return false; const t=new Date(d).getTime(); const ta=a?new Date(a).getTime():-1e15; const tb=b?new Date(b).getTime()+86399999:1e15; return t>=ta&&t<=tb }

/* ================================ onglets ================================= */
$$('aside .menu button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('aside .menu button').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
    ['tab-visit','tab-problems','tab-perf'].forEach(id=>$('#'+id).classList.add('hidden'));
    $('#tab-'+btn.dataset.tab).classList.remove('hidden');
    if(btn.dataset.tab==='perf') renderPerf();
    if(btn.dataset.tab==='problems') renderProblems();
  })
})

/* ============================= immats (datalist) ========================== */
function refreshImmatList(){
  const dl=$('#immatList'); dl.innerHTML='';
  state.immat.forEach(i=>{ const o=document.createElement('option'); o.value=i; dl.appendChild(o) })
}
refreshImmatList();
$('#btnAddImmat').onclick=()=>{
  const v=$('#vImmatAdd').value.trim().toUpperCase(); if(!v) return;
  if(!state.immat.includes(v)) state.immat.push(v);
  $('#vImmat').value=v; $('#vImmatAdd').value=''; refreshImmatList(); save();
}

/* ============================ vacations (table) =========================== */
const vacBody=$('#vacBody');
function vacRow(name){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="vacName" value="${name}"></td>
    <td><input class="cmeD" type="number" min="0" value="0"></td>
    <td><input class="eirD" type="number" min="0" value="0"></td>
    <td><input class="leadD" type="number" min="0" value="0"></td>
    <td class="demTot">0</td>
    <td><input class="cmeR" type="number" min="0" value="0"></td>
    <td><input class="eirR" type="number" min="0" value="0"></td>
    <td><input class="leadR" type="number" min="0" value="0"></td>
    <td class="realTot">0</td>
    <td><button class="btn bad delVac">Retirer</button></td>`;
  vacBody.appendChild(tr);
}
function seedVacs(){ vacBody.innerHTML=''; ['Matin','Soir','Nuit'].forEach(vacRow); recalcTotals(); }
seedVacs();

vacBody.addEventListener('input', e=>{ if(e.target.tagName==='INPUT') recalcTotals() });
vacBody.addEventListener('click', e=>{ if(e.target.classList.contains('delVac')){ e.target.closest('tr').remove(); recalcTotals(); }});
$('#btnAddVac').onclick=()=>vacRow('Vac.');

/* ========================== calculs (totaux & KPI) ======================== */
function recalcTotals(){
  let tCmeD=0,tEirD=0,tLeadD=0,tDem=0,tCmeR=0,tEirR=0,tLeadR=0,tReal=0;
  $$('#vacBody tr').forEach(tr=>{
    const cmeD=num($('.cmeD',tr).value), eirD=num($('.eirD',tr).value), leadD=num($('.leadD',tr).value);
    const cmeR=num($('.cmeR',tr).value), eirR=num($('.eirR',tr).value), leadR=num($('.leadR',tr).value);
    const demTot=cmeD+eirD+leadD, realTot=cmeR+eirR+leadR;
    $('.demTot',tr).textContent=demTot; $('.realTot',tr).textContent=realTot;
    tCmeD+=cmeD; tEirD+=eirD; tLeadD+=leadD; tDem+=demTot;
    tCmeR+=cmeR; tEirR+=eirR; tLeadR+=leadR; tReal+=realTot;
  });
  $('#tCmeD').textContent=tCmeD; $('#tEirD').textContent=tEirD; $('#tLeadD').textContent=tLeadD; $('#tDem').textContent=tDem;
  $('#tCmeR').textContent=tCmeR; $('#tEirR').textContent=tEirR; $('#tLeadR').textContent=tLeadR; $('#tReal').textContent=tReal;

  const dEff=tReal - tDem;
  $('#deltaEff').textContent=dEff;

  const dHmo = num($('#vHmoReal').value) - num($('#vHmoPlan').value);
  $('#vHmoDelta').textContent = dHmo.toFixed(1)+' h';
  $('#deltaHmoBadge').textContent = dHmo.toFixed(1)+' h';
}

/* =========================== HMO inputs (manuel) ========================== */
;['vHmoPlan','vHmoReal'].forEach(id=>{
  $('#'+id).addEventListener('input', recalcTotals);
});

/* =============================== Import XML =============================== */
$('#btnImportXml').onclick=()=>{
  const f=$('#xmlFile').files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const xml=new DOMParser().parseFromString(r.result,'text/xml');
      // immat (regex F-Hxxx ou balise)
      const tx=r.result;
      const m = tx.match(/F-?H[A-Z0-9]{3}/i);
      if(m) $('#vImmat').value = m[0].toUpperCase().replace(/^F(H)/,'F-$1');
      // dates (premier ISO trouv√©)
      const dt = tx.match(/\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}/);
      if(dt){ $('#vArrReal').value = dt[0].replace(' ','T'); }
      // HMO explicites
      const getNumNode = sel => {
        const n=xml.querySelector(sel); if(!n) return NaN;
        const v=parseFloat(n.textContent||n.getAttribute('value')); return isNaN(v)?NaN:v;
      }
      let hPlan = getNumNode('HMOPlan, HmoPlan, PlanHMO');
      let hReal = getNumNode('HMOReal, HmoReal, RealHMO');
      if(isNaN(hPlan) || isNaN(hReal)){
        // fallback: somme durations
        let sum=0;
        xml.querySelectorAll('[duration]').forEach(n=>{
          const v=parseFloat(n.getAttribute('duration')); if(!isNaN(v)) sum+=v;
        });
        if(isNaN(hPlan)) hPlan=sum||0;
        if(isNaN(hReal)) hReal=sum||0;
      }
      $('#vHmoPlan').value = isNaN(hPlan)? 0 : hPlan;
      $('#vHmoReal').value = isNaN(hReal)? 0 : hReal;
      recalcTotals();
      alert('XML import√© ‚úÖ');
    }catch(e){ alert('XML invalide'); }
  };
  r.readAsText(f);
};

/* ============================== Enregistrer =============================== */
$('#btnSaveVisit').onclick=()=>{
  const vacs=$$('#vacBody tr').map(tr=>({
    name:$(".vacName",tr).value.trim(),
    cmeDem:num($('.cmeD',tr).value), eirDem:num($('.eirD',tr).value), leadDem:num($('.leadD',tr).value),
    cmeReal:num($('.cmeR',tr).value), eirReal:num($('.eirR',tr).value), leadReal:num($('.leadR',tr).value)
  }));
  const v={
    immat: $('#vImmat').value.trim().toUpperCase(),
    check: $('#vCheck').value,
    arrPrev: $('#vArrPrev').value || null,
    arrReal: $('#vArrReal').value || null,
    depPrev: $('#vDepPrev').value || null,
    depReal: $('#vDepReal').value || null,
    hmoPlan: num($('#vHmoPlan').value),
    hmoReal: num($('#vHmoReal').value),
    unassigned: num($('#vUnassigned').value),
    unassignedReason: $('#vUnassignedReason').value.trim(),
    endLines: num($('#vEndLines').value),
    vacs, createdAt: new Date().toISOString()
  };
  if(v.immat && !state.immat.includes(v.immat)){ state.immat.push(v.immat); refreshImmatList(); }
  state.visits.push(v); save();
  alert('Visite enregistr√©e ‚úÖ');
}

/* ============================== Effacer form ============================== */
$('#btnClearVisit').onclick=()=>{
  if(!confirm('Effacer le formulaire ?')) return;
  ['vImmat','vImmatAdd','vArrPrev','vArrReal','vDepPrev','vDepReal','vHmoPlan','vHmoReal','vUnassigned','vUnassignedReason','vEndLines']
    .forEach(id=> $('#'+id).value = (id==='vUnassigned'||id==='vEndLines')?0:'');
  vacBody.innerHTML=''; seedVacs(); recalcTotals();
}

/* ============================ Export / Import JSON ======================== */
$('#exportJson').onclick=()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rex-a350.json'; a.click();
}
$('#importJsonBtn').onclick=()=>$('#importJsonFile').click();
$('#importJsonFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const d=JSON.parse(r.result);
      if(d && d.visits && d.problems){
        state=d; // remplace tout
        // retouche immats (fusion/tri)
        state.immat=Array.from(new Set([...(state.immat||[]), ...BASE_IMMATS])).sort();
        save(); refreshImmatList(); renderProblems(); renderPerf();
        alert('Import OK ‚úÖ');
      } else alert('JSON invalide');
    }catch{ alert('Erreur JSON'); }
  };
  r.readAsText(f);
});

/* ================================ Probl√®mes =============================== */
$('#btnAddProblem').onclick=()=>{
  const title=$('#pTitle').value.trim(); if(!title) return alert('Titre manquant');
  const last=state.visits[state.visits.length-1]||{};
  const p={
    title, cat:$('#pCat').value, impact:num($('#pImpact').value), actor:$('#pActor').value.trim(),
    recurring:$('#pRecurring').checked, desc:$('#pDesc').value.trim(),
    immat:last.immat||'', check:last.check||'', ts:new Date().toISOString()
  };
  state.problems.push(p); save();
  $('#pTitle').value=''; $('#pImpact').value=0; $('#pActor').value=''; $('#pRecurring').checked=false; $('#pDesc').value='';
  renderProblems();
}
function renderProblems(){
  const tbody=$('#problemsBody'); tbody.innerHTML='';
  const s=$('#fStart').value, e=$('#fEnd').value, im=($('#fImmat').value||'').toUpperCase(), ck=$('#fCheck').value, cat=$('#fCat').value;
  state.problems.filter(p=>{
    return within(p.ts,s||null,e||null) && (im? p.immat===im:true) && (ck? p.check===ck:true) && (cat? p.cat===cat:true)
  }).forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${p.title}</td><td>${p.cat}</td><td>${p.impact||0}</td><td>${p.recurring?'Oui':'Non'}</td><td>${p.immat||'‚Äî'}</td><td>${p.check||'‚Äî'}</td><td>${new Date(p.ts).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  });
}
$('#btnFilterProblems').onclick=renderProblems;

/* ================================ Performance ============================= */
let pie=null;
function renderPerf(){
  const s=$('#pfStart').value, e=$('#pfEnd').value, im=($('#pfImmat').value||'').toUpperCase(), ck=$('#pfCheck').value;
  const visits=state.visits.filter(v=> within(v.createdAt||v.arrPrev||v.arrReal||v.depPrev||v.depReal, s||null, e||null) && (im? v.immat===im:true) && (ck? v.check===ck:true));

  // KPIs
  let res=0,tot=0, sumDH=0,sumHD=0,sumHR=0, sumPctEff=0, cntPct=0;
  visits.forEach(v=>{
    if(v.depPrev && v.depReal){ tot++; if(new Date(v.depReal)<=new Date(v.depPrev)) res++; }
    const dH = (v.hmoReal||0) - (v.hmoPlan||0);
    sumDH += dH; sumHD += (v.hmoPlan||0); sumHR += (v.hmoReal||0);
    const dem = v.vacs.reduce((a,x)=>a+x.cmeDem+x.eirDem+x.leadDem,0);
    const rea = v.vacs.reduce((a,x)=>a+x.cmeReal+x.eirReal+x.leadReal,0);
    if(dem>0){ sumPctEff += ((rea-dem)/dem)*100; cntPct++; }
  });
  $('#kpiRespect').textContent = (tot? Math.round(res*100/tot):0)+'%';
  const avgDH = visits.length? (sumDH/visits.length):0;
  const pctDH = sumHD? Math.round(sumDH*100/sumHD):0;
  $('#kpiHmo').textContent = `${avgDH.toFixed(1)} h (${pctDH}%)`;
  $('#kpiEff').textContent = `${cntPct? Math.round(sumPctEff/cntPct):0}%`;

  // Pareto / pie depuis problems filtr√©s
  const probs=state.problems.filter(p=> within(p.ts,s||null,e||null) && (im? p.immat===im:true) && (ck? p.check===ck:true));
  const byCat={}; probs.forEach(p=> byCat[p.cat]=(byCat[p.cat]||0)+1 );
  const arr=Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  const total=arr.reduce((a,[,c])=>a+c,0)||1;
  const pb=$('#paretoBody'); pb.innerHTML='';
  let cumul=0;
  arr.forEach(([cat,c])=>{
    const pc=Math.round(c*100/total); cumul+=pc;
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${cat}</td><td>${c}</td><td>${pc}%</td><td>${Math.min(cumul,100)}%</td>`;
    pb.appendChild(tr);
  });
  const ctx=$('#pie').getContext('2d'); if(pie) pie.destroy();
  pie=new Chart(ctx,{ type:'doughnut', data:{ labels:arr.map(x=>x[0]), datasets:[{ data:arr.map(x=>x[1]) }]}, options:{plugins:{legend:{position:'bottom'}},maintainAspectRatio:false} });
}
$('#btnPerfRefresh').onclick=renderPerf;

/* ================================ init UI ================================= */
refreshImmatList(); renderProblems();
</script>
</body>
</html>
