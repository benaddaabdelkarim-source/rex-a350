<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>REX Planning A350 ‚Äì Check A</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0f172a;--panel:#111827;--muted:#1f2937;--text:#e5e7eb;--sub:#cbd5e1;
  --accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--line:#1e293b
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu}
header{display:flex;gap:12px;align-items:center;padding:14px 18px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(15,23,42,.9);backdrop-filter:saturate(140%) blur(8px);z-index:2}
h1{font-size:16px;margin:0;font-weight:700}
.small{font-size:12px;color:var(--sub)}
.tag{padding:2px 8px;border-radius:999px;background:var(--muted);color:#dbeafe;font-size:12px}
.right{margin-left:auto}
.wrap{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 56px)}
nav{border-right:1px solid var(--line);background:#0b1222;padding:10px}
nav .btn{display:block;width:100%;text-align:left;margin:6px 0;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0f1a30;color:#dbeafe;cursor:pointer}
nav .btn.active{outline:2px solid var(--accent)}
main{padding:14px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,textarea{width:100%;background:#0b1222;border:1px solid #223050;color:var(--text);border-radius:10px;padding:10px}
textarea{min-height:76px}
label{font-size:12px;color:#93b3d9}
.btn2{border:1px solid #223050;background:#0b1222;border-radius:10px;padding:8px 10px;color:var(--text);cursor:pointer}
.btn2.primary{background:#11345a;border-color:#1d4ed8}
.btn2.good{background:#0d2d1b;border-color:#16a34a}
.btn2.bad{background:#3a0a0a;border-color:#ef4444}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
.table th{color:#9fb5d6}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0c1528;border:1px solid #273146;border-radius:6px;padding:1px 6px}
.badge{display:inline-block;border-radius:999px;padding:4px 8px;font-size:12px;line-height:1;border:1px solid #223050;background:#0b1222}
.badge.ok{border-color:#14532d;background:#052e16;color:#86efac}
.badge.warn{border-color:#78350f;background:#3a2a0a;color:#fed7aa}
.badge.bad{border-color:#7f1d1d;background:#3a0a0a;color:#fecaca}
.muted{color:#93b3d9}
.center{text-align:center}
.hr{height:1px;background:var(--line);margin:8px 0}
</style>
</head>
<body>
<header>
  <h1>REX Planning A350 ‚Äì Check A</h1>
  <span class="tag">Local (JSON / localStorage)</span>
  <span class="right"></span>
  <button class="btn2" id="exportBtn">Exporter JSON</button>
  <label class="btn2" for="importFile">Importer JSON</label>
  <input id="importFile" type="file" accept="application/json" style="display:none"/>
</header>

<div class="wrap">
  <nav>
    <button class="btn active" data-tab="problems">üìö Biblioth√®que Probl√®mes</button>
    <button class="btn" data-tab="visit">üßæ Checklist Visite</button>
    <button class="btn" data-tab="analytics">üìä Analytics / REX</button>
    <button class="btn" data-tab="settings">‚öôÔ∏è Param√®tres flotte</button>
  </nav>

  <main>
    <section id="tab-problems" class="tab">
      <div class="panel"><h3>Biblioth√®que de probl√®mes</h3>
        <button class="btn2 primary" id="addProblemBtn">+ Nouveau probl√®me</button>
        <div id="problemsList"></div>
      </div>
    </section>

    <section id="tab-visit" class="tab" hidden>
      <div class="panel"><h3>Checklist Visite</h3>
        <button class="btn2 primary" id="newVisitBtn">+ Nouvelle visite</button>
        <select id="visitSelect"></select>
      </div>

      <div class="panel">
        <h3>Effectifs par vacation</h3>
        <table class="table" id="staffTable">
          <thead>
            <tr><th>Vacation</th><th colspan="4" class="center">Demand√©</th><th colspan="4" class="center">R√©el</th></tr>
            <tr class="small"><th></th><th>Total</th><th>CME</th><th>EIR</th><th>Leader</th><th>Total</th><th>CME</th><th>EIR</th><th>Leader</th></tr>
          </thead>
          <tbody id="staffBody"></tbody>
          <tfoot>
            <tr class="small"><th>Total g√©n√©ral</th>
              <th id="tot_dem_total"></th><th id="tot_dem_cme"></th><th id="tot_dem_eir"></th><th id="tot_dem_lead"></th>
              <th id="tot_real_total"></th><th id="tot_real_cme"></th><th id="tot_real_eir"></th><th id="tot_real_lead"></th>
            </tr>
          </tfoot>
        </table>
        <div class="small muted">Les totaux se calculent automatiquement.</div>
        <div class="small muted" id="deltaInfo"></div>
      </div>
    </section>

    <section id="tab-analytics" class="tab" hidden>
      <div class="panel"><h3>Analytics & REX</h3>
        <canvas id="paretoChart" height="200"></canvas>
      </div>
    </section>

    <section id="tab-settings" class="tab" hidden>
      <div class="panel"><h3>Param√®tres flotte A350</h3>
        <textarea id="fleetTextarea" rows="10" placeholder="F-HTYA&#10;F-HTYB&#10;F-HTYC"></textarea>
        <div class="row"><button class="btn2 primary" id="saveFleetBtn">Enregistrer</button></div>
      </div>
    </section>
  </main>
</div>

<script>
const $=id=>document.getElementById(id);
const data=JSON.parse(localStorage.getItem('rex-data')||'{}');if(!data.visits)data.visits=[];if(!data.fleet)data.fleet=[];
function save(){localStorage.setItem('rex-data',JSON.stringify(data))}

/* navigation */
document.querySelectorAll('nav .btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('nav .btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('main .tab').forEach(tab=>tab.hidden=true);
    $('tab-'+btn.dataset.tab).hidden=false;
    if(btn.dataset.tab==='visit') renderStaff();
  });
});

/* VISITES */
const VAC=['Matin','Soir','Nuit'];
if(!data.staff)data.staff={};
function renderStaff(){
  const body=$('staffBody');body.innerHTML='';
  VAC.forEach(vac=>{
    if(!data.staff[vac])data.staff[vac]={cme_d:0,eir_d:0,lead_d:0,cme_r:0,eir_r:0,lead_r:0};
    const s=data.staff[vac];
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${vac}</td>
      <td class="dem_total"></td>
      <td><input type="number" min="0" step="1" data-v="${vac}" data-k="cme_d" value="${s.cme_d}"/></td>
      <td><input type="number" min="0" step="1" data-v="${vac}" data-k="eir_d" value="${s.eir_d}"/></td>
      <td><input type="number" min="0" step="1" data-v="${vac}" data-k="lead_d" value="${s.lead_d}"/></td>
      <td class="real_total"></td>
      <td><input type="number" min="0" step="1" data-v="${vac}" data-k="cme_r" value="${s.cme_r}"/></td>
      <td><input type="number" min="0" step="1" data-v="${vac}" data-k="eir_r" value="${s.eir_r}"/></td>
      <td><input type="number" min="0" step="1" data-v="${vac}" data-k="lead_r" value="${s.lead_r}"/></td>`;
    body.appendChild(tr);
  });
  document.querySelectorAll('#staffBody input').forEach(inp=>inp.addEventListener('input',updateStaff));
  recalcTotals();
}
function updateStaff(e){
  const vac=e.target.dataset.v,k=e.target.dataset.k;
  data.staff[vac][k]=parseInt(e.target.value)||0;
  save();recalcTotals();
}
function recalcTotals(){
  let tdCME=0,tdEIR=0,tdL=0,trCME=0,trEIR=0,trL=0;
  VAC.forEach(v=>{
    const s=data.staff[v];
    const dem=(s.cme_d+s.eir_d+s.lead_d);
    const real=(s.cme_r+s.eir_r+s.lead_r);
    const row=[...document.querySelectorAll(`#staffBody tr`)][VAC.indexOf(v)];
    row.querySelector('.dem_total').textContent=dem;
    row.querySelector('.real_total').textContent=real;
    tdCME+=s.cme_d;tdEIR+=s.eir_d;tdL+=s.lead_d;
    trCME+=s.cme_r;trEIR+=s.eir_r;trL+=s.lead_r;
  });
  const totDem=tdCME+tdEIR+tdL,totReal=trCME+trEIR+trL;
  $('tot_dem_total').textContent=totDem;$('tot_dem_cme').textContent=tdCME;$('tot_dem_eir').textContent=tdEIR;$('tot_dem_lead').textContent=tdL;
  $('tot_real_total').textContent=totReal;$('tot_real_cme').textContent=trCME;$('tot_real_eir').textContent=trEIR;$('tot_real_lead').textContent=trL;
  $('deltaInfo').textContent=`Œî Effectif total : ${totReal-totDem>=0?'+':''}${totReal-totDem}`;
}

/* EXPORT / IMPORT */
$('exportBtn').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='rex-a350.json';a.click();
});
$('importFile').addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=()=>{try{Object.assign(data,JSON.parse(r.result));save();renderStaff();alert('Import r√©ussi');}catch(err){alert('Erreur JSON');}};
  r.readAsText(f);
});

/* PARAM√àTRES FLOTTES */
$('saveFleetBtn').addEventListener('click',()=>{
  data.fleet=$('fleetTextarea').value.split(/\n+/).map(x=>x.trim()).filter(Boolean);
  save();alert('Flotte mise √† jour : '+data.fleet.length+' avions');
});

/* INIT */
renderStaff();
</script>
</body>
</html>
